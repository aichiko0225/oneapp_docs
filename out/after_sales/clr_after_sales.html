<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>CLR After Sales &#x552e;&#x540e;&#x670d;&#x52a1;SDK</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="clr-after-sales-售后服务sdk">CLR After Sales 售后服务SDK</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>clr_after_sales</code> 是 OneApp 售后服务模块群中的核心服务SDK，负责封装售后服务的业务逻辑、API接口调用和数据模型定义。该模块为售后服务应用层提供统一的服务接口和数据处理能力。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: clr_after_sales</li>
<li><strong>版本</strong>: 0.0.1</li>
<li><strong>描述</strong>: 售后服务核心SDK</li>
<li><strong>Flutter 版本</strong>: &gt;=1.17.0</li>
<li><strong>Dart 版本</strong>: &gt;=3.0.0 &lt;4.0.0</li>
</ul>
<h2 id="功能特性">功能特性</h2>
<h3 id="核心功能">核心功能</h3>
<ol>
<li>
<p><strong>API接口封装</strong></p>
<ul>
<li>售后服务API统一封装</li>
<li>网络请求统一处理</li>
<li>错误处理和重试机制</li>
<li>数据缓存和同步</li>
</ul>
</li>
<li>
<p><strong>业务逻辑封装</strong></p>
<ul>
<li>预约业务逻辑</li>
<li>服务流程管理</li>
<li>支付结算逻辑</li>
<li>数据验证规则</li>
</ul>
</li>
<li>
<p><strong>数据模型管理</strong></p>
<ul>
<li>统一数据模型定义</li>
<li>JSON序列化支持</li>
<li>数据转换和映射</li>
<li>模型验证机制</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li>业务状态统一管理</li>
<li>事件驱动更新</li>
<li>状态持久化</li>
<li>状态同步机制</li>
</ul>
</li>
</ol>
<h2 id="技术架构">技术架构</h2>
<h3 id="目录结构">目录结构</h3>
<pre><code>lib/
├── clr_after_sales.dart       # 模块入口文件
├── src/                       # 源代码目录
│   ├── services/              # 业务服务
│   ├── repositories/          # 数据仓库
│   ├── models/                # 数据模型
│   ├── enums/                 # 枚举定义
│   ├── exceptions/            # 异常定义
│   ├── utils/                 # 工具类
│   └── constants/             # 常量定义
├── test/                      # 测试文件
└── generated/                 # 代码生成文件
</code></pre>
<h3 id="依赖关系">依赖关系</h3>
<h4 id="基础框架依赖">基础框架依赖</h4>
<ul>
<li><code>basic_network: ^0.2.3+4</code> - 网络通信框架</li>
<li><code>common_utils: ^2.1.0</code> - 通用工具库</li>
</ul>
<h4 id="内部依赖-dependency_overrides">内部依赖 (dependency_overrides)</h4>
<ul>
<li><code>ui_basic</code> - 基础UI组件（本地路径）</li>
<li><code>basic_platform</code> - 平台适配（本地路径）</li>
<li><code>basic_utils</code> - 基础工具（本地路径）</li>
<li><code>basic_uis</code> - 基础UI集合（本地路径）</li>
<li><code>base_mvvm</code> - MVVM架构（本地路径）</li>
</ul>
<h2 id="核心模块分析">核心模块分析</h2>
<h3 id="1-业务服务-srcservices">1. 业务服务 (<code>src/services/</code>)</h3>
<h4 id="预约服务">预约服务</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppointmentService</span> </span>{
  <span class="hljs-keyword">final</span> AppointmentRepository _repository;
  <span class="hljs-keyword">final</span> NetworkService _networkService;
  
  AppointmentService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._networkService);
  
  <span class="hljs-comment">/// <span class="language-markdown">创建预约</span></span>
  Future&lt;Result&lt;Appointment&gt;&gt; createAppointment(
    AppointmentCreateRequest request,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 验证请求数据</span>
      <span class="hljs-keyword">final</span> validationResult = _validateCreateRequest(request);
      <span class="hljs-keyword">if</span> (validationResult.isFailure) {
        <span class="hljs-keyword">return</span> Result.failure(validationResult.error);
      }
      
      <span class="hljs-comment">// 2. 检查时间可用性</span>
      <span class="hljs-keyword">final</span> availability = <span class="hljs-keyword">await</span> checkTimeAvailability(
        request.storeId,
        request.appointmentTime,
      );
      
      <span class="hljs-keyword">if</span> (!availability.isAvailable) {
        <span class="hljs-keyword">return</span> Result.failure(
          AppointmentException(<span class="hljs-string">&#x27;预约时间不可用&#x27;</span>),
        );
      }
      
      <span class="hljs-comment">// 3. 调用API创建预约</span>
      <span class="hljs-keyword">final</span> apiResponse = <span class="hljs-keyword">await</span> _networkService.post(
        <span class="hljs-string">&#x27;/appointments&#x27;</span>,
        data: request.toJson(),
      );
      
      <span class="hljs-comment">// 4. 解析响应数据</span>
      <span class="hljs-keyword">final</span> appointment = Appointment.fromJson(apiResponse.data);
      
      <span class="hljs-comment">// 5. 缓存到本地</span>
      <span class="hljs-keyword">await</span> _repository.saveAppointment(appointment);
      
      <span class="hljs-keyword">return</span> Result.success(appointment);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(AppointmentException(e.toString()));
    }
  }
  
  <span class="hljs-comment">/// <span class="language-markdown">获取用户预约列表</span></span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;Appointment&gt;&gt;&gt; getUserAppointments({
    <span class="hljs-built_in">String?</span> status,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 先从缓存获取</span>
      <span class="hljs-keyword">final</span> cachedAppointments = <span class="hljs-keyword">await</span> _repository.getCachedAppointments(
        status: status,
        page: page,
        pageSize: pageSize,
      );
      
      <span class="hljs-comment">// 2. 如果缓存存在且未过期，直接返回</span>
      <span class="hljs-keyword">if</span> (cachedAppointments.isNotEmpty &amp;&amp; !_isCacheExpired()) {
        <span class="hljs-keyword">return</span> Result.success(cachedAppointments);
      }
      
      <span class="hljs-comment">// 3. 从网络获取最新数据</span>
      <span class="hljs-keyword">final</span> apiResponse = <span class="hljs-keyword">await</span> _networkService.<span class="hljs-keyword">get</span>(
        <span class="hljs-string">&#x27;/appointments&#x27;</span>,
        queryParameters: {
          <span class="hljs-string">&#x27;status&#x27;</span>: status,
          <span class="hljs-string">&#x27;page&#x27;</span>: page,
          <span class="hljs-string">&#x27;pageSize&#x27;</span>: pageSize,
        },
      );
      
      <span class="hljs-comment">// 4. 解析并缓存数据</span>
      <span class="hljs-keyword">final</span> appointments = (apiResponse.data[<span class="hljs-string">&#x27;items&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">List</span>)
          .map((json) =&gt; Appointment.fromJson(json))
          .toList();
      
      <span class="hljs-keyword">await</span> _repository.cacheAppointments(appointments);
      
      <span class="hljs-keyword">return</span> Result.success(appointments);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(AppointmentException(e.toString()));
    }
  }
  
  <span class="hljs-comment">/// <span class="language-markdown">取消预约</span></span>
  Future&lt;Result&lt;<span class="hljs-built_in">bool</span>&gt;&gt; cancelAppointment(<span class="hljs-built_in">String</span> appointmentId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _networkService.put(
        <span class="hljs-string">&#x27;/appointments/<span class="hljs-subst">$appointmentId</span>/cancel&#x27;</span>,
      );
      
      <span class="hljs-comment">// 更新本地缓存</span>
      <span class="hljs-keyword">await</span> _repository.updateAppointmentStatus(
        appointmentId,
        AppointmentStatus.cancelled,
      );
      
      <span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">true</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(AppointmentException(e.toString()));
    }
  }
}
</code></pre>
<h4 id="服务进度服务">服务进度服务</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceProgressService</span> </span>{
  <span class="hljs-keyword">final</span> ServiceProgressRepository _repository;
  <span class="hljs-keyword">final</span> NetworkService _networkService;
  
  ServiceProgressService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._networkService);
  
  <span class="hljs-comment">/// <span class="language-markdown">获取服务进度</span></span>
  Future&lt;Result&lt;ServiceProgress&gt;&gt; getServiceProgress(
    <span class="hljs-built_in">String</span> appointmentId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> apiResponse = <span class="hljs-keyword">await</span> _networkService.<span class="hljs-keyword">get</span>(
        <span class="hljs-string">&#x27;/appointments/<span class="hljs-subst">$appointmentId</span>/progress&#x27;</span>,
      );
      
      <span class="hljs-keyword">final</span> progress = ServiceProgress.fromJson(apiResponse.data);
      
      <span class="hljs-comment">// 缓存进度数据</span>
      <span class="hljs-keyword">await</span> _repository.saveProgress(progress);
      
      <span class="hljs-keyword">return</span> Result.success(progress);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(ServiceException(e.toString()));
    }
  }
  
  <span class="hljs-comment">/// <span class="language-markdown">更新服务步骤</span></span>
  Future&lt;Result&lt;ServiceStep&gt;&gt; updateServiceStep(
    <span class="hljs-built_in">String</span> appointmentId,
    <span class="hljs-built_in">String</span> stepId,
    ServiceStepUpdate update,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> apiResponse = <span class="hljs-keyword">await</span> _networkService.put(
        <span class="hljs-string">&#x27;/appointments/<span class="hljs-subst">$appointmentId</span>/steps/<span class="hljs-subst">$stepId</span>&#x27;</span>,
        data: update.toJson(),
      );
      
      <span class="hljs-keyword">final</span> updatedStep = ServiceStep.fromJson(apiResponse.data);
      
      <span class="hljs-comment">// 更新本地缓存</span>
      <span class="hljs-keyword">await</span> _repository.updateStep(appointmentId, updatedStep);
      
      <span class="hljs-keyword">return</span> Result.success(updatedStep);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(ServiceException(e.toString()));
    }
  }
  
  <span class="hljs-comment">/// <span class="language-markdown">上传服务照片</span></span>
  Future&lt;Result&lt;ServicePhoto&gt;&gt; uploadServicePhoto(
    <span class="hljs-built_in">String</span> appointmentId,
    <span class="hljs-built_in">String</span> stepId,
    File photoFile,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> formData = FormData.fromMap({
        <span class="hljs-string">&#x27;file&#x27;</span>: <span class="hljs-keyword">await</span> MultipartFile.fromFile(photoFile.path),
        <span class="hljs-string">&#x27;appointmentId&#x27;</span>: appointmentId,
        <span class="hljs-string">&#x27;stepId&#x27;</span>: stepId,
      });
      
      <span class="hljs-keyword">final</span> apiResponse = <span class="hljs-keyword">await</span> _networkService.post(
        <span class="hljs-string">&#x27;/service-photos/upload&#x27;</span>,
        data: formData,
      );
      
      <span class="hljs-keyword">final</span> photo = ServicePhoto.fromJson(apiResponse.data);
      
      <span class="hljs-keyword">return</span> Result.success(photo);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Result.failure(ServiceException(e.toString()));
    }
  }
}
</code></pre>
<h3 id="2-数据仓库-srcrepositories">2. 数据仓库 (<code>src/repositories/</code>)</h3>
<h4 id="预约数据仓库">预约数据仓库</h4>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppointmentRepository</span> </span>{
  Future&lt;<span class="hljs-keyword">void</span>&gt; saveAppointment(Appointment appointment);
  Future&lt;<span class="hljs-built_in">List</span>&lt;Appointment&gt;&gt; getCachedAppointments({
    <span class="hljs-built_in">String?</span> status,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  });
  Future&lt;<span class="hljs-keyword">void</span>&gt; cacheAppointments(<span class="hljs-built_in">List</span>&lt;Appointment&gt; appointments);
  Future&lt;<span class="hljs-keyword">void</span>&gt; updateAppointmentStatus(<span class="hljs-built_in">String</span> id, AppointmentStatus status);
  Future&lt;<span class="hljs-keyword">void</span>&gt; clearCache();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppointmentRepositoryImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AppointmentRepository</span> </span>{
  <span class="hljs-keyword">final</span> LocalStorage _localStorage;
  <span class="hljs-keyword">final</span> DatabaseHelper _databaseHelper;
  
  AppointmentRepositoryImpl(<span class="hljs-keyword">this</span>._localStorage, <span class="hljs-keyword">this</span>._databaseHelper);
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; saveAppointment(Appointment appointment) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 保存到数据库</span>
      <span class="hljs-keyword">await</span> _databaseHelper.insertAppointment(appointment);
      
      <span class="hljs-comment">// 更新缓存</span>
      <span class="hljs-keyword">final</span> cacheKey = <span class="hljs-string">&#x27;appointment_<span class="hljs-subst">${appointment.id}</span>&#x27;</span>;
      <span class="hljs-keyword">await</span> _localStorage.setString(cacheKey, jsonEncode(appointment.toJson()));
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> RepositoryException(<span class="hljs-string">&#x27;保存预约失败: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;Appointment&gt;&gt; getCachedAppointments({
    <span class="hljs-built_in">String?</span> status,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _databaseHelper.getAppointments(
        status: status,
        offset: (page - <span class="hljs-number">1</span>) * pageSize,
        limit: pageSize,
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> RepositoryException(<span class="hljs-string">&#x27;获取缓存预约失败: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; updateAppointmentStatus(<span class="hljs-built_in">String</span> id, AppointmentStatus status) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _databaseHelper.updateAppointmentStatus(id, status);
      
      <span class="hljs-comment">// 更新内存缓存</span>
      <span class="hljs-keyword">final</span> cacheKey = <span class="hljs-string">&#x27;appointment_<span class="hljs-subst">$id</span>&#x27;</span>;
      <span class="hljs-keyword">final</span> cachedData = <span class="hljs-keyword">await</span> _localStorage.getString(cacheKey);
      <span class="hljs-keyword">if</span> (cachedData != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">final</span> appointment = Appointment.fromJson(jsonDecode(cachedData));
        <span class="hljs-keyword">final</span> updatedAppointment = appointment.copyWith(status: status);
        <span class="hljs-keyword">await</span> _localStorage.setString(
          cacheKey,
          jsonEncode(updatedAppointment.toJson()),
        );
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> RepositoryException(<span class="hljs-string">&#x27;更新预约状态失败: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
}
</code></pre>
<h3 id="3-数据模型-srcmodels">3. 数据模型 (<code>src/models/</code>)</h3>
<h4 id="预约模型">预约模型</h4>
<pre><code class="language-dart"><span class="hljs-meta">@freezed</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Appointment</span> <span class="hljs-title">with</span> <span class="hljs-title">_</span>$<span class="hljs-title">Appointment</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> Appointment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> id,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> storeId,
    <span class="hljs-keyword">required</span> ServiceType serviceType,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> appointmentTime,
    <span class="hljs-keyword">required</span> AppointmentStatus status,
    <span class="hljs-keyword">required</span> VehicleInfo vehicleInfo,
    <span class="hljs-built_in">String?</span> description,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? attachments,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;created_at&#x27;</span>) <span class="hljs-built_in">DateTime?</span> createdAt,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;updated_at&#x27;</span>) <span class="hljs-built_in">DateTime?</span> updatedAt,
    Store? store,
    <span class="hljs-built_in">List</span>&lt;ServiceItem&gt;? serviceItems,
    PaymentInfo? paymentInfo,
  }) = _Appointment;

  <span class="hljs-keyword">factory</span> Appointment.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt;
      _$AppointmentFromJson(json);
}

<span class="hljs-meta">@freezed</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppointmentCreateRequest</span> <span class="hljs-title">with</span> <span class="hljs-title">_</span>$<span class="hljs-title">AppointmentCreateRequest</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> AppointmentCreateRequest({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> storeId,
    <span class="hljs-keyword">required</span> ServiceType serviceType,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> appointmentTime,
    <span class="hljs-keyword">required</span> VehicleInfo vehicleInfo,
    <span class="hljs-built_in">String?</span> description,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? attachments,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? serviceItemIds,
  }) = _AppointmentCreateRequest;

  <span class="hljs-keyword">factory</span> AppointmentCreateRequest.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt;
      _$AppointmentCreateRequestFromJson(json);
}
</code></pre>
<h4 id="服务进度模型">服务进度模型</h4>
<pre><code class="language-dart"><span class="hljs-meta">@freezed</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceProgress</span> <span class="hljs-title">with</span> <span class="hljs-title">_</span>$<span class="hljs-title">ServiceProgress</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> ServiceProgress({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> appointmentId,
    <span class="hljs-keyword">required</span> ServiceStatus status,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;ServiceStep&gt; steps,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> progressPercentage,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;estimated_completion&#x27;</span>) <span class="hljs-built_in">DateTime?</span> estimatedCompletion,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;actual_completion&#x27;</span>) <span class="hljs-built_in">DateTime?</span> actualCompletion,
    Technician? assignedTechnician,
    <span class="hljs-built_in">List</span>&lt;ServicePhoto&gt;? photos,
    <span class="hljs-built_in">String?</span> currentStepNote,
  }) = _ServiceProgress;

  <span class="hljs-keyword">factory</span> ServiceProgress.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt;
      _$ServiceProgressFromJson(json);
}

<span class="hljs-meta">@freezed</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceStep</span> <span class="hljs-title">with</span> <span class="hljs-title">_</span>$<span class="hljs-title">ServiceStep</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> ServiceStep({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> id,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> name,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> description,
    <span class="hljs-keyword">required</span> ServiceStepStatus status,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> orderIndex,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;started_at&#x27;</span>) <span class="hljs-built_in">DateTime?</span> startedAt,
    <span class="hljs-meta">@JsonKey</span>(name: <span class="hljs-string">&#x27;completed_at&#x27;</span>) <span class="hljs-built_in">DateTime?</span> completedAt,
    <span class="hljs-built_in">String?</span> note,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? photoIds,
    <span class="hljs-built_in">Duration?</span> estimatedDuration,
    <span class="hljs-built_in">Duration?</span> actualDuration,
  }) = _ServiceStep;

  <span class="hljs-keyword">factory</span> ServiceStep.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt;
      _$ServiceStepFromJson(json);
}
</code></pre>
<h3 id="4-枚举定义-srcenums">4. 枚举定义 (<code>src/enums/</code>)</h3>
<pre><code class="language-dart"><span class="hljs-keyword">enum</span> AppointmentStatus {
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;pending&#x27;</span>)
  pending,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;confirmed&#x27;</span>)
  confirmed,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;inProgress&#x27;</span>)
  inProgress,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;completed&#x27;</span>)
  completed,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;cancelled&#x27;</span>)
  cancelled,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;noShow&#x27;</span>)
  noShow,
}

<span class="hljs-keyword">enum</span> ServiceType {
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;maintenance&#x27;</span>)
  maintenance,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;repair&#x27;</span>)
  repair,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;inspection&#x27;</span>)
  inspection,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;bodywork&#x27;</span>)
  bodywork,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;insurance&#x27;</span>)
  insurance,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;emergency&#x27;</span>)
  emergency,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;recall&#x27;</span>)
  recall,
}

<span class="hljs-keyword">enum</span> ServiceStatus {
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;waiting&#x27;</span>)
  waiting,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;inProgress&#x27;</span>)
  inProgress,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;completed&#x27;</span>)
  completed,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;paused&#x27;</span>)
  paused,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;cancelled&#x27;</span>)
  cancelled,
}

<span class="hljs-keyword">enum</span> ServiceStepStatus {
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;pending&#x27;</span>)
  pending,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;inProgress&#x27;</span>)
  inProgress,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;completed&#x27;</span>)
  completed,
  <span class="hljs-meta">@JsonValue</span>(<span class="hljs-string">&#x27;skipped&#x27;</span>)
  skipped,
}
</code></pre>
<h3 id="5-异常定义-srcexceptions">5. 异常定义 (<code>src/exceptions/</code>)</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterSalesException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> code;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> details;
  
  <span class="hljs-keyword">const</span> AfterSalesException(<span class="hljs-keyword">this</span>.message, {<span class="hljs-keyword">this</span>.code, <span class="hljs-keyword">this</span>.details});
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> toString() =&gt; <span class="hljs-string">&#x27;AfterSalesException: <span class="hljs-subst">$message</span>&#x27;</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppointmentException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AfterSalesException</span> </span>{
  <span class="hljs-keyword">const</span> AppointmentException(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> code, <span class="hljs-built_in">dynamic</span> details})
      : <span class="hljs-keyword">super</span>(message, code: code, details: details);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AfterSalesException</span> </span>{
  <span class="hljs-keyword">const</span> ServiceException(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> code, <span class="hljs-built_in">dynamic</span> details})
      : <span class="hljs-keyword">super</span>(message, code: code, details: details);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AfterSalesException</span> </span>{
  <span class="hljs-keyword">const</span> PaymentException(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> code, <span class="hljs-built_in">dynamic</span> details})
      : <span class="hljs-keyword">super</span>(message, code: code, details: details);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetworkException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AfterSalesException</span> </span>{
  <span class="hljs-keyword">const</span> NetworkException(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> code, <span class="hljs-built_in">dynamic</span> details})
      : <span class="hljs-keyword">super</span>(message, code: code, details: details);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RepositoryException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AfterSalesException</span> </span>{
  <span class="hljs-keyword">const</span> RepositoryException(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> code, <span class="hljs-built_in">dynamic</span> details})
      : <span class="hljs-keyword">super</span>(message, code: code, details: details);
}
</code></pre>
<h3 id="6-结果封装-srcutilsresultdart">6. 结果封装 (<code>src/utils/result.dart</code>)</h3>
<pre><code class="language-dart"><span class="hljs-meta">@freezed</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">_</span>$<span class="hljs-title">Result</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> Result.success(T data) = Success&lt;T&gt;;
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">factory</span> Result.failure(Exception error) = Failure&lt;T&gt;;
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isSuccess =&gt; <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> Success&lt;T&gt;;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isFailure =&gt; <span class="hljs-keyword">this</span> <span class="hljs-keyword">is</span> Failure&lt;T&gt;;
  
  T? <span class="hljs-keyword">get</span> data =&gt; mapOrNull(success: (success) =&gt; success.data);
  Exception? <span class="hljs-keyword">get</span> error =&gt; mapOrNull(failure: (failure) =&gt; failure.error);
}

<span class="hljs-keyword">extension</span> ResultExtensions&lt;T&gt; <span class="hljs-keyword">on</span> Result&lt;T&gt; {
  R fold&lt;R&gt;(
    R <span class="hljs-built_in">Function</span>(T data) onSuccess,
    R <span class="hljs-built_in">Function</span>(Exception error) onFailure,
  ) {
    <span class="hljs-keyword">return</span> when(
      success: onSuccess,
      failure: onFailure,
    );
  }
  
  Future&lt;Result&lt;R&gt;&gt; mapAsync&lt;R&gt;(
    Future&lt;R&gt; <span class="hljs-built_in">Function</span>(T data) mapper,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> fold(
      (data) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> mapper(data);
          <span class="hljs-keyword">return</span> Result.success(result);
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-keyword">return</span> Result.failure(Exception(e.toString()));
        }
      },
      (error) =&gt; Future.value(Result.failure(error)),
    );
  }
}
</code></pre>
<h2 id="使用示例">使用示例</h2>
<h3 id="基础使用">基础使用</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterSalesExample</span> </span>{
  <span class="hljs-keyword">final</span> AppointmentService _appointmentService;
  <span class="hljs-keyword">final</span> ServiceProgressService _progressService;
  
  AfterSalesExample(<span class="hljs-keyword">this</span>._appointmentService, <span class="hljs-keyword">this</span>._progressService);
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; createAppointmentExample() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> request = AppointmentCreateRequest(
      storeId: <span class="hljs-string">&#x27;store_123&#x27;</span>,
      serviceType: ServiceType.maintenance,
      appointmentTime: <span class="hljs-built_in">DateTime</span>.now().add(<span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">1</span>)),
      vehicleInfo: VehicleInfo(
        vin: <span class="hljs-string">&#x27;WVWAA71K08W201030&#x27;</span>,
        licensePlate: <span class="hljs-string">&#x27;京A12345&#x27;</span>,
        model: <span class="hljs-string">&#x27;ID.4 CROZZ&#x27;</span>,
      ),
      description: <span class="hljs-string">&#x27;常规保养&#x27;</span>,
    );
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _appointmentService.createAppointment(request);
    
    result.fold(
      (appointment) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;预约创建成功: <span class="hljs-subst">${appointment.id}</span>&#x27;</span>);
      },
      (error) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;预约创建失败: <span class="hljs-subst">${error.toString()}</span>&#x27;</span>);
      },
    );
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; trackServiceProgressExample(<span class="hljs-built_in">String</span> appointmentId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _progressService.getServiceProgress(appointmentId);
    
    result.fold(
      (progress) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;服务进度: <span class="hljs-subst">${progress.progressPercentage}</span>%&#x27;</span>);
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;当前步骤: <span class="hljs-subst">${progress.steps.where((s) =&gt; s.status == ServiceStepStatus.inProgress).first.name}</span>&#x27;</span>);
      },
      (error) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;获取进度失败: <span class="hljs-subst">${error.toString()}</span>&#x27;</span>);
      },
    );
  }
}
</code></pre>
<h3 id="依赖注入配置">依赖注入配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterSalesDI</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> setupDependencies(GetIt locator) {
    <span class="hljs-comment">// 注册仓库</span>
    locator.registerLazySingleton&lt;AppointmentRepository&gt;(
      () =&gt; AppointmentRepositoryImpl(
        locator&lt;LocalStorage&gt;(),
        locator&lt;DatabaseHelper&gt;(),
      ),
    );
    
    locator.registerLazySingleton&lt;ServiceProgressRepository&gt;(
      () =&gt; ServiceProgressRepositoryImpl(
        locator&lt;LocalStorage&gt;(),
        locator&lt;DatabaseHelper&gt;(),
      ),
    );
    
    <span class="hljs-comment">// 注册服务</span>
    locator.registerLazySingleton&lt;AppointmentService&gt;(
      () =&gt; AppointmentService(
        locator&lt;AppointmentRepository&gt;(),
        locator&lt;NetworkService&gt;(),
      ),
    );
    
    locator.registerLazySingleton&lt;ServiceProgressService&gt;(
      () =&gt; ServiceProgressService(
        locator&lt;ServiceProgressRepository&gt;(),
        locator&lt;NetworkService&gt;(),
      ),
    );
  }
}
</code></pre>
<h2 id="测试策略">测试策略</h2>
<h3 id="单元测试">单元测试</h3>
<pre><code class="language-dart"><span class="hljs-keyword">void</span> main() {
  group(<span class="hljs-string">&#x27;AppointmentService&#x27;</span>, () {
    <span class="hljs-keyword">late</span> AppointmentService appointmentService;
    <span class="hljs-keyword">late</span> MockAppointmentRepository mockRepository;
    <span class="hljs-keyword">late</span> MockNetworkService mockNetworkService;
    
    setUp(() {
      mockRepository = MockAppointmentRepository();
      mockNetworkService = MockNetworkService();
      appointmentService = AppointmentService(mockRepository, mockNetworkService);
    });
    
    test(<span class="hljs-string">&#x27;should create appointment successfully&#x27;</span>, () <span class="hljs-keyword">async</span> {
      <span class="hljs-comment">// Arrange</span>
      <span class="hljs-keyword">final</span> request = AppointmentCreateRequest(
        storeId: <span class="hljs-string">&#x27;store_123&#x27;</span>,
        serviceType: ServiceType.maintenance,
        appointmentTime: <span class="hljs-built_in">DateTime</span>.now().add(<span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">1</span>)),
        vehicleInfo: VehicleInfo(vin: <span class="hljs-string">&#x27;TEST123&#x27;</span>),
      );
      
      <span class="hljs-keyword">final</span> expectedAppointment = Appointment(
        id: <span class="hljs-string">&#x27;appointment_123&#x27;</span>,
        userId: <span class="hljs-string">&#x27;user_123&#x27;</span>,
        storeId: request.storeId,
        serviceType: request.serviceType,
        appointmentTime: request.appointmentTime,
        status: AppointmentStatus.pending,
        vehicleInfo: request.vehicleInfo,
      );
      
      when(mockNetworkService.post(<span class="hljs-string">&#x27;/appointments&#x27;</span>, data: any))
          .thenAnswer((_) <span class="hljs-keyword">async</span> =&gt; ApiResponse(data: expectedAppointment.toJson()));
      
      <span class="hljs-comment">// Act</span>
      <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> appointmentService.createAppointment(request);
      
      <span class="hljs-comment">// Assert</span>
      expect(result.isSuccess, <span class="hljs-keyword">true</span>);
      expect(result.data?.id, <span class="hljs-string">&#x27;appointment_123&#x27;</span>);
      verify(mockRepository.saveAppointment(any)).called(<span class="hljs-number">1</span>);
    });
  });
}
</code></pre>
<h2 id="最佳实践">最佳实践</h2>
<h3 id="api设计原则">API设计原则</h3>
<ol>
<li><strong>统一响应格式</strong>: 所有API使用统一的响应格式</li>
<li><strong>错误处理</strong>: 完善的错误码和错误信息</li>
<li><strong>数据验证</strong>: 严格的输入数据验证</li>
<li><strong>幂等性</strong>: 关键操作支持幂等性</li>
</ol>
<h3 id="缓存策略">缓存策略</h3>
<ol>
<li><strong>多级缓存</strong>: 内存缓存 + 本地存储 + 网络</li>
<li><strong>缓存失效</strong>: 基于时间和事件的缓存失效</li>
<li><strong>数据一致性</strong>: 保证缓存与服务器数据一致</li>
<li><strong>离线支持</strong>: 关键数据支持离线访问</li>
</ol>
<h2 id="总结">总结</h2>
<p><code>clr_after_sales</code> 模块作为售后服务的核心SDK，通过完善的架构设计和标准化的接口封装，为售后服务应用提供了稳定可靠的技术支撑。模块采用了领域驱动设计思想，具有良好的可测试性和可维护性，能够支撑复杂的售后业务场景。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>