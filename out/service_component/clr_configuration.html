<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>CLR Configuration - &#x914d;&#x7f6e;&#x670d;&#x52a1;SDK</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="clr-configuration---配置服务sdk">CLR Configuration - 配置服务SDK</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>clr_configuration</code> 是 OneApp 配置服务的核心 SDK，为应用配置管理提供底层的 API 封装和数据处理能力。该 SDK 封装了配置服务的网络接口、数据模型、同步机制和变更通知等功能，为上层的配置管理模块提供稳定可靠的服务支撑。</p>
<h2 id="核心功能">核心功能</h2>
<h3 id="1-配置-api-封装">1. 配置 API 封装</h3>
<ul>
<li><strong>RESTful API</strong>：配置服务 REST API 封装</li>
<li><strong>GraphQL API</strong>：配置查询 GraphQL 接口</li>
<li><strong>WebSocket API</strong>：实时配置更新接口</li>
<li><strong>批量操作</strong>：配置批量读写操作</li>
</ul>
<h3 id="2-配置数据模型">2. 配置数据模型</h3>
<ul>
<li><strong>数据结构</strong>：标准化的配置数据结构</li>
<li><strong>类型系统</strong>：强类型配置值系统</li>
<li><strong>序列化</strong>：配置数据序列化和反序列化</li>
<li><strong>验证机制</strong>：配置数据有效性验证</li>
</ul>
<h3 id="3-配置同步机制">3. 配置同步机制</h3>
<ul>
<li><strong>增量同步</strong>：配置变更增量同步</li>
<li><strong>冲突解决</strong>：配置冲突解决策略</li>
<li><strong>版本控制</strong>：配置版本管理机制</li>
<li><strong>事务支持</strong>：配置操作事务保证</li>
</ul>
<h3 id="4-配置变更通知">4. 配置变更通知</h3>
<ul>
<li><strong>事件驱动</strong>：基于事件的变更通知</li>
<li><strong>订阅机制</strong>：配置变更订阅管理</li>
<li><strong>推送通知</strong>：实时推送配置变更</li>
<li><strong>回调处理</strong>：配置变更回调处理</li>
</ul>
<h2 id="技术架构">技术架构</h2>
<h3 id="架构设计">架构设计</h3>
<pre><code>┌─────────────────────────────────────┐
│          配置管理应用层              │
│      (app_configuration)           │
├─────────────────────────────────────┤
│         CLR Configuration           │
│  ┌──────────┬──────────┬──────────┐ │
│  │ API封装  │ 数据模型 │ 同步引擎 │ │
│  ├──────────┼──────────┼──────────┤ │
│  │ 事件系统 │ 缓存层   │ 安全模块 │ │
│  └──────────┴──────────┴──────────┘ │
├─────────────────────────────────────┤
│           网络通信层                │
│    (HTTP/WebSocket/GraphQL)         │
├─────────────────────────────────────┤
│           配置服务后端              │
│        (Configuration Server)       │
└─────────────────────────────────────┘
</code></pre>
<h3 id="核心组件">核心组件</h3>
<h4 id="1-api-客户端-apiclient">1. API 客户端 (ApiClient)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationApiClient</span> </span>{
  <span class="hljs-comment">// 获取配置</span>
  Future&lt;ApiResponse&lt;ConfigData&gt;&gt; getConfiguration(GetConfigRequest request);
  
  <span class="hljs-comment">// 设置配置</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; setConfiguration(SetConfigRequest request);
  
  <span class="hljs-comment">// 批量获取配置</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ConfigData&gt;&gt;&gt; getBatchConfiguration(BatchGetRequest request);
  
  <span class="hljs-comment">// 订阅配置变更</span>
  Stream&lt;ConfigurationChange&gt; subscribeConfigurationChanges(<span class="hljs-built_in">String</span> key);
}
</code></pre>
<h4 id="2-数据模型管理器-datamodelmanager">2. 数据模型管理器 (DataModelManager)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationDataModel</span> </span>{
  <span class="hljs-comment">// 序列化配置数据</span>
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; serialize(ConfigData data);
  
  <span class="hljs-comment">// 反序列化配置数据</span>
  ConfigData deserialize(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json);
  
  <span class="hljs-comment">// 验证配置数据</span>
  ValidationResult validate(ConfigData data);
  
  <span class="hljs-comment">// 转换配置数据类型</span>
  T convertValue&lt;T&gt;(<span class="hljs-built_in">dynamic</span> value, ConfigType targetType);
}
</code></pre>
<h4 id="3-同步引擎-syncengine">3. 同步引擎 (SyncEngine)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationSyncEngine</span> </span>{
  <span class="hljs-comment">// 开始同步</span>
  Future&lt;SyncResult&gt; startSync(SyncOptions options);
  
  <span class="hljs-comment">// 增量同步</span>
  Future&lt;SyncResult&gt; incrementalSync(<span class="hljs-built_in">String</span> lastSyncVersion);
  
  <span class="hljs-comment">// 解决冲突</span>
  Future&lt;ConflictResolution&gt; resolveConflict(ConfigurationConflict conflict);
  
  <span class="hljs-comment">// 回滚配置</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; rollbackConfiguration(<span class="hljs-built_in">String</span> version);
}
</code></pre>
<h4 id="4-事件系统-eventsystem">4. 事件系统 (EventSystem)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationEventSystem</span> </span>{
  <span class="hljs-comment">// 发布事件</span>
  <span class="hljs-keyword">void</span> publishEvent(ConfigurationEvent event);
  
  <span class="hljs-comment">// 订阅事件</span>
  StreamSubscription&lt;T&gt; subscribe&lt;T <span class="hljs-keyword">extends</span> ConfigurationEvent&gt;(EventHandler&lt;T&gt; handler);
  
  <span class="hljs-comment">// 取消订阅</span>
  <span class="hljs-keyword">void</span> unsubscribe(StreamSubscription subscription);
  
  <span class="hljs-comment">// 清理事件</span>
  <span class="hljs-keyword">void</span> clearEvents([<span class="hljs-built_in">String?</span> eventType]);
}
</code></pre>
<h2 id="数据模型">数据模型</h2>
<h3 id="配置数据模型">配置数据模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigData</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> key;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> value;
  <span class="hljs-keyword">final</span> ConfigType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> version;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; tags;
  <span class="hljs-keyword">final</span> ConfigScope scope;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isEncrypted;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> description;
}

<span class="hljs-keyword">enum</span> ConfigType {
  string,
  integer,
  <span class="hljs-built_in">double</span>,
  boolean,
  json,
  array,
  binary
}

<span class="hljs-keyword">enum</span> ConfigScope {
  global,
  user,
  device,
  session
}
</code></pre>
<h3 id="配置变更模型">配置变更模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationChange</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> key;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> oldValue;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> newValue;
  <span class="hljs-keyword">final</span> ChangeType changeType;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> version;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> source;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; context;
}

<span class="hljs-keyword">enum</span> ChangeType {
  created,
  updated,
  deleted,
  restored
}
</code></pre>
<h3 id="api-请求模型">API 请求模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetConfigRequest</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> key;
  <span class="hljs-keyword">final</span> ConfigScope? scope;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> version;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> includeMetadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? tags;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SetConfigRequest</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> key;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">dynamic</span> value;
  <span class="hljs-keyword">final</span> ConfigType type;
  <span class="hljs-keyword">final</span> ConfigScope scope;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;? metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? tags;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> encrypt;
}
</code></pre>
<h2 id="api-接口">API 接口</h2>
<h3 id="配置操作接口">配置操作接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationApi</span> </span>{
  <span class="hljs-comment">// 获取单个配置</span>
  Future&lt;ApiResponse&lt;ConfigData&gt;&gt; getConfig(<span class="hljs-built_in">String</span> key, {ConfigScope? scope});
  
  <span class="hljs-comment">// 设置单个配置</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; setConfig(<span class="hljs-built_in">String</span> key, <span class="hljs-built_in">dynamic</span> value, {ConfigType? type, ConfigScope? scope});
  
  <span class="hljs-comment">// 删除配置</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; deleteConfig(<span class="hljs-built_in">String</span> key, {ConfigScope? scope});
  
  <span class="hljs-comment">// 检查配置是否存在</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; hasConfig(<span class="hljs-built_in">String</span> key, {ConfigScope? scope});
}
</code></pre>
<h3 id="批量操作接口">批量操作接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchConfigurationApi</span> </span>{
  <span class="hljs-comment">// 批量获取配置</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ConfigData&gt;&gt;&gt; getBatchConfigs(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; keys);
  
  <span class="hljs-comment">// 批量设置配置</span>
  Future&lt;ApiResponse&lt;BatchResult&gt;&gt; setBatchConfigs(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; configs);
  
  <span class="hljs-comment">// 批量删除配置</span>
  Future&lt;ApiResponse&lt;BatchResult&gt;&gt; deleteBatchConfigs(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; keys);
}
</code></pre>
<h3 id="同步接口">同步接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationSyncApi</span> </span>{
  <span class="hljs-comment">// 获取配置版本</span>
  Future&lt;ApiResponse&lt;ConfigVersion&gt;&gt; getConfigVersion();
  
  <span class="hljs-comment">// 同步配置</span>
  Future&lt;ApiResponse&lt;SyncResult&gt;&gt; syncConfigurations(SyncRequest request);
  
  <span class="hljs-comment">// 获取配置变更历史</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">List</span>&lt;ConfigurationChange&gt;&gt;&gt; getChangeHistory(ChangeHistoryRequest request);
}
</code></pre>
<h2 id="配置管理">配置管理</h2>
<h3 id="sdk-配置">SDK 配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationSdkConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> serverUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> apiKey;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> clientId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> timeout;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxRetries;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableCache;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableEncryption;
  <span class="hljs-keyword">final</span> LogLevel logLevel;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> ConfigurationSdkConfig defaultConfig = ConfigurationSdkConfig(
    serverUrl: <span class="hljs-string">&#x27;https://config-api.oneapp.com&#x27;</span>,
    timeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>),
    maxRetries: <span class="hljs-number">3</span>,
    enableCache: <span class="hljs-keyword">true</span>,
    enableEncryption: <span class="hljs-keyword">true</span>,
    logLevel: LogLevel.info,
  );
}
</code></pre>
<h3 id="缓存配置">缓存配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> ttl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxSize;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableCompression;
  <span class="hljs-keyword">final</span> CacheEvictionPolicy evictionPolicy;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> CacheConfig defaultCacheConfig = CacheConfig(
    ttl: <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">30</span>),
    maxSize: <span class="hljs-number">1000</span>,
    enableCompression: <span class="hljs-keyword">true</span>,
    evictionPolicy: CacheEvictionPolicy.lru,
  );
}
</code></pre>
<h2 id="使用示例">使用示例</h2>
<h3 id="基本配置操作">基本配置操作</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 初始化 SDK</span>
<span class="hljs-keyword">final</span> configSdk = ConfigurationSdk.instance;
<span class="hljs-keyword">await</span> configSdk.initialize(ConfigurationSdkConfig.defaultConfig);

<span class="hljs-comment">// 获取配置</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">final</span> config = <span class="hljs-keyword">await</span> configSdk.getConfig(<span class="hljs-string">&#x27;app.theme&#x27;</span>);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;当前主题: <span class="hljs-subst">${config.value}</span>&#x27;</span>);
} <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;获取配置失败: <span class="hljs-subst">$e</span>&#x27;</span>);
}

<span class="hljs-comment">// 设置配置</span>
<span class="hljs-keyword">await</span> configSdk.setConfig(
  <span class="hljs-string">&#x27;user.language&#x27;</span>, 
  <span class="hljs-string">&#x27;zh-CN&#x27;</span>,
  type: ConfigType.string,
  scope: ConfigScope.user,
);

<span class="hljs-comment">// 删除配置</span>
<span class="hljs-keyword">await</span> configSdk.deleteConfig(<span class="hljs-string">&#x27;temp.data&#x27;</span>);
</code></pre>
<h3 id="批量配置操作">批量配置操作</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 批量获取配置</span>
<span class="hljs-keyword">final</span> keys = [<span class="hljs-string">&#x27;app.theme&#x27;</span>, <span class="hljs-string">&#x27;app.language&#x27;</span>, <span class="hljs-string">&#x27;app.version&#x27;</span>];
<span class="hljs-keyword">final</span> batchResult = <span class="hljs-keyword">await</span> configSdk.getBatchConfigs(keys);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> entry <span class="hljs-keyword">in</span> batchResult.entries) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">${entry.key}</span>: <span class="hljs-subst">${entry.value.value}</span>&#x27;</span>);
}

<span class="hljs-comment">// 批量设置配置</span>
<span class="hljs-keyword">final</span> batchConfigs = {
  <span class="hljs-string">&#x27;ui.showTips&#x27;</span>: <span class="hljs-keyword">true</span>,
  <span class="hljs-string">&#x27;ui.animationSpeed&#x27;</span>: <span class="hljs-number">1.0</span>,
  <span class="hljs-string">&#x27;ui.darkMode&#x27;</span>: <span class="hljs-keyword">false</span>,
};

<span class="hljs-keyword">await</span> configSdk.setBatchConfigs(batchConfigs);
</code></pre>
<h3 id="配置变更监听">配置变更监听</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 监听特定配置变更</span>
configSdk.subscribeConfigurationChanges(<span class="hljs-string">&#x27;app.theme&#x27;</span>).listen((change) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;主题配置变更: <span class="hljs-subst">${change.oldValue}</span> -&gt; <span class="hljs-subst">${change.newValue}</span>&#x27;</span>);
  <span class="hljs-comment">// 应用新的主题配置</span>
  applyThemeConfig(change.newValue);
});

<span class="hljs-comment">// 监听所有配置变更</span>
configSdk.onConfigurationChanged.listen((change) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;配置变更: <span class="hljs-subst">${change.key}</span>&#x27;</span>);
  logConfigurationChange(change);
});
</code></pre>
<h3 id="配置同步">配置同步</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 检查是否有配置更新</span>
<span class="hljs-keyword">final</span> currentVersion = <span class="hljs-keyword">await</span> configSdk.getConfigVersion();
<span class="hljs-keyword">final</span> hasUpdate = <span class="hljs-keyword">await</span> configSdk.checkForUpdates(currentVersion.version);

<span class="hljs-keyword">if</span> (hasUpdate) {
  <span class="hljs-comment">// 执行增量同步</span>
  <span class="hljs-keyword">final</span> syncResult = <span class="hljs-keyword">await</span> configSdk.incrementalSync(currentVersion.version);
  
  <span class="hljs-keyword">if</span> (syncResult.isSuccess) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;配置同步成功，更新了 <span class="hljs-subst">${syncResult.updatedCount}</span> 个配置&#x27;</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;配置同步失败: <span class="hljs-subst">${syncResult.error}</span>&#x27;</span>);
  }
}
</code></pre>
<h2 id="测试策略">测试策略</h2>
<h3 id="单元测试">单元测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;ConfigurationSdk Tests&#x27;</span>, () {
  test(<span class="hljs-string">&#x27;should get configuration successfully&#x27;</span>, () <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Given</span>
    <span class="hljs-keyword">final</span> sdk = ConfigurationSdk();
    <span class="hljs-keyword">await</span> sdk.initialize(ConfigurationSdkConfig.defaultConfig);
    
    <span class="hljs-comment">// When</span>
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> sdk.getConfig(<span class="hljs-string">&#x27;test.key&#x27;</span>);
    
    <span class="hljs-comment">// Then</span>
    expect(result.key, <span class="hljs-string">&#x27;test.key&#x27;</span>);
    expect(result.value, isNotNull);
  });
  
  test(<span class="hljs-string">&#x27;should handle configuration not found&#x27;</span>, () <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Given</span>
    <span class="hljs-keyword">final</span> sdk = ConfigurationSdk();
    
    <span class="hljs-comment">// When &amp; Then</span>
    expect(
      () =&gt; sdk.getConfig(<span class="hljs-string">&#x27;nonexistent.key&#x27;</span>),
      throwsA(isA&lt;ConfigurationNotFoundException&gt;()),
    );
  });
});
</code></pre>
<h3 id="集成测试">集成测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;Configuration Integration Tests&#x27;</span>, () {
  testWidgets(<span class="hljs-string">&#x27;configuration sync flow&#x27;</span>, (tester) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 1. 初始化 SDK</span>
    <span class="hljs-keyword">await</span> ConfigurationSdk.instance.initialize(testConfig);
    
    <span class="hljs-comment">// 2. 设置配置</span>
    <span class="hljs-keyword">await</span> ConfigurationSdk.instance.setConfig(<span class="hljs-string">&#x27;test.sync&#x27;</span>, <span class="hljs-string">&#x27;value1&#x27;</span>);
    
    <span class="hljs-comment">// 3. 模拟远程配置变更</span>
    <span class="hljs-keyword">await</span> simulateRemoteConfigChange(<span class="hljs-string">&#x27;test.sync&#x27;</span>, <span class="hljs-string">&#x27;value2&#x27;</span>);
    
    <span class="hljs-comment">// 4. 执行同步</span>
    <span class="hljs-keyword">final</span> syncResult = <span class="hljs-keyword">await</span> ConfigurationSdk.instance.<span class="hljs-keyword">sync</span>();
    
    <span class="hljs-comment">// 5. 验证同步结果</span>
    expect(syncResult.isSuccess, <span class="hljs-keyword">true</span>);
    
    <span class="hljs-keyword">final</span> updatedConfig = <span class="hljs-keyword">await</span> ConfigurationSdk.instance.getConfig(<span class="hljs-string">&#x27;test.sync&#x27;</span>);
    expect(updatedConfig.value, <span class="hljs-string">&#x27;value2&#x27;</span>);
  });
});
</code></pre>
<h2 id="性能优化">性能优化</h2>
<h3 id="缓存策略">缓存策略</h3>
<ul>
<li><strong>多级缓存</strong>：内存 + 磁盘多级缓存</li>
<li><strong>智能预加载</strong>：预测性配置预加载</li>
<li><strong>缓存压缩</strong>：配置数据压缩存储</li>
<li><strong>缓存更新</strong>：增量缓存更新机制</li>
</ul>
<h3 id="网络优化">网络优化</h3>
<ul>
<li><strong>连接复用</strong>：HTTP 连接池复用</li>
<li><strong>请求合并</strong>：相关配置请求合并</li>
<li><strong>数据压缩</strong>：传输数据 gzip 压缩</li>
<li><strong>离线模式</strong>：离线配置访问支持</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="错误类型">错误类型</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> errorCode;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? details;
  
  <span class="hljs-keyword">const</span> ConfigurationException(<span class="hljs-keyword">this</span>.message, [<span class="hljs-keyword">this</span>.errorCode, <span class="hljs-keyword">this</span>.details]);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationNotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConfigurationException</span> </span>{
  <span class="hljs-keyword">const</span> ConfigurationNotFoundException(<span class="hljs-built_in">String</span> key) 
      : <span class="hljs-keyword">super</span>(<span class="hljs-string">&#x27;Configuration not found: <span class="hljs-subst">$key</span>&#x27;</span>, <span class="hljs-string">&#x27;CONFIG_NOT_FOUND&#x27;</span>);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationValidationException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConfigurationException</span> </span>{
  <span class="hljs-keyword">const</span> ConfigurationValidationException(<span class="hljs-built_in">String</span> message, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; details)
      : <span class="hljs-keyword">super</span>(message, <span class="hljs-string">&#x27;VALIDATION_ERROR&#x27;</span>, details);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationSyncException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ConfigurationException</span> </span>{
  <span class="hljs-keyword">const</span> ConfigurationSyncException(<span class="hljs-built_in">String</span> message)
      : <span class="hljs-keyword">super</span>(message, <span class="hljs-string">&#x27;SYNC_ERROR&#x27;</span>);
}
</code></pre>
<h3 id="重试机制">重试机制</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RetryConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxRetries;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> initialDelay;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> backoffMultiplier;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> maxDelay;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> RetryConfig defaultRetryConfig = RetryConfig(
    maxRetries: <span class="hljs-number">3</span>,
    initialDelay: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
    backoffMultiplier: <span class="hljs-number">2.0</span>,
    maxDelay: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>),
  );
}
</code></pre>
<h2 id="安全机制">安全机制</h2>
<h3 id="数据加密">数据加密</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationEncryption</span> </span>{
  <span class="hljs-comment">// 加密配置值</span>
  <span class="hljs-built_in">String</span> encryptValue(<span class="hljs-built_in">String</span> value, <span class="hljs-built_in">String</span> key);
  
  <span class="hljs-comment">// 解密配置值</span>
  <span class="hljs-built_in">String</span> decryptValue(<span class="hljs-built_in">String</span> encryptedValue, <span class="hljs-built_in">String</span> key);
  
  <span class="hljs-comment">// 生成加密密钥</span>
  <span class="hljs-built_in">String</span> generateEncryptionKey();
  
  <span class="hljs-comment">// 验证数据完整性</span>
  <span class="hljs-built_in">bool</span> verifyIntegrity(<span class="hljs-built_in">String</span> data, <span class="hljs-built_in">String</span> signature);
}
</code></pre>
<h3 id="访问控制">访问控制</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfigurationAccessControl</span> </span>{
  <span class="hljs-comment">// 检查读权限</span>
  <span class="hljs-built_in">bool</span> hasReadPermission(<span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> userId);
  
  <span class="hljs-comment">// 检查写权限</span>
  <span class="hljs-built_in">bool</span> hasWritePermission(<span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> userId);
  
  <span class="hljs-comment">// 检查删除权限</span>
  <span class="hljs-built_in">bool</span> hasDeletePermission(<span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> userId);
  
  <span class="hljs-comment">// 获取用户权限</span>
  <span class="hljs-built_in">List</span>&lt;Permission&gt; getUserPermissions(<span class="hljs-built_in">String</span> userId);
}
</code></pre>
<h2 id="监控和诊断">监控和诊断</h2>
<h3 id="性能监控">性能监控</h3>
<ul>
<li><strong>API 响应时间</strong>：配置 API 响应时间监控</li>
<li><strong>缓存命中率</strong>：配置缓存命中率统计</li>
<li><strong>错误率</strong>：配置操作错误率监控</li>
<li><strong>同步性能</strong>：配置同步性能指标</li>
</ul>
<h3 id="使用统计">使用统计</h3>
<ul>
<li><strong>配置访问频率</strong>：统计配置项访问频率</li>
<li><strong>热点配置</strong>：识别热点配置项</li>
<li><strong>用户行为</strong>：分析用户配置使用模式</li>
<li><strong>性能瓶颈</strong>：识别性能瓶颈点</li>
</ul>
<h2 id="版本历史">版本历史</h2>
<h3 id="v0285-当前版本">v0.2.8+5 (当前版本)</h3>
<ul>
<li>新增 GraphQL 查询支持</li>
<li>优化配置同步性能</li>
<li>支持配置数据压缩</li>
<li>修复并发访问问题</li>
</ul>
<h3 id="v027">v0.2.7</h3>
<ul>
<li>支持配置数据加密</li>
<li>新增批量操作接口</li>
<li>优化缓存机制</li>
<li>改进错误处理</li>
</ul>
<h2 id="依赖关系">依赖关系</h2>
<h3 id="内部依赖">内部依赖</h3>
<ul>
<li><code>basic_network</code>: 网络请求基础库</li>
<li><code>basic_storage</code>: 本地存储服务</li>
<li><code>basic_error</code>: 错误处理框架</li>
<li><code>basic_logger</code>: 日志记录服务</li>
</ul>
<h3 id="外部依赖">外部依赖</h3>
<ul>
<li><code>dio</code>: HTTP 客户端</li>
<li><code>json_annotation</code>: JSON 序列化</li>
<li><code>encrypt</code>: 数据加密库</li>
<li><code>rxdart</code>: 响应式编程支持</li>
</ul>
<h2 id="总结">总结</h2>
<p><code>clr_configuration</code> 作为配置服务的核心 SDK，为 OneApp 的配置管理提供了强大的底层支撑。通过标准化的 API 接口、完善的数据模型、可靠的同步机制和实时的变更通知，该 SDK 确保了配置服务的高性能、高可用和高安全性，为上层应用提供了稳定可靠的配置管理能力。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>