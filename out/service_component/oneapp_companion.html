<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>OneApp Companion - &#x4f34;&#x4fa3;&#x5e94;&#x7528;&#x6a21;&#x5757;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="oneapp-companion---伴侣应用模块">OneApp Companion - 伴侣应用模块</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>oneapp_companion</code> 是 OneApp 的伴侣应用模块，提供多设备协同功能。该模块支持手机、平板、智能手表、车载设备等多种设备间的数据同步、远程控制和设备管理，为用户提供无缝的跨设备体验。</p>
<h2 id="核心功能">核心功能</h2>
<h3 id="1-多设备协同">1. 多设备协同</h3>
<ul>
<li><strong>设备发现</strong>：自动发现附近的伴侣设备</li>
<li><strong>设备配对</strong>：安全的设备配对和认证</li>
<li><strong>状态同步</strong>：设备状态实时同步</li>
<li><strong>会话共享</strong>：跨设备会话状态共享</li>
</ul>
<h3 id="2-数据同步">2. 数据同步</h3>
<ul>
<li><strong>实时同步</strong>：关键数据实时同步</li>
<li><strong>增量同步</strong>：高效的增量数据同步</li>
<li><strong>冲突解决</strong>：数据冲突智能解决</li>
<li><strong>离线同步</strong>：离线状态下的数据缓存和同步</li>
</ul>
<h3 id="3-远程控制">3. 远程控制</h3>
<ul>
<li><strong>车辆控制</strong>：远程控制车辆功能</li>
<li><strong>应用控制</strong>：远程控制应用操作</li>
<li><strong>媒体控制</strong>：跨设备媒体播放控制</li>
<li><strong>权限管理</strong>：远程操作权限控制</li>
</ul>
<h3 id="4-设备管理">4. 设备管理</h3>
<ul>
<li><strong>设备注册</strong>：新设备注册和绑定</li>
<li><strong>设备监控</strong>：设备状态监控和管理</li>
<li><strong>设备配置</strong>：设备配置同步和管理</li>
<li><strong>设备安全</strong>：设备安全策略和控制</li>
</ul>
<h2 id="技术架构">技术架构</h2>
<h3 id="架构设计">架构设计</h3>
<pre><code>┌─────────────────────────────────────┐
│            主应用设备                │
│          (Primary Device)           │
├─────────────────────────────────────┤
│        OneApp Companion             │
│  ┌──────────┬──────────┬──────────┐ │
│  │ 设备管理 │ 数据同步 │ 远程控制 │ │
│  ├──────────┼──────────┼──────────┤ │
│  │ 通信协议 │ 安全模块 │ 状态管理 │ │
│  └──────────┴──────────┴──────────┘ │
├─────────────────────────────────────┤
│           通信协议层                │
│  ┌──────────┬──────────┬──────────┐ │
│  │ Bluetooth│  WiFi    │ Cellular │ │
│  └──────────┴──────────┴──────────┘ │
├─────────────────────────────────────┤
│           伴侣设备群                │
│  ┌──────────┬──────────┬──────────┐ │
│  │ 手机/平板│ 智能手表 │ 车载设备 │ │
│  └──────────┴──────────┴──────────┘ │
└─────────────────────────────────────┘
</code></pre>
<h3 id="核心组件">核心组件</h3>
<h4 id="1-设备管理器-devicemanager">1. 设备管理器 (DeviceManager)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionDeviceManager</span> </span>{
  <span class="hljs-comment">// 发现设备</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;CompanionDevice&gt;&gt; discoverDevices();
  
  <span class="hljs-comment">// 配对设备</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; pairDevice(<span class="hljs-built_in">String</span> deviceId);
  
  <span class="hljs-comment">// 获取已配对设备</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;CompanionDevice&gt;&gt; getPairedDevices();
  
  <span class="hljs-comment">// 断开设备连接</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; disconnectDevice(<span class="hljs-built_in">String</span> deviceId);
}
</code></pre>
<h4 id="2-数据同步器-datasynchronizer">2. 数据同步器 (DataSynchronizer)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionDataSynchronizer</span> </span>{
  <span class="hljs-comment">// 同步数据到设备</span>
  Future&lt;SyncResult&gt; syncToDevice(<span class="hljs-built_in">String</span> deviceId, SyncData data);
  
  <span class="hljs-comment">// 从设备同步数据</span>
  Future&lt;SyncResult&gt; syncFromDevice(<span class="hljs-built_in">String</span> deviceId);
  
  <span class="hljs-comment">// 批量同步</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;SyncResult&gt;&gt; batchSync(<span class="hljs-built_in">List</span>&lt;SyncRequest&gt; requests);
  
  <span class="hljs-comment">// 解决同步冲突</span>
  Future&lt;ConflictResolution&gt; resolveConflicts(<span class="hljs-built_in">List</span>&lt;SyncConflict&gt; conflicts);
}
</code></pre>
<h4 id="3-远程控制器-remotecontroller">3. 远程控制器 (RemoteController)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionRemoteController</span> </span>{
  <span class="hljs-comment">// 发送远程指令</span>
  Future&lt;CommandResult&gt; sendCommand(<span class="hljs-built_in">String</span> deviceId, RemoteCommand command);
  
  <span class="hljs-comment">// 批量发送指令</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;CommandResult&gt;&gt; sendBatchCommands(<span class="hljs-built_in">String</span> deviceId, <span class="hljs-built_in">List</span>&lt;RemoteCommand&gt; commands);
  
  <span class="hljs-comment">// 监听远程指令</span>
  Stream&lt;RemoteCommand&gt; listenForCommands();
  
  <span class="hljs-comment">// 响应远程指令</span>
  Future&lt;CommandResult&gt; respondToCommand(RemoteCommand command);
}
</code></pre>
<h4 id="4-连接管理器-connectionmanager">4. 连接管理器 (ConnectionManager)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionConnectionManager</span> </span>{
  <span class="hljs-comment">// 建立连接</span>
  Future&lt;Connection&gt; establishConnection(CompanionDevice device);
  
  <span class="hljs-comment">// 维持连接</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; maintainConnection(<span class="hljs-built_in">String</span> deviceId);
  
  <span class="hljs-comment">// 监控连接状态</span>
  Stream&lt;ConnectionStatus&gt; monitorConnection(<span class="hljs-built_in">String</span> deviceId);
  
  <span class="hljs-comment">// 重连设备</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; reconnectDevice(<span class="hljs-built_in">String</span> deviceId);
}
</code></pre>
<h2 id="数据模型">数据模型</h2>
<h3 id="设备模型">设备模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionDevice</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> DeviceType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> model;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> version;
  <span class="hljs-keyword">final</span> DeviceStatus status;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> lastSeen;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; capabilities;
  <span class="hljs-keyword">final</span> SecurityInfo security;
  <span class="hljs-keyword">final</span> ConnectionInfo connection;
}

<span class="hljs-keyword">enum</span> DeviceType {
  smartphone,    <span class="hljs-comment">// 智能手机</span>
  tablet,        <span class="hljs-comment">// 平板电脑</span>
  smartwatch,    <span class="hljs-comment">// 智能手表</span>
  carDisplay,    <span class="hljs-comment">// 车载显示器</span>
  desktop,       <span class="hljs-comment">// 桌面应用</span>
  other          <span class="hljs-comment">// 其他设备</span>
}

<span class="hljs-keyword">enum</span> DeviceStatus {
  online,        <span class="hljs-comment">// 在线</span>
  offline,       <span class="hljs-comment">// 离线</span>
  connecting,    <span class="hljs-comment">// 连接中</span>
  syncing,       <span class="hljs-comment">// 同步中</span>
  error          <span class="hljs-comment">// 错误状态</span>
}
</code></pre>
<h3 id="同步数据模型">同步数据模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SyncData</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> SyncDataType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; data;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> version;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; targetDevices;
  <span class="hljs-keyword">final</span> SyncPriority priority;
}

<span class="hljs-keyword">enum</span> SyncDataType {
  userPreferences,   <span class="hljs-comment">// 用户偏好</span>
  vehicleStatus,     <span class="hljs-comment">// 车辆状态</span>
  mediaPlaylist,     <span class="hljs-comment">// 媒体播放列表</span>
  navigationRoute,   <span class="hljs-comment">// 导航路线</span>
  chargingSession,   <span class="hljs-comment">// 充电会话</span>
  configuration      <span class="hljs-comment">// 配置信息</span>
}

<span class="hljs-keyword">enum</span> SyncPriority {
  low,      <span class="hljs-comment">// 低优先级</span>
  normal,   <span class="hljs-comment">// 普通优先级</span>
  high,     <span class="hljs-comment">// 高优先级</span>
  critical  <span class="hljs-comment">// 关键优先级</span>
}
</code></pre>
<h3 id="远程指令模型">远程指令模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RemoteCommand</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> CommandType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; parameters;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> sourceDeviceId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> targetDeviceId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> requiresConfirmation;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> timeout;
}

<span class="hljs-keyword">enum</span> CommandType {
  vehicleControl,    <span class="hljs-comment">// 车辆控制</span>
  mediaControl,      <span class="hljs-comment">// 媒体控制</span>
  navigationControl, <span class="hljs-comment">// 导航控制</span>
  appControl,        <span class="hljs-comment">// 应用控制</span>
  systemControl,     <span class="hljs-comment">// 系统控制</span>
  dataRequest        <span class="hljs-comment">// 数据请求</span>
}
</code></pre>
<h2 id="api-接口">API 接口</h2>
<h3 id="设备管理接口">设备管理接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionDeviceService</span> </span>{
  <span class="hljs-comment">// 发现附近设备</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">List</span>&lt;CompanionDevice&gt;&gt;&gt; discoverNearbyDevices();
  
  <span class="hljs-comment">// 配对设备</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; pairDevice(PairDeviceRequest request);
  
  <span class="hljs-comment">// 获取设备列表</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">List</span>&lt;CompanionDevice&gt;&gt;&gt; getDeviceList();
  
  <span class="hljs-comment">// 更新设备信息</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; updateDeviceInfo(UpdateDeviceRequest request);
}
</code></pre>
<h3 id="数据同步接口">数据同步接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionSyncService</span> </span>{
  <span class="hljs-comment">// 同步数据</span>
  Future&lt;ApiResponse&lt;SyncResult&gt;&gt; syncData(SyncDataRequest request);
  
  <span class="hljs-comment">// 获取同步状态</span>
  Future&lt;ApiResponse&lt;SyncStatus&gt;&gt; getSyncStatus(<span class="hljs-built_in">String</span> deviceId);
  
  <span class="hljs-comment">// 解决同步冲突</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; resolveConflict(ConflictResolutionRequest request);
}
</code></pre>
<h3 id="远程控制接口">远程控制接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionRemoteService</span> </span>{
  <span class="hljs-comment">// 发送远程命令</span>
  Future&lt;ApiResponse&lt;CommandResult&gt;&gt; sendRemoteCommand(RemoteCommandRequest request);
  
  <span class="hljs-comment">// 获取命令状态</span>
  Future&lt;ApiResponse&lt;CommandStatus&gt;&gt; getCommandStatus(<span class="hljs-built_in">String</span> commandId);
  
  <span class="hljs-comment">// 取消远程命令</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; cancelCommand(<span class="hljs-built_in">String</span> commandId);
}
</code></pre>
<h2 id="配置管理">配置管理</h2>
<h3 id="伴侣应用配置">伴侣应用配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanionConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> autoDiscovery;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> discoveryInterval;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxPairedDevices;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableRemoteControl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;SyncDataType&gt; enabledSyncTypes;
  <span class="hljs-keyword">final</span> SecurityLevel securityLevel;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> CompanionConfig defaultConfig = CompanionConfig(
    autoDiscovery: <span class="hljs-keyword">true</span>,
    discoveryInterval: <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">5</span>),
    maxPairedDevices: <span class="hljs-number">10</span>,
    enableRemoteControl: <span class="hljs-keyword">true</span>,
    enabledSyncTypes: [
      SyncDataType.userPreferences,
      SyncDataType.vehicleStatus,
      SyncDataType.mediaPlaylist,
    ],
    securityLevel: SecurityLevel.high,
  );
}
</code></pre>
<h3 id="同步配置">同步配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SyncConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableRealTimeSync;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> syncInterval;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxSyncRetries;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableIncrementalSync;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;SyncDataType, SyncSettings&gt; typeSettings;
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> SyncConfig defaultSyncConfig = SyncConfig(
    enableRealTimeSync: <span class="hljs-keyword">true</span>,
    syncInterval: <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">1</span>),
    maxSyncRetries: <span class="hljs-number">3</span>,
    enableIncrementalSync: <span class="hljs-keyword">true</span>,
    typeSettings: {
      SyncDataType.vehicleStatus: SyncSettings(priority: SyncPriority.high),
      SyncDataType.userPreferences: SyncSettings(priority: SyncPriority.normal),
    },
  );
}
</code></pre>
<h2 id="使用示例">使用示例</h2>
<h3 id="设备发现和配对">设备发现和配对</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 初始化伴侣应用管理器</span>
<span class="hljs-keyword">final</span> companionManager = CompanionDeviceManager.instance;
<span class="hljs-keyword">await</span> companionManager.initialize(CompanionConfig.defaultConfig);

<span class="hljs-comment">// 发现附近设备</span>
<span class="hljs-keyword">final</span> nearbyDevices = <span class="hljs-keyword">await</span> companionManager.discoverDevices();

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> device <span class="hljs-keyword">in</span> nearbyDevices) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;发现设备: <span class="hljs-subst">${device.name}</span> (<span class="hljs-subst">${device.type}</span>)&#x27;</span>);
  
  <span class="hljs-comment">// 配对兼容设备</span>
  <span class="hljs-keyword">if</span> (device.capabilities.containsKey(<span class="hljs-string">&#x27;oneapp_support&#x27;</span>)) {
    <span class="hljs-keyword">final</span> paired = <span class="hljs-keyword">await</span> companionManager.pairDevice(device.id);
    <span class="hljs-keyword">if</span> (paired) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;设备配对成功: <span class="hljs-subst">${device.name}</span>&#x27;</span>);
    }
  }
}

<span class="hljs-comment">// 监听设备状态变化</span>
companionManager.onDeviceStatusChanged.listen((device) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;设备状态变更: <span class="hljs-subst">${device.name}</span> -&gt; <span class="hljs-subst">${device.status}</span>&#x27;</span>);
});
</code></pre>
<h3 id="数据同步">数据同步</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 同步用户偏好到所有设备</span>
<span class="hljs-keyword">final</span> userPreferences = <span class="hljs-keyword">await</span> getUserPreferences();
<span class="hljs-keyword">final</span> syncData = SyncData(
  id: <span class="hljs-string">&#x27;user_prefs_<span class="hljs-subst">${DateTime.now().millisecondsSinceEpoch}</span>&#x27;</span>,
  type: SyncDataType.userPreferences,
  data: userPreferences.toJson(),
  timestamp: <span class="hljs-built_in">DateTime</span>.now(),
  priority: SyncPriority.normal,
);

<span class="hljs-keyword">final</span> pairedDevices = <span class="hljs-keyword">await</span> companionManager.getPairedDevices();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> device <span class="hljs-keyword">in</span> pairedDevices) {
  <span class="hljs-keyword">if</span> (device.status == DeviceStatus.online) {
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> CompanionDataSynchronizer.instance.syncToDevice(device.id, syncData);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;同步到 <span class="hljs-subst">${device.name}</span>: <span class="hljs-subst">${result.isSuccess}</span>&#x27;</span>);
  }
}

<span class="hljs-comment">// 监听同步状态</span>
CompanionDataSynchronizer.instance.onSyncProgress.listen((progress) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;同步进度: <span class="hljs-subst">${progress.percentage}</span>%&#x27;</span>);
});
</code></pre>
<h3 id="远程控制">远程控制</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 远程启动车辆</span>
<span class="hljs-keyword">final</span> startEngineCommand = RemoteCommand(
  id: <span class="hljs-string">&#x27;start_engine_<span class="hljs-subst">${DateTime.now().millisecondsSinceEpoch}</span>&#x27;</span>,
  type: CommandType.vehicleControl,
  parameters: {
    <span class="hljs-string">&#x27;action&#x27;</span>: <span class="hljs-string">&#x27;start_engine&#x27;</span>,
    <span class="hljs-string">&#x27;duration&#x27;</span>: <span class="hljs-number">300</span>, <span class="hljs-comment">// 5分钟</span>
  },
  sourceDeviceId: <span class="hljs-string">&#x27;smartphone_001&#x27;</span>,
  targetDeviceId: <span class="hljs-string">&#x27;car_display_001&#x27;</span>,
  requiresConfirmation: <span class="hljs-keyword">true</span>,
  timeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>),
);

<span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> CompanionRemoteController.instance.sendCommand(
  <span class="hljs-string">&#x27;car_display_001&#x27;</span>,
  startEngineCommand,
);

<span class="hljs-keyword">if</span> (result.isSuccess) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;远程启动指令发送成功&#x27;</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;远程启动失败: <span class="hljs-subst">${result.error}</span>&#x27;</span>);
}

<span class="hljs-comment">// 监听远程指令</span>
CompanionRemoteController.instance.listenForCommands().listen((command) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;收到远程指令: <span class="hljs-subst">${command.type}</span>&#x27;</span>);
  <span class="hljs-comment">// 处理远程指令</span>
  handleRemoteCommand(command);
});
</code></pre>
<h3 id="连接管理">连接管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 监控设备连接状态</span>
<span class="hljs-keyword">final</span> connectionManager = CompanionConnectionManager.instance;

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> device <span class="hljs-keyword">in</span> pairedDevices) {
  connectionManager.monitorConnection(device.id).listen((status) {
    <span class="hljs-keyword">switch</span> (status.state) {
      <span class="hljs-keyword">case</span> ConnectionState.connected:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">${device.name}</span> 已连接&#x27;</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> ConnectionState.disconnected:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">${device.name}</span> 已断开，尝试重连...&#x27;</span>);
        connectionManager.reconnectDevice(device.id);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> ConnectionState.error:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">${device.name}</span> 连接错误: <span class="hljs-subst">${status.error}</span>&#x27;</span>);
        <span class="hljs-keyword">break</span>;
    }
  });
}
</code></pre>
<h2 id="测试策略">测试策略</h2>
<h3 id="单元测试">单元测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;CompanionDevice Tests&#x27;</span>, () {
  test(<span class="hljs-string">&#x27;should discover nearby devices&#x27;</span>, () <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Given</span>
    <span class="hljs-keyword">final</span> deviceManager = CompanionDeviceManager();
    
    <span class="hljs-comment">// When</span>
    <span class="hljs-keyword">final</span> devices = <span class="hljs-keyword">await</span> deviceManager.discoverDevices();
    
    <span class="hljs-comment">// Then</span>
    expect(devices, isNotEmpty);
    expect(devices.first.type, isA&lt;DeviceType&gt;());
  });
  
  test(<span class="hljs-string">&#x27;should sync data successfully&#x27;</span>, () <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// Given</span>
    <span class="hljs-keyword">final</span> synchronizer = CompanionDataSynchronizer();
    <span class="hljs-keyword">final</span> syncData = SyncData(
      id: <span class="hljs-string">&#x27;test_sync&#x27;</span>,
      type: SyncDataType.userPreferences,
      data: {<span class="hljs-string">&#x27;theme&#x27;</span>: <span class="hljs-string">&#x27;dark&#x27;</span>},
      timestamp: <span class="hljs-built_in">DateTime</span>.now(),
      priority: SyncPriority.normal,
    );
    
    <span class="hljs-comment">// When</span>
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> synchronizer.syncToDevice(<span class="hljs-string">&#x27;test_device&#x27;</span>, syncData);
    
    <span class="hljs-comment">// Then</span>
    expect(result.isSuccess, <span class="hljs-keyword">true</span>);
  });
});
</code></pre>
<h3 id="集成测试">集成测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;Companion Integration Tests&#x27;</span>, () {
  testWidgets(<span class="hljs-string">&#x27;device pairing flow&#x27;</span>, (tester) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 1. 启动设备发现</span>
    <span class="hljs-keyword">await</span> CompanionDeviceManager.instance.startDiscovery();
    
    <span class="hljs-comment">// 2. 模拟发现设备</span>
    <span class="hljs-keyword">final</span> mockDevice = createMockDevice();
    <span class="hljs-keyword">await</span> simulateDeviceDiscovered(mockDevice);
    
    <span class="hljs-comment">// 3. 执行配对</span>
    <span class="hljs-keyword">final</span> paired = <span class="hljs-keyword">await</span> CompanionDeviceManager.instance.pairDevice(mockDevice.id);
    
    <span class="hljs-comment">// 4. 验证配对结果</span>
    expect(paired, <span class="hljs-keyword">true</span>);
    
    <span class="hljs-keyword">final</span> pairedDevices = <span class="hljs-keyword">await</span> CompanionDeviceManager.instance.getPairedDevices();
    expect(pairedDevices, contains(mockDevice));
  });
});
</code></pre>
<h2 id="性能优化">性能优化</h2>
<h3 id="连接优化">连接优化</h3>
<ul>
<li><strong>连接池</strong>：设备连接池管理</li>
<li><strong>心跳机制</strong>：定期心跳保持连接</li>
<li><strong>重连策略</strong>：智能重连机制</li>
<li><strong>负载均衡</strong>：多设备负载均衡</li>
</ul>
<h3 id="同步优化">同步优化</h3>
<ul>
<li><strong>增量同步</strong>：只同步变化的数据</li>
<li><strong>压缩传输</strong>：数据压缩减少传输量</li>
<li><strong>批量操作</strong>：批量同步提高效率</li>
<li><strong>优先级队列</strong>：按优先级处理同步任务</li>
</ul>
<h2 id="安全考虑">安全考虑</h2>
<h3 id="设备安全">设备安全</h3>
<ul>
<li><strong>设备认证</strong>：设备身份认证和授权</li>
<li><strong>加密通信</strong>：端到端加密通信</li>
<li><strong>权限控制</strong>：细粒度权限控制</li>
<li><strong>安全审计</strong>：操作安全审计日志</li>
</ul>
<h3 id="数据安全">数据安全</h3>
<ul>
<li><strong>数据加密</strong>：敏感数据加密存储和传输</li>
<li><strong>访问控制</strong>：基于角色的数据访问控制</li>
<li><strong>数据完整性</strong>：数据完整性验证</li>
<li><strong>隐私保护</strong>：用户隐私数据保护</li>
</ul>
<h2 id="版本历史">版本历史</h2>
<h3 id="v007-当前版本">v0.0.7 (当前版本)</h3>
<ul>
<li>新增智能手表支持</li>
<li>优化设备发现性能</li>
<li>支持批量数据同步</li>
<li>修复连接稳定性问题</li>
</ul>
<h3 id="v006">v0.0.6</h3>
<ul>
<li>支持车载设备连接</li>
<li>新增远程控制功能</li>
<li>优化同步机制</li>
<li>改进设备管理界面</li>
</ul>
<h2 id="依赖关系">依赖关系</h2>
<h3 id="内部依赖">内部依赖</h3>
<ul>
<li><code>basic_platform</code>: 平台抽象层</li>
<li><code>basic_network</code>: 网络通信服务</li>
<li><code>basic_storage</code>: 本地存储服务</li>
<li><code>basic_security</code>: 安全服务</li>
</ul>
<h3 id="外部依赖">外部依赖</h3>
<ul>
<li><code>nearby_connections</code>: 设备发现和连接</li>
<li><code>encrypt</code>: 数据加密</li>
<li><code>rxdart</code>: 响应式编程</li>
<li><code>shared_preferences</code>: 配置存储</li>
</ul>
<h2 id="总结">总结</h2>
<p><code>oneapp_companion</code> 模块为 OneApp 提供了完整的多设备协同解决方案。通过设备发现、数据同步、远程控制和连接管理等功能，该模块实现了跨设备的无缝体验，让用户能够在不同设备间自由切换，享受一致的应用体验和便捷的远程控制功能。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>