<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>App Charging - &#x5145;&#x7535;&#x7ba1;&#x7406;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="app-charging---充电管理模块文档">App Charging - 充电管理模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>app_charging</code> 是 OneApp 的充电管理核心模块，提供完整的电动车充电功能，包括充电桩查找、充电状态监控、充电历史记录、支付结算等全流程充电服务。该模块集成了地图服务、二维码扫描、支付功能等，为用户提供便捷的充电体验。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: app_charging</li>
<li><strong>版本</strong>: 0.3.13</li>
<li><strong>仓库</strong>: <a href="https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-charging">https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-charging</a></li>
<li><strong>Flutter 版本</strong>: &gt;=2.10.5</li>
<li><strong>Dart 版本</strong>: &gt;=2.17.0 &lt;4.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>app_charging/
├── lib/
│   ├── app_charging.dart         # 主导出文件
│   ├── generated/                # 代码生成文件
│   ├── l10n/                     # 国际化文件
│   └── src/                      # 源代码目录
│       ├── app_charging_module.dart # 充电模块配置
│       ├── blocs/                # 状态管理（BLoC）
│       ├── carfinder/            # 车辆查找功能
│       ├── constants/            # 常量定义
│       ├── pages/                # 页面组件
│       ├── utils/                # 工具类
│       ├── route_dp.dart         # 路由配置
│       ├── route_export.dart     # 路由导出
│       └── switch_vehicle.dart   # 车辆切换功能
├── assets/                       # 静态资源
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-充电桩查找与导航">1. 充电桩查找与导航</h3>
<h4 id="地图集成充电桩搜索">地图集成充电桩搜索</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电桩查找服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingStationFinder</span> </span>{
  <span class="hljs-keyword">final</span> GeoService _geoService;
  <span class="hljs-keyword">final</span> ChargingService _chargingService;
  
  ChargingStationFinder(<span class="hljs-keyword">this</span>._geoService, <span class="hljs-keyword">this</span>._chargingService);
  
  <span class="hljs-comment">// 搜索附近充电桩</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;ChargingStation&gt;&gt;&gt; findNearbyStations({
    <span class="hljs-keyword">required</span> LatLng location,
    <span class="hljs-built_in">double</span> radiusKm = <span class="hljs-number">5.0</span>,
    ChargingStationType? type,
    <span class="hljs-built_in">bool</span> onlyAvailable = <span class="hljs-keyword">false</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> stations = <span class="hljs-keyword">await</span> _chargingService.searchStations(
        location: location,
        radius: radiusKm,
        type: type,
        availableOnly: onlyAvailable,
      );
      
      <span class="hljs-keyword">return</span> Right(stations);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.searchFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 规划充电路线</span>
  Future&lt;Result&lt;ChargingRoute&gt;&gt; planChargingRoute({
    <span class="hljs-keyword">required</span> LatLng origin,
    <span class="hljs-keyword">required</span> LatLng destination,
    <span class="hljs-keyword">required</span> VehicleBatteryStatus batteryStatus,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 计算路线所需充电点</span>
    <span class="hljs-keyword">final</span> routeDistance = <span class="hljs-keyword">await</span> _geoService.calculateDistance(origin, destination);
    <span class="hljs-keyword">final</span> requiredCharging = _calculateChargingNeeds(routeDistance, batteryStatus);
    
    <span class="hljs-keyword">if</span> (!requiredCharging.needsCharging) {
      <span class="hljs-keyword">return</span> Right(ChargingRoute.direct(origin, destination));
    }
    
    <span class="hljs-comment">// 查找路线上的充电桩</span>
    <span class="hljs-keyword">final</span> waypoints = <span class="hljs-keyword">await</span> _findChargingWaypoints(
      origin: origin,
      destination: destination,
      chargingNeeds: requiredCharging,
    );
    
    <span class="hljs-keyword">return</span> Right(ChargingRoute.withCharging(origin, destination, waypoints));
  }
}
</code></pre>
<h4 id="充电桩详情与状态">充电桩详情与状态</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电桩状态模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingStation</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> address;
  <span class="hljs-keyword">final</span> LatLng location;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;ChargingPoint&gt; chargingPoints;
  <span class="hljs-keyword">final</span> StationOperator <span class="hljs-keyword">operator</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rating;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; amenities;
  <span class="hljs-keyword">final</span> StationStatus status;
  <span class="hljs-keyword">final</span> PricingInfo pricing;
  
  <span class="hljs-keyword">const</span> ChargingStation({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.address,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.location,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.chargingPoints,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.<span class="hljs-keyword">operator</span>,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.rating,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.amenities,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pricing,
  });
  
  <span class="hljs-comment">// 获取可用充电桩数量</span>
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> availablePointsCount =&gt; chargingPoints
      .where((point) =&gt; point.status == ChargingPointStatus.available)
      .length;
  
  <span class="hljs-comment">// 获取最大充电功率</span>
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> maxPower =&gt; chargingPoints
      .map((point) =&gt; point.maxPower)
      .reduce(math.max);
  
  <span class="hljs-comment">// 是否支持快充</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> supportsFastCharging =&gt; chargingPoints
      .any((point) =&gt; point.type == ChargingPointType.dcFast);
}

<span class="hljs-comment">// 充电桩充电点</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingPoint</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> ChargingPointType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maxPower;
  <span class="hljs-keyword">final</span> ChargingPointStatus status;
  <span class="hljs-keyword">final</span> ConnectorType connectorType;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> pricePerKwh;
  <span class="hljs-keyword">final</span> EstimatedChargingTime? estimatedTime;
  
  <span class="hljs-keyword">const</span> ChargingPoint({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.maxPower,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.connectorType,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pricePerKwh,
    <span class="hljs-keyword">this</span>.estimatedTime,
  });
}
</code></pre>
<h3 id="2-充电会话管理">2. 充电会话管理</h3>
<h4 id="充电启动与控制">充电启动与控制</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电会话管理服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingSessionManager</span> </span>{
  <span class="hljs-keyword">final</span> ChargingService _chargingService;
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  
  ChargingSessionManager(<span class="hljs-keyword">this</span>._chargingService, <span class="hljs-keyword">this</span>._paymentService);
  
  <span class="hljs-comment">// 启动充电会话</span>
  Future&lt;Result&lt;ChargingSession&gt;&gt; startChargingSession({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> stationId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> pointId,
    <span class="hljs-keyword">required</span> PaymentMethod paymentMethod,
    ChargingTarget? target,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 验证充电桩可用性</span>
      <span class="hljs-keyword">final</span> pointStatus = <span class="hljs-keyword">await</span> _chargingService.getPointStatus(pointId);
      <span class="hljs-keyword">if</span> (pointStatus.status != ChargingPointStatus.available) {
        <span class="hljs-keyword">return</span> Left(ChargingFailure.pointUnavailable());
      }
      
      <span class="hljs-comment">// 2. 预授权支付</span>
      <span class="hljs-keyword">final</span> paymentAuth = <span class="hljs-keyword">await</span> _paymentService.authorizePayment(
        paymentMethod: paymentMethod,
        estimatedAmount: _calculateEstimatedCost(target, pointStatus),
      );
      
      <span class="hljs-keyword">if</span> (paymentAuth.isLeft()) {
        <span class="hljs-keyword">return</span> Left(ChargingFailure.paymentFailed());
      }
      
      <span class="hljs-comment">// 3. 启动充电</span>
      <span class="hljs-keyword">final</span> session = <span class="hljs-keyword">await</span> _chargingService.startCharging(
        pointId: pointId,
        paymentAuthId: paymentAuth.getOrElse(() =&gt; <span class="hljs-string">&#x27;&#x27;</span>),
        target: target,
      );
      
      <span class="hljs-keyword">return</span> Right(session);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.sessionStartFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 停止充电会话</span>
  Future&lt;Result&lt;ChargingSessionSummary&gt;&gt; stopChargingSession(
    <span class="hljs-built_in">String</span> sessionId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> session = <span class="hljs-keyword">await</span> _chargingService.stopCharging(sessionId);
      
      <span class="hljs-comment">// 处理支付结算</span>
      <span class="hljs-keyword">final</span> payment = <span class="hljs-keyword">await</span> _paymentService.processPayment(
        sessionId: sessionId,
        amount: session.totalCost,
      );
      
      <span class="hljs-keyword">return</span> Right(ChargingSessionSummary.fromSession(session, payment));
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.sessionStopFailed(e.toString()));
    }
  }
}
</code></pre>
<h4 id="充电状态监控">充电状态监控</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电会话实时状态</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingSession</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> stationId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> pointId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> startTime;
  <span class="hljs-keyword">final</span> ChargingSessionStatus status;
  <span class="hljs-keyword">final</span> ChargingProgress progress;
  <span class="hljs-keyword">final</span> ChargingTarget target;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> currentCost;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> estimatedTimeRemaining;
  
  <span class="hljs-keyword">const</span> ChargingSession({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.stationId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pointId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.startTime,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.progress,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.target,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.currentCost,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.estimatedTimeRemaining,
  });
  
  <span class="hljs-comment">// 充电进度百分比</span>
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> progressPercentage {
    <span class="hljs-keyword">switch</span> (target.type) {
      <span class="hljs-keyword">case</span> ChargingTargetType.percentage:
        <span class="hljs-keyword">return</span> (progress.currentPercentage - progress.startPercentage) /
               (target.targetPercentage! - progress.startPercentage);
      <span class="hljs-keyword">case</span> ChargingTargetType.energy:
        <span class="hljs-keyword">return</span> progress.energyDelivered / target.targetEnergy!;
      <span class="hljs-keyword">case</span> ChargingTargetType.time:
        <span class="hljs-keyword">final</span> elapsed = <span class="hljs-built_in">DateTime</span>.now().difference(startTime);
        <span class="hljs-keyword">return</span> elapsed.inMinutes / target.targetMinutes!;
    }
  }
}

<span class="hljs-comment">// 充电进度信息</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingProgress</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> startPercentage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> currentPercentage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> energyDelivered; <span class="hljs-comment">// kWh</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> currentPower; <span class="hljs-comment">// kW</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> averagePower; <span class="hljs-comment">// kW</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> chargingTime;
  
  <span class="hljs-keyword">const</span> ChargingProgress({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.startPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.currentPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.energyDelivered,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.currentPower,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.averagePower,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.chargingTime,
  });
}
</code></pre>
<h3 id="3-二维码扫描启动充电">3. 二维码扫描启动充电</h3>
<h4 id="扫码充电服务">扫码充电服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 二维码充电启动服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QRCodeChargingService</span> </span>{
  <span class="hljs-keyword">final</span> ScanKitService _scanService;
  <span class="hljs-keyword">final</span> ChargingSessionManager _sessionManager;
  
  QRCodeChargingService(<span class="hljs-keyword">this</span>._scanService, <span class="hljs-keyword">this</span>._sessionManager);
  
  <span class="hljs-comment">// 扫描充电桩二维码</span>
  Future&lt;Result&lt;ChargingPointInfo&gt;&gt; scanChargingPoint() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> scanResult = <span class="hljs-keyword">await</span> _scanService.startScan();
      
      <span class="hljs-keyword">if</span> (scanResult.isSuccess) {
        <span class="hljs-keyword">final</span> qrData = scanResult.code;
        <span class="hljs-keyword">final</span> pointInfo = <span class="hljs-keyword">await</span> _parseChargingQRCode(qrData);
        <span class="hljs-keyword">return</span> Right(pointInfo);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> Left(ChargingFailure.scanFailed());
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.scanError(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 解析充电桩二维码</span>
  Future&lt;ChargingPointInfo&gt; _parseChargingQRCode(<span class="hljs-built_in">String</span> qrData) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// QR码格式：charging://station/{stationId}/point/{pointId}</span>
    <span class="hljs-keyword">final</span> uri = <span class="hljs-built_in">Uri</span>.parse(qrData);
    
    <span class="hljs-keyword">if</span> (uri.scheme != <span class="hljs-string">&#x27;charging&#x27;</span>) {
      <span class="hljs-keyword">throw</span> ChargingException(<span class="hljs-string">&#x27;无效的充电桩二维码&#x27;</span>);
    }
    
    <span class="hljs-keyword">final</span> pathSegments = uri.pathSegments;
    <span class="hljs-keyword">if</span> (pathSegments.length &lt; <span class="hljs-number">4</span> || 
        pathSegments[<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;station&#x27;</span> || 
        pathSegments[<span class="hljs-number">2</span>] != <span class="hljs-string">&#x27;point&#x27;</span>) {
      <span class="hljs-keyword">throw</span> ChargingException(<span class="hljs-string">&#x27;二维码格式错误&#x27;</span>);
    }
    
    <span class="hljs-keyword">final</span> stationId = pathSegments[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">final</span> pointId = pathSegments[<span class="hljs-number">3</span>];
    
    <span class="hljs-comment">// 获取充电桩详细信息</span>
    <span class="hljs-keyword">final</span> stationInfo = <span class="hljs-keyword">await</span> _chargingService.getStationInfo(stationId);
    <span class="hljs-keyword">final</span> pointInfo = stationInfo.chargingPoints
        .firstWhere((point) =&gt; point.id == pointId);
    
    <span class="hljs-keyword">return</span> ChargingPointInfo(
      stationId: stationId,
      pointId: pointId,
      station: stationInfo,
      point: pointInfo,
    );
  }
  
  <span class="hljs-comment">// 通过扫码启动充电</span>
  Future&lt;Result&lt;ChargingSession&gt;&gt; startChargingFromQR(
    ChargingPointInfo pointInfo,
    PaymentMethod paymentMethod,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _sessionManager.startChargingSession(
      stationId: pointInfo.stationId,
      pointId: pointInfo.pointId,
      paymentMethod: paymentMethod,
    );
  }
}
</code></pre>
<h3 id="4-充电历史与统计">4. 充电历史与统计</h3>
<h4 id="充电记录管理">充电记录管理</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电历史记录服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingHistoryService</span> </span>{
  <span class="hljs-keyword">final</span> ChargingService _chargingService;
  <span class="hljs-keyword">final</span> StorageService _storageService;
  
  ChargingHistoryService(<span class="hljs-keyword">this</span>._chargingService, <span class="hljs-keyword">this</span>._storageService);
  
  <span class="hljs-comment">// 获取充电历史记录</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;ChargingRecord&gt;&gt;&gt; getChargingHistory({
    DateRange? dateRange,
    <span class="hljs-built_in">String?</span> stationId,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> records = <span class="hljs-keyword">await</span> _chargingService.getChargingRecords(
        startDate: dateRange?.start,
        endDate: dateRange?.end,
        stationId: stationId,
        page: page,
        pageSize: pageSize,
      );
      
      <span class="hljs-comment">// 缓存到本地</span>
      <span class="hljs-keyword">await</span> _cacheChargingRecords(records);
      
      <span class="hljs-keyword">return</span> Right(records);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 尝试从缓存加载</span>
      <span class="hljs-keyword">final</span> cachedRecords = <span class="hljs-keyword">await</span> _loadCachedRecords();
      <span class="hljs-keyword">if</span> (cachedRecords.isNotEmpty) {
        <span class="hljs-keyword">return</span> Right(cachedRecords);
      }
      <span class="hljs-keyword">return</span> Left(ChargingFailure.historyLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取充电统计信息</span>
  Future&lt;Result&lt;ChargingStatistics&gt;&gt; getChargingStatistics({
    <span class="hljs-keyword">required</span> StatisticsPeriod period,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> stats = <span class="hljs-keyword">await</span> _chargingService.getChargingStatistics(period);
      <span class="hljs-keyword">return</span> Right(stats);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.statisticsLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 充电记录模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingRecord</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> sessionId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> stationName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> stationAddress;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> startTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> endTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> energyDelivered;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalCost;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> startPercentage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> endPercentage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> chargingDuration;
  <span class="hljs-keyword">final</span> PaymentMethod paymentMethod;
  <span class="hljs-keyword">final</span> ChargingRecordStatus status;
  
  <span class="hljs-keyword">const</span> ChargingRecord({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.sessionId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.stationName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.stationAddress,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.startTime,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.endTime,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.energyDelivered,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalCost,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.startPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.endPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.chargingDuration,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.paymentMethod,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
  });
  
  <span class="hljs-comment">// 计算平均充电功率</span>
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> averagePower =&gt; energyDelivered / (chargingDuration.inHours);
  
  <span class="hljs-comment">// 计算单位能量成本</span>
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> costPerKwh =&gt; totalCost / energyDelivered;
}
</code></pre>
<h3 id="5-充电支付管理">5. 充电支付管理</h3>
<h4 id="支付方式与结算">支付方式与结算</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 充电支付服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingPaymentService</span> </span>{
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  <span class="hljs-keyword">final</span> ChargingService _chargingService;
  
  ChargingPaymentService(<span class="hljs-keyword">this</span>._paymentService, <span class="hljs-keyword">this</span>._chargingService);
  
  <span class="hljs-comment">// 获取可用支付方式</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;PaymentMethod&gt;&gt;&gt; getAvailablePaymentMethods() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> methods = <span class="hljs-keyword">await</span> _paymentService.getPaymentMethods();
      <span class="hljs-comment">// 过滤支持充电的支付方式</span>
      <span class="hljs-keyword">final</span> chargingMethods = methods
          .where((method) =&gt; method.supportsCharging)
          .toList();
      <span class="hljs-keyword">return</span> Right(chargingMethods);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PaymentFailure.methodsLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 处理充电支付</span>
  Future&lt;Result&lt;PaymentResult&gt;&gt; processChargingPayment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> sessionId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> amount,
    <span class="hljs-keyword">required</span> PaymentMethod paymentMethod,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> paymentResult = <span class="hljs-keyword">await</span> _paymentService.processPayment(
        amount: amount,
        paymentMethod: paymentMethod,
        description: <span class="hljs-string">&#x27;充电服务费用&#x27;</span>,
        metadata: {<span class="hljs-string">&#x27;session_id&#x27;</span>: sessionId, <span class="hljs-string">&#x27;type&#x27;</span>: <span class="hljs-string">&#x27;charging&#x27;</span>},
      );
      
      <span class="hljs-keyword">if</span> (paymentResult.isSuccess) {
        <span class="hljs-comment">// 更新充电会话支付状态</span>
        <span class="hljs-keyword">await</span> _chargingService.updateSessionPaymentStatus(
          sessionId: sessionId,
          paymentId: paymentResult.paymentId,
          status: PaymentStatus.completed,
        );
      }
      
      <span class="hljs-keyword">return</span> Right(paymentResult);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PaymentFailure.processingFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 处理充电退款</span>
  Future&lt;Result&lt;RefundResult&gt;&gt; processChargingRefund({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> sessionId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> reason,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> session = <span class="hljs-keyword">await</span> _chargingService.getSessionDetails(sessionId);
      
      <span class="hljs-keyword">if</span> (session.paymentStatus != PaymentStatus.completed) {
        <span class="hljs-keyword">return</span> Left(PaymentFailure.invalidRefundState());
      }
      
      <span class="hljs-keyword">final</span> refundResult = <span class="hljs-keyword">await</span> _paymentService.processRefund(
        paymentId: session.paymentId!,
        amount: session.totalCost,
        reason: reason,
      );
      
      <span class="hljs-keyword">return</span> Right(refundResult);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PaymentFailure.refundFailed(e.toString()));
    }
  }
}
</code></pre>
<h2 id="状态管理-blocs">状态管理 (<code>blocs/</code>)</h2>
<h3 id="充电桩搜索-bloc">充电桩搜索 BLoC</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电桩搜索状态管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingStationBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">ChargingStationEvent</span>, <span class="hljs-title">ChargingStationState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> ChargingStationFinder _stationFinder;
  <span class="hljs-keyword">final</span> GeoService _geoService;
  
  ChargingStationBloc(<span class="hljs-keyword">this</span>._stationFinder, <span class="hljs-keyword">this</span>._geoService) 
      : <span class="hljs-keyword">super</span>(ChargingStationInitial()) {
    <span class="hljs-keyword">on</span>&lt;SearchNearbyStations&gt;(_onSearchNearbyStations);
    <span class="hljs-keyword">on</span>&lt;SearchStationsByKeyword&gt;(_onSearchStationsByKeyword);
    <span class="hljs-keyword">on</span>&lt;FilterStations&gt;(_onFilterStations);
    <span class="hljs-keyword">on</span>&lt;UpdateUserLocation&gt;(_onUpdateUserLocation);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onSearchNearbyStations(
    SearchNearbyStations event,
    Emitter&lt;ChargingStationState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(ChargingStationLoading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _stationFinder.findNearbyStations(
      location: event.location,
      radiusKm: event.radiusKm,
      type: event.stationType,
      onlyAvailable: event.onlyAvailable,
    );
    
    result.fold(
      (failure) =&gt; emit(ChargingStationError(failure.message)),
      (stations) =&gt; emit(ChargingStationLoaded(
        stations: stations,
        userLocation: event.location,
      )),
    );
  }
}

<span class="hljs-comment">// 充电会话 BLoC</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingSessionBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">ChargingSessionEvent</span>, <span class="hljs-title">ChargingSessionState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> ChargingSessionManager _sessionManager;
  Timer? _statusUpdateTimer;
  
  ChargingSessionBloc(<span class="hljs-keyword">this</span>._sessionManager) : <span class="hljs-keyword">super</span>(ChargingSessionInitial()) {
    <span class="hljs-keyword">on</span>&lt;StartChargingSession&gt;(_onStartChargingSession);
    <span class="hljs-keyword">on</span>&lt;StopChargingSession&gt;(_onStopChargingSession);
    <span class="hljs-keyword">on</span>&lt;UpdateChargingProgress&gt;(_onUpdateChargingProgress);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onStartChargingSession(
    StartChargingSession event,
    Emitter&lt;ChargingSessionState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(ChargingSessionStarting());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _sessionManager.startChargingSession(
      stationId: event.stationId,
      pointId: event.pointId,
      paymentMethod: event.paymentMethod,
      target: event.target,
    );
    
    result.fold(
      (failure) =&gt; emit(ChargingSessionError(failure.message)),
      (session) {
        emit(ChargingSessionActive(session));
        _startStatusUpdates(session.id);
      },
    );
  }
  
  <span class="hljs-keyword">void</span> _startStatusUpdates(<span class="hljs-built_in">String</span> sessionId) {
    _statusUpdateTimer = Timer.periodic(
      <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      (_) =&gt; add(UpdateChargingProgress(sessionId)),
    );
  }
}
</code></pre>
<h2 id="页面组件-pages">页面组件 (<code>pages/</code>)</h2>
<h3 id="充电桩地图页面">充电桩地图页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电桩地图页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingStationMapPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _ChargingStationMapPageState createState() =&gt; _ChargingStationMapPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ChargingStationMapPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ChargingStationMapPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> AMapController _mapController;
  <span class="hljs-keyword">late</span> ChargingStationBloc _stationBloc;
  LatLng? _userLocation;
  <span class="hljs-built_in">List</span>&lt;ChargingStation&gt; _stations = [];
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _stationBloc = context.read&lt;ChargingStationBloc&gt;();
    _getUserLocationAndSearch();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: Stack(
        children: [
          _buildMap(),
          _buildSearchBar(),
          _buildFilterButton(),
          _buildStationList(),
        ],
      ),
      floatingActionButton: _buildLocationButton(),
    );
  }
  
  Widget _buildMap() {
    <span class="hljs-keyword">return</span> AMapWidget(
      onMapCreated: (controller) {
        _mapController = controller;
        _setupMapStyle();
      },
      markers: _buildStationMarkers(),
      onTap: _onMapTap,
    );
  }
  
  <span class="hljs-built_in">Set</span>&lt;Marker&gt; _buildStationMarkers() {
    <span class="hljs-keyword">return</span> _stations.map((station) {
      <span class="hljs-keyword">return</span> Marker(
        markerId: MarkerId(station.id),
        position: station.location,
        icon: _getStationIcon(station),
        onTap: () =&gt; _showStationDetails(station),
        infoWindow: InfoWindow(
          title: station.name,
          snippet: <span class="hljs-string">&#x27;<span class="hljs-subst">${station.availablePointsCount}</span>个可用充电桩&#x27;</span>,
        ),
      );
    }).toSet();
  }
  
  <span class="hljs-keyword">void</span> _showStationDetails(ChargingStation station) {
    showModalBottomSheet(
      context: context,
      builder: (context) =&gt; ChargingStationDetailSheet(station: station),
    );
  }
}
</code></pre>
<h3 id="充电会话页面">充电会话页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电会话监控页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingSessionPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> sessionId;
  
  <span class="hljs-keyword">const</span> ChargingSessionPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.sessionId});
  
  <span class="hljs-meta">@override</span>
  _ChargingSessionPageState createState() =&gt; _ChargingSessionPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ChargingSessionPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ChargingSessionPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> ChargingSessionBloc _sessionBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _sessionBloc = context.read&lt;ChargingSessionBloc&gt;();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">&#x27;充电中&#x27;</span>)),
      body: BlocBuilder&lt;ChargingSessionBloc, ChargingSessionState&gt;(
        builder: (context, state) {
          <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> ChargingSessionActive) {
            <span class="hljs-keyword">return</span> _buildActiveSession(state.session);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> ChargingSessionError) {
            <span class="hljs-keyword">return</span> _buildErrorState(state.message);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> _buildLoadingState();
          }
        },
      ),
    );
  }
  
  Widget _buildActiveSession(ChargingSession session) {
    <span class="hljs-keyword">return</span> SingleChildScrollView(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildProgressCard(session),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildSessionInfo(session),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildCostInfo(session),
          SizedBox(height: <span class="hljs-number">24</span>),
          _buildStopButton(session),
        ],
      ),
    );
  }
  
  Widget _buildProgressCard(ChargingSession session) {
    <span class="hljs-keyword">return</span> Card(
      child: Padding(
        padding: EdgeInsets.all(<span class="hljs-number">20</span>),
        child: Column(
          children: [
            CircularProgressIndicator(
              value: session.progressPercentage,
              strokeWidth: <span class="hljs-number">8</span>,
              backgroundColor: Colors.grey[<span class="hljs-number">300</span>],
            ),
            SizedBox(height: <span class="hljs-number">16</span>),
            Text(
              <span class="hljs-string">&#x27;<span class="hljs-subst">${(session.progressPercentage * <span class="hljs-number">100</span>).toInt()}</span>%&#x27;</span>,
              style: Theme.of(context).textTheme.headlineMedium,
            ),
            Text(
              <span class="hljs-string">&#x27;预计剩余 <span class="hljs-subst">${session.estimatedTimeRemaining.inMinutes}</span> 分钟&#x27;</span>,
              style: Theme.of(context).textTheme.bodyMedium,
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h2 id="车辆查找集成-carfinder">车辆查找集成 (<code>carfinder/</code>)</h2>
<h3 id="充电时车辆定位">充电时车辆定位</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电时车辆查找功能</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingCarFinder</span> </span>{
  <span class="hljs-keyword">final</span> CarFinderService _carFinderService;
  <span class="hljs-keyword">final</span> ChargingSessionManager _sessionManager;
  
  ChargingCarFinder(<span class="hljs-keyword">this</span>._carFinderService, <span class="hljs-keyword">this</span>._sessionManager);
  
  <span class="hljs-comment">// 获取充电中的车辆位置</span>
  Future&lt;Result&lt;VehicleLocation&gt;&gt; getChargingVehicleLocation(
    <span class="hljs-built_in">String</span> sessionId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> session = <span class="hljs-keyword">await</span> _sessionManager.getSessionDetails(sessionId);
      <span class="hljs-keyword">if</span> (session.status != ChargingSessionStatus.active) {
        <span class="hljs-keyword">return</span> Left(ChargingFailure.sessionNotActive());
      }
      
      <span class="hljs-comment">// 获取充电桩位置作为车辆位置</span>
      <span class="hljs-keyword">final</span> station = <span class="hljs-keyword">await</span> _chargingService.getStationInfo(session.stationId);
      <span class="hljs-keyword">final</span> point = station.chargingPoints
          .firstWhere((p) =&gt; p.id == session.pointId);
      
      <span class="hljs-keyword">return</span> Right(VehicleLocation(
        coordinates: station.location,
        accuracy: <span class="hljs-number">10.0</span>, <span class="hljs-comment">// 充电桩位置精度较高</span>
        timestamp: <span class="hljs-built_in">DateTime</span>.now(),
        isCharging: <span class="hljs-keyword">true</span>,
        chargingStationId: station.id,
        chargingPointId: point.id,
      ));
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(ChargingFailure.locationNotFound(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 闪灯提醒（充电时）</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; flashVehicleAtChargingStation(
    <span class="hljs-built_in">String</span> sessionId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 通过充电桩控制车辆闪灯</span>
      <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _chargingService.triggerVehicleAlert(sessionId);
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 回退到车辆直接控制</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _carFinderService.flashAndHonk();
    }
  }
}
</code></pre>
<h2 id="工具类-utils">工具类 (<code>utils/</code>)</h2>
<h3 id="充电计算工具">充电计算工具</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电相关计算工具</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingCalculations</span> </span>{
  <span class="hljs-comment">// 计算充电时间</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">Duration</span> calculateChargingTime({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> currentPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> targetPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> batteryCapacity, <span class="hljs-comment">// kWh</span>
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> chargingPower, <span class="hljs-comment">// kW</span>
    <span class="hljs-keyword">required</span> ChargingCurve? chargingCurve,
  }) {
    <span class="hljs-keyword">final</span> energyNeeded = (targetPercentage - currentPercentage) / <span class="hljs-number">100</span> * batteryCapacity;
    
    <span class="hljs-keyword">if</span> (chargingCurve != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> _calculateWithCurve(
        currentPercentage,
        targetPercentage,
        batteryCapacity,
        chargingCurve,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 简单线性计算</span>
      <span class="hljs-keyword">final</span> hours = energyNeeded / chargingPower;
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Duration</span>(minutes: (hours * <span class="hljs-number">60</span>).round());
    }
  }
  
  <span class="hljs-comment">// 计算充电成本</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> calculateChargingCost({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> energyDelivered,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> pricePerKwh,
    <span class="hljs-built_in">double?</span> serviceFee,
    <span class="hljs-built_in">double?</span> parkingFee,
  }) {
    <span class="hljs-built_in">double</span> totalCost = energyDelivered * pricePerKwh;
    
    <span class="hljs-keyword">if</span> (serviceFee != <span class="hljs-keyword">null</span>) {
      totalCost += serviceFee;
    }
    
    <span class="hljs-keyword">if</span> (parkingFee != <span class="hljs-keyword">null</span>) {
      totalCost += parkingFee;
    }
    
    <span class="hljs-keyword">return</span> totalCost;
  }
  
  <span class="hljs-comment">// 计算碳减排量</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> calculateCarbonSaved({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> energyDelivered,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> gridCarbonIntensity, <span class="hljs-comment">// kg CO2/kWh</span>
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> fuelCarbonIntensity, <span class="hljs-comment">// kg CO2/L</span>
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> vehicleEfficiency, <span class="hljs-comment">// km/kWh</span>
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> fuelEfficiency, <span class="hljs-comment">// km/L</span>
  }) {
    <span class="hljs-keyword">final</span> electricEmissions = energyDelivered * gridCarbonIntensity;
    <span class="hljs-keyword">final</span> distance = energyDelivered * vehicleEfficiency;
    <span class="hljs-keyword">final</span> fuelUsed = distance / fuelEfficiency;
    <span class="hljs-keyword">final</span> fuelEmissions = fuelUsed * fuelCarbonIntensity;
    
    <span class="hljs-keyword">return</span> fuelEmissions - electricEmissions;
  }
}
</code></pre>
<h2 id="常量定义-constants">常量定义 (<code>constants/</code>)</h2>
<h3 id="充电相关常量">充电相关常量</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电模块常量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingConstants</span> </span>{
  <span class="hljs-comment">// 充电桩类型</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">Map</span>&lt;ChargingPointType, <span class="hljs-built_in">String</span>&gt; chargingTypeNames = {
    ChargingPointType.acSlow: <span class="hljs-string">&#x27;AC 慢充&#x27;</span>,
    ChargingPointType.acFast: <span class="hljs-string">&#x27;AC 快充&#x27;</span>,
    ChargingPointType.dcFast: <span class="hljs-string">&#x27;DC 快充&#x27;</span>,
    ChargingPointType.dcUltraFast: <span class="hljs-string">&#x27;DC 超快充&#x27;</span>,
  };
  
  <span class="hljs-comment">// 充电功率范围</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">Map</span>&lt;ChargingPointType, PowerRange&gt; powerRanges = {
    ChargingPointType.acSlow: PowerRange(<span class="hljs-number">3.7</span>, <span class="hljs-number">22.0</span>),
    ChargingPointType.acFast: PowerRange(<span class="hljs-number">22.0</span>, <span class="hljs-number">43.0</span>),
    ChargingPointType.dcFast: PowerRange(<span class="hljs-number">50.0</span>, <span class="hljs-number">150.0</span>),
    ChargingPointType.dcUltraFast: PowerRange(<span class="hljs-number">150.0</span>, <span class="hljs-number">350.0</span>),
  };
  
  <span class="hljs-comment">// 默认搜索半径</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> defaultSearchRadius = <span class="hljs-number">5.0</span>; <span class="hljs-comment">// km</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> maxSearchRadius = <span class="hljs-number">50.0</span>; <span class="hljs-comment">// km</span>
  
  <span class="hljs-comment">// 充电会话更新间隔</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span> sessionUpdateInterval = <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span> statusCheckInterval = <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>);
  
  <span class="hljs-comment">// 支付相关</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> minPreAuthAmount = <span class="hljs-number">10.0</span>; <span class="hljs-comment">// 最小预授权金额</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> maxPreAuthAmount = <span class="hljs-number">500.0</span>; <span class="hljs-comment">// 最大预授权金额</span>
}
</code></pre>
<h2 id="错误处理">错误处理</h2>
<h3 id="充电特定异常">充电特定异常</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 充电功能异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChargingFailure</span> </span>{
  <span class="hljs-keyword">const</span> ChargingFailure();
  
  <span class="hljs-keyword">factory</span> ChargingFailure.searchFailed(<span class="hljs-built_in">String</span> message) = SearchFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.pointUnavailable() = PointUnavailableFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.sessionStartFailed(<span class="hljs-built_in">String</span> message) = SessionStartFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.sessionStopFailed(<span class="hljs-built_in">String</span> message) = SessionStopFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.paymentFailed() = PaymentFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.scanFailed() = ScanFailure;
  <span class="hljs-keyword">factory</span> ChargingFailure.networkError(<span class="hljs-built_in">String</span> message) = NetworkFailure;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointUnavailableFailure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChargingFailure</span> </span>{
  <span class="hljs-keyword">const</span> PointUnavailableFailure();
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> message =&gt; <span class="hljs-string">&#x27;选择的充电桩当前不可用&#x27;</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SessionStartFailure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChargingFailure</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">const</span> SessionStartFailure(<span class="hljs-keyword">this</span>.message);
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心依赖">核心依赖</h3>
<ul>
<li><strong>clr_charging</strong>: 充电服务 SDK</li>
<li><strong>clr_geo</strong>: 地理位置服务</li>
<li><strong>ui_mapview</strong>: 地图视图组件</li>
<li><strong>flutter_scankit</strong>: 二维码扫描</li>
</ul>
<h3 id="地图相关">地图相关</h3>
<ul>
<li><strong>amap_flutter_map</strong>: 高德地图</li>
<li><strong>amap_flutter_base</strong>: 高德地图基础组件</li>
</ul>
<h3 id="ui-组件">UI 组件</h3>
<ul>
<li><strong>flutter_rating_bar</strong>: 评分组件</li>
<li><strong>url_launcher</strong>: 链接打开</li>
</ul>
<h3 id="框架依赖">框架依赖</h3>
<ul>
<li><strong>basic_modular</strong>: 模块化框架</li>
<li><strong>basic_intl</strong>: 国际化支持</li>
<li><strong>basic_storage</strong>: 本地存储</li>
<li><strong>basic_share</strong>: 分享功能</li>
</ul>
<h2 id="总结">总结</h2>
<p><code>app_charging</code> 模块为 OneApp 提供了完整的充电管理解决方案，涵盖了充电桩查找、会话管理、支付结算、历史记录等全流程功能。模块采用 BLoC 模式进行状态管理，集成了地图服务和支付功能，为用户提供了便捷高效的充电体验。通过与车辆查找功能的集成，进一步提升了用户在充电场景下的服务体验。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>