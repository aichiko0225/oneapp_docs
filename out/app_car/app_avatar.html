<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>App Avatar - &#x865a;&#x62df;&#x5f62;&#x8c61;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="app-avatar---虚拟形象模块文档">App Avatar - 虚拟形象模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>app_avatar</code> 是 OneApp 的虚拟形象管理模块，为用户提供个性化的虚拟车载助手服务。该模块集成了语音克隆技术、3D 虚拟形象渲染、支付服务等功能，让用户可以创建和定制自己的专属虚拟助手。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: app_avatar</li>
<li><strong>版本</strong>: 0.6.1+2</li>
<li><strong>仓库</strong>: <a href="https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-avatar">https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-avatar</a></li>
<li><strong>Flutter 版本</strong>: &gt;=3.0.0</li>
<li><strong>Dart 版本</strong>: &gt;=2.16.2 &lt;4.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>app_avatar/
├── lib/
│   ├── app_avatar.dart           # 主导出文件
│   ├── generated/                # 代码生成文件
│   ├── l10n/                     # 国际化文件
│   └── src/                      # 源代码目录
│       ├── avatar/               # 虚拟形象核心功能
│       ├── common_import.dart    # 通用导入
│       └── route_export.dart     # 路由导出
├── assets/                       # 静态资源
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-语音克隆服务集成">1. 语音克隆服务集成</h3>
<h4 id="语音克隆功能">语音克隆功能</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 语音克隆服务封装</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceCloneService</span> </span>{
  <span class="hljs-keyword">final</span> CLRVoiceClone _voiceCloneService;
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  <span class="hljs-keyword">final</span> ConsentService _consentService;
  
  VoiceCloneService(
    <span class="hljs-keyword">this</span>._voiceCloneService,
    <span class="hljs-keyword">this</span>._paymentService,
    <span class="hljs-keyword">this</span>._consentService,
  );
  
  <span class="hljs-comment">// 开始语音克隆流程</span>
  Future&lt;Result&lt;VoiceCloneSession&gt;&gt; startVoiceClone({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> VoiceClonePackage package,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 检查用户同意</span>
      <span class="hljs-keyword">final</span> consentResult = <span class="hljs-keyword">await</span> _checkUserConsent(userId);
      <span class="hljs-keyword">if</span> (consentResult.isLeft()) {
        <span class="hljs-keyword">return</span> Left(AvatarFailure.consentRequired());
      }
      
      <span class="hljs-comment">// 2. 验证支付</span>
      <span class="hljs-keyword">final</span> paymentResult = <span class="hljs-keyword">await</span> _processPayment(package);
      <span class="hljs-keyword">if</span> (paymentResult.isLeft()) {
        <span class="hljs-keyword">return</span> Left(AvatarFailure.paymentFailed());
      }
      
      <span class="hljs-comment">// 3. 创建语音克隆会话</span>
      <span class="hljs-keyword">final</span> session = <span class="hljs-keyword">await</span> _voiceCloneService.createSession(
        userId: userId,
        packageId: package.id,
        paymentId: paymentResult.getOrElse(() =&gt; <span class="hljs-string">&#x27;&#x27;</span>),
      );
      
      <span class="hljs-keyword">return</span> Right(session);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.sessionCreationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 上传语音样本</span>
  Future&lt;Result&lt;VoiceSampleUploadResult&gt;&gt; uploadVoiceSample({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> sessionId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> audioFilePath,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> sampleText,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 压缩音频文件</span>
      <span class="hljs-keyword">final</span> compressedAudio = <span class="hljs-keyword">await</span> _compressAudioFile(audioFilePath);
      
      <span class="hljs-comment">// 上传到语音克隆服务</span>
      <span class="hljs-keyword">final</span> uploadResult = <span class="hljs-keyword">await</span> _voiceCloneService.uploadSample(
        sessionId: sessionId,
        audioData: compressedAudio,
        transcription: sampleText,
      );
      
      <span class="hljs-keyword">return</span> Right(uploadResult);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.uploadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 开始训练语音模型</span>
  Future&lt;Result&lt;VoiceTrainingJob&gt;&gt; startVoiceTraining(
    <span class="hljs-built_in">String</span> sessionId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> trainingJob = <span class="hljs-keyword">await</span> _voiceCloneService.startTraining(sessionId);
      <span class="hljs-keyword">return</span> Right(trainingJob);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.trainingFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取训练进度</span>
  Future&lt;Result&lt;VoiceTrainingProgress&gt;&gt; getTrainingProgress(
    <span class="hljs-built_in">String</span> jobId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> progress = <span class="hljs-keyword">await</span> _voiceCloneService.getTrainingProgress(jobId);
      <span class="hljs-keyword">return</span> Right(progress);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.progressQueryFailed(e.toString()));
    }
  }
}
</code></pre>
<h3 id="2-虚拟形象管理">2. 虚拟形象管理</h3>
<h4 id="形象配置和定制">形象配置和定制</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象配置管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarConfigurationManager</span> </span>{
  <span class="hljs-keyword">final</span> SharedPreferences _prefs;
  <span class="hljs-keyword">final</span> AvatarRenderingService _renderingService;
  
  AvatarConfigurationManager(<span class="hljs-keyword">this</span>._prefs, <span class="hljs-keyword">this</span>._renderingService);
  
  <span class="hljs-comment">// 获取用户的虚拟形象配置</span>
  Future&lt;Result&lt;AvatarConfiguration&gt;&gt; getUserAvatarConfig(
    <span class="hljs-built_in">String</span> userId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> configJson = _prefs.getString(<span class="hljs-string">&#x27;avatar_config_<span class="hljs-subst">$userId</span>&#x27;</span>);
      <span class="hljs-keyword">if</span> (configJson != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">final</span> config = AvatarConfiguration.fromJson(
          jsonDecode(configJson),
        );
        <span class="hljs-keyword">return</span> Right(config);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 返回默认配置</span>
        <span class="hljs-keyword">return</span> Right(AvatarConfiguration.defaultConfig());
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.configLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 保存虚拟形象配置</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; saveAvatarConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> AvatarConfiguration config,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> configJson = jsonEncode(config.toJson());
      <span class="hljs-keyword">await</span> _prefs.setString(<span class="hljs-string">&#x27;avatar_config_<span class="hljs-subst">$userId</span>&#x27;</span>, configJson);
      
      <span class="hljs-comment">// 通知渲染服务更新配置</span>
      <span class="hljs-keyword">await</span> _renderingService.updateConfiguration(config);
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.configSaveFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 更新形象外观</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; updateAvatarAppearance({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> AvatarAppearance appearance,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> config = <span class="hljs-keyword">await</span> getUserAvatarConfig(userId);
      <span class="hljs-keyword">return</span> config.fold(
        (failure) =&gt; Left(failure),
        (currentConfig) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">final</span> updatedConfig = currentConfig.copyWith(
            appearance: appearance,
          );
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> saveAvatarConfig(
            userId: userId,
            config: updatedConfig,
          );
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.appearanceUpdateFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 虚拟形象配置模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarConfiguration</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> AvatarAppearance appearance;
  <span class="hljs-keyword">final</span> VoiceSettings voiceSettings;
  <span class="hljs-keyword">final</span> BehaviorSettings behaviorSettings;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> updatedAt;
  
  <span class="hljs-keyword">const</span> AvatarConfiguration({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.appearance,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.voiceSettings,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.behaviorSettings,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.updatedAt,
  });
  
  <span class="hljs-keyword">factory</span> AvatarConfiguration.defaultConfig() {
    <span class="hljs-keyword">return</span> AvatarConfiguration(
      id: <span class="hljs-string">&#x27;default&#x27;</span>,
      userId: <span class="hljs-string">&#x27;&#x27;</span>,
      appearance: AvatarAppearance.defaultAppearance(),
      voiceSettings: VoiceSettings.defaultSettings(),
      behaviorSettings: BehaviorSettings.defaultSettings(),
      createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
    );
  }
  
  AvatarConfiguration copyWith({
    AvatarAppearance? appearance,
    VoiceSettings? voiceSettings,
    BehaviorSettings? behaviorSettings,
  }) {
    <span class="hljs-keyword">return</span> AvatarConfiguration(
      id: id,
      userId: userId,
      appearance: appearance ?? <span class="hljs-keyword">this</span>.appearance,
      voiceSettings: voiceSettings ?? <span class="hljs-keyword">this</span>.voiceSettings,
      behaviorSettings: behaviorSettings ?? <span class="hljs-keyword">this</span>.behaviorSettings,
      createdAt: createdAt,
      updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
    );
  }
}
</code></pre>
<h3 id="3-支付集成">3. 支付集成</h3>
<h4 id="虚拟形象服务支付">虚拟形象服务支付</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象支付服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarPaymentService</span> </span>{
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  <span class="hljs-keyword">final</span> OrderService _orderService;
  
  AvatarPaymentService(<span class="hljs-keyword">this</span>._paymentService, <span class="hljs-keyword">this</span>._orderService);
  
  <span class="hljs-comment">// 获取虚拟形象服务套餐</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;AvatarServicePackage&gt;&gt;&gt; getServicePackages() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> packages = <span class="hljs-keyword">await</span> _paymentService.getAvatarPackages();
      <span class="hljs-keyword">return</span> Right(packages);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.packagesLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 购买虚拟形象服��</span>
  Future&lt;Result&lt;PaymentResult&gt;&gt; purchaseAvatarService({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> AvatarServicePackage package,
    <span class="hljs-keyword">required</span> PaymentMethod paymentMethod,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 创建订单</span>
      <span class="hljs-keyword">final</span> order = <span class="hljs-keyword">await</span> _orderService.createAvatarOrder(
        userId: userId,
        packageId: package.id,
        amount: package.price,
      );
      
      <span class="hljs-keyword">if</span> (order.isLeft()) {
        <span class="hljs-keyword">return</span> Left(AvatarFailure.orderCreationFailed());
      }
      
      <span class="hljs-comment">// 2. 处理支付</span>
      <span class="hljs-keyword">final</span> paymentResult = <span class="hljs-keyword">await</span> _paymentService.processPayment(
        orderId: order.getOrElse(() =&gt; <span class="hljs-keyword">throw</span> Exception()).id,
        amount: package.price,
        paymentMethod: paymentMethod,
        description: <span class="hljs-string">&#x27;虚拟形象服务 - <span class="hljs-subst">${package.name}</span>&#x27;</span>,
      );
      
      <span class="hljs-keyword">if</span> (paymentResult.isSuccess) {
        <span class="hljs-comment">// 3. 激活服务</span>
        <span class="hljs-keyword">await</span> _activateAvatarService(
          userId: userId,
          packageId: package.id,
          orderId: order.getOrElse(() =&gt; <span class="hljs-keyword">throw</span> Exception()).id,
        );
      }
      
      <span class="hljs-keyword">return</span> Right(paymentResult);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.purchaseFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 激活虚拟形象服务</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _activateAvatarService({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> packageId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> orderId,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 更新用户虚拟形象权限</span>
    <span class="hljs-keyword">await</span> _updateUserAvatarPermissions(userId, packageId);
    
    <span class="hljs-comment">// 记录服务激活</span>
    <span class="hljs-keyword">await</span> _recordServiceActivation(userId, packageId, orderId);
  }
}

<span class="hljs-comment">// 虚拟形象服务套餐模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarServicePackage</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> price;
  <span class="hljs-keyword">final</span> Currency currency;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> validityPeriod;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;AvatarFeature&gt; includedFeatures;
  <span class="hljs-keyword">final</span> PackageType type;
  
  <span class="hljs-keyword">const</span> AvatarServicePackage({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.price,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.currency,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.validityPeriod,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.includedFeatures,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> includesVoiceClone =&gt; includedFeatures
      .contains(AvatarFeature.voiceClone);
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> includesCustomAppearance =&gt; includedFeatures
      .contains(AvatarFeature.customAppearance);
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> includesAdvancedBehavior =&gt; includedFeatures
      .contains(AvatarFeature.advancedBehavior);
}
</code></pre>
<h3 id="4-用户同意管理">4. 用户同意管理</h3>
<h4 id="隐私和权限同意">隐私和权限同意</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象同意管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarConsentManager</span> </span>{
  <span class="hljs-keyword">final</span> ConsentService _consentService;
  <span class="hljs-keyword">final</span> BasicConsentService _basicConsentService;
  
  AvatarConsentManager(<span class="hljs-keyword">this</span>._consentService, <span class="hljs-keyword">this</span>._basicConsentService);
  
  <span class="hljs-comment">// 检查虚拟形象服务同意状态</span>
  Future&lt;Result&lt;ConsentStatus&gt;&gt; checkAvatarConsent(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> consentItems = [
        ConsentItem.voiceDataCollection,
        ConsentItem.voiceCloning,
        ConsentItem.avatarDataProcessing,
        ConsentItem.personalizedService,
      ];
      
      <span class="hljs-keyword">final</span> consentResults = <span class="hljs-keyword">await</span> Future.wait(
        consentItems.map((item) =&gt; _consentService.checkConsent(
          userId: userId,
          consentType: item.type,
        )),
      );
      
      <span class="hljs-keyword">final</span> allConsented = consentResults.every((result) =&gt; 
          result.fold((_) =&gt; <span class="hljs-keyword">false</span>, (status) =&gt; status.isConsented));
      
      <span class="hljs-keyword">return</span> Right(ConsentStatus(
        isFullyConsented: allConsented,
        consentItems: consentItems,
        consentResults: consentResults,
      ));
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.consentCheckFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 请求虚拟形象服务同意</span>
  Future&lt;Result&lt;ConsentResult&gt;&gt; requestAvatarConsent({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;ConsentItem&gt; requiredConsents,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> consentResult = <span class="hljs-keyword">await</span> _consentService.requestConsent(
        userId: userId,
        consentItems: requiredConsents,
        purpose: ConsentPurpose.avatarService,
      );
      
      <span class="hljs-keyword">return</span> Right(consentResult);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.consentRequestFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 撤销虚拟形象同意</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; revokeAvatarConsent({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> ConsentType consentType,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _consentService.revokeConsent(
        userId: userId,
        consentType: consentType,
      );
      
      <span class="hljs-comment">// 根据撤销的同意类型，禁用相关功能</span>
      <span class="hljs-keyword">await</span> _disableRelatedFeatures(userId, consentType);
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(AvatarFailure.consentRevokeFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 同意项定义</span>
<span class="hljs-keyword">enum</span> ConsentItem {
  voiceDataCollection,
  voiceCloning,
  avatarDataProcessing,
  personalizedService;
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> displayName {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ConsentItem.voiceDataCollection:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;语音数据收集&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.voiceCloning:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;语音克隆服务&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.avatarDataProcessing:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;虚拟形象数据处理&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.personalizedService:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;个性化服务&#x27;</span>;
    }
  }
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> description {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> ConsentItem.voiceDataCollection:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;收集您的语音样本用于创建个性化虚拟��象&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.voiceCloning:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;使用AI技术克隆您的声音特征&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.avatarDataProcessing:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;处理虚拟形象相关的个人数据&#x27;</span>;
      <span class="hljs-keyword">case</span> ConsentItem.personalizedService:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;基于您的偏好提供个性化虚拟助手服务&#x27;</span>;
    }
  }
}
</code></pre>
<h2 id="状态管理-bloc">状态管理 (BLoC)</h2>
<h3 id="虚拟形象状态管理">虚拟形象状态管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象状态管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">AvatarEvent</span>, <span class="hljs-title">AvatarState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> AvatarConfigurationManager _configManager;
  <span class="hljs-keyword">final</span> VoiceCloneService _voiceCloneService;
  <span class="hljs-keyword">final</span> AvatarPaymentService _paymentService;
  
  AvatarBloc(
    <span class="hljs-keyword">this</span>._configManager,
    <span class="hljs-keyword">this</span>._voiceCloneService,
    <span class="hljs-keyword">this</span>._paymentService,
  ) : <span class="hljs-keyword">super</span>(AvatarInitial()) {
    <span class="hljs-keyword">on</span>&lt;LoadAvatarConfig&gt;(_onLoadAvatarConfig);
    <span class="hljs-keyword">on</span>&lt;UpdateAvatarAppearance&gt;(_onUpdateAvatarAppearance);
    <span class="hljs-keyword">on</span>&lt;StartVoiceClone&gt;(_onStartVoiceClone);
    <span class="hljs-keyword">on</span>&lt;PurchaseAvatarService&gt;(_onPurchaseAvatarService);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onLoadAvatarConfig(
    LoadAvatarConfig event,
    Emitter&lt;AvatarState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(AvatarLoading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _configManager.getUserAvatarConfig(event.userId);
    result.fold(
      (failure) =&gt; emit(AvatarError(failure.message)),
      (config) =&gt; emit(AvatarConfigLoaded(config)),
    );
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onStartVoiceClone(
    StartVoiceClone event,
    Emitter&lt;AvatarState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(VoiceCloneStarting());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _voiceCloneService.startVoiceClone(
      userId: event.userId,
      package: event.package,
    );
    
    result.fold(
      (failure) =&gt; emit(AvatarError(failure.message)),
      (session) =&gt; emit(VoiceCloneSessionCreated(session)),
    );
  }
}

<span class="hljs-comment">// 语音克隆训练状态管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceTrainingBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">VoiceTrainingEvent</span>, <span class="hljs-title">VoiceTrainingState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> VoiceCloneService _voiceCloneService;
  Timer? _progressTimer;
  
  VoiceTrainingBloc(<span class="hljs-keyword">this</span>._voiceCloneService) : <span class="hljs-keyword">super</span>(VoiceTrainingInitial()) {
    <span class="hljs-keyword">on</span>&lt;StartVoiceTraining&gt;(_onStartVoiceTraining);
    <span class="hljs-keyword">on</span>&lt;CheckTrainingProgress&gt;(_onCheckTrainingProgress);
    <span class="hljs-keyword">on</span>&lt;CancelVoiceTraining&gt;(_onCancelVoiceTraining);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onStartVoiceTraining(
    StartVoiceTraining event,
    Emitter&lt;VoiceTrainingState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(VoiceTrainingInProgress(
      progress: TrainingProgress.initial(),
    ));
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _voiceCloneService.startVoiceTraining(event.sessionId);
    
    result.fold(
      (failure) =&gt; emit(VoiceTrainingError(failure.message)),
      (job) {
        emit(VoiceTrainingInProgress(
          progress: TrainingProgress.started(job.id),
        ));
        _startProgressMonitoring(job.id);
      },
    );
  }
  
  <span class="hljs-keyword">void</span> _startProgressMonitoring(<span class="hljs-built_in">String</span> jobId) {
    _progressTimer = Timer.periodic(
      <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      (_) =&gt; add(CheckTrainingProgress(jobId)),
    );
  }
}
</code></pre>
<h2 id="数据模型">数据模型</h2>
<h3 id="虚拟形象外观模型">虚拟形象外观模型</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象外观配置</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarAppearance</span> </span>{
  <span class="hljs-keyword">final</span> FaceConfiguration face;
  <span class="hljs-keyword">final</span> HairConfiguration hair;
  <span class="hljs-keyword">final</span> EyeConfiguration eyes;
  <span class="hljs-keyword">final</span> ClothingConfiguration clothing;
  <span class="hljs-keyword">final</span> AccessoryConfiguration accessories;
  
  <span class="hljs-keyword">const</span> AvatarAppearance({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.face,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.hair,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.eyes,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.clothing,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.accessories,
  });
  
  <span class="hljs-keyword">factory</span> AvatarAppearance.defaultAppearance() {
    <span class="hljs-keyword">return</span> AvatarAppearance(
      face: FaceConfiguration.defaultFace(),
      hair: HairConfiguration.defaultHair(),
      eyes: EyeConfiguration.defaultEyes(),
      clothing: ClothingConfiguration.defaultClothing(),
      accessories: AccessoryConfiguration.defaultAccessories(),
    );
  }
}

<span class="hljs-comment">// 语音设置模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceSettings</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> customVoiceId; <span class="hljs-comment">// 自定义语音ID</span>
  <span class="hljs-keyword">final</span> VoiceType voiceType;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> pitch; <span class="hljs-comment">// 音调 (0.5 - 2.0)</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> speed; <span class="hljs-comment">// 语速 (0.5 - 2.0)</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> volume; <span class="hljs-comment">// 音量 (0.0 - 1.0)</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> language;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> accent;
  
  <span class="hljs-keyword">const</span> VoiceSettings({
    <span class="hljs-keyword">this</span>.customVoiceId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.voiceType,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pitch,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.speed,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.volume,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.language,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.accent,
  });
  
  <span class="hljs-keyword">factory</span> VoiceSettings.defaultSettings() {
    <span class="hljs-keyword">return</span> VoiceSettings(
      voiceType: VoiceType.standard,
      pitch: <span class="hljs-number">1.0</span>,
      speed: <span class="hljs-number">1.0</span>,
      volume: <span class="hljs-number">0.8</span>,
      language: <span class="hljs-string">&#x27;zh-CN&#x27;</span>,
      accent: <span class="hljs-string">&#x27;standard&#x27;</span>,
    );
  }
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasCustomVoice =&gt; customVoiceId != <span class="hljs-keyword">null</span>;
}

<span class="hljs-comment">// 行为设置模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BehaviorSettings</span> </span>{
  <span class="hljs-keyword">final</span> PersonalityType personality;
  <span class="hljs-keyword">final</span> ResponseStyle responseStyle;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BehaviorTrait&gt; traits;
  <span class="hljs-keyword">final</span> EmotionSettings emotionSettings;
  <span class="hljs-keyword">final</span> InteractionPreferences interactionPreferences;
  
  <span class="hljs-keyword">const</span> BehaviorSettings({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.personality,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.responseStyle,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.traits,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.emotionSettings,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.interactionPreferences,
  });
  
  <span class="hljs-keyword">factory</span> BehaviorSettings.defaultSettings() {
    <span class="hljs-keyword">return</span> BehaviorSettings(
      personality: PersonalityType.friendly,
      responseStyle: ResponseStyle.conversational,
      traits: [BehaviorTrait.helpful, BehaviorTrait.patient],
      emotionSettings: EmotionSettings.balanced(),
      interactionPreferences: InteractionPreferences.defaultPreferences(),
    );
  }
}
</code></pre>
<h3 id="语音克隆相关模型">语音克隆相关模型</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 语音克隆会话</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceCloneSession</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> packageId;
  <span class="hljs-keyword">final</span> VoiceCloneStatus status;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;VoiceSample&gt; samples;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> completedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> voiceModelId;
  
  <span class="hljs-keyword">const</span> VoiceCloneSession({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.packageId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.samples,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">this</span>.completedAt,
    <span class="hljs-keyword">this</span>.voiceModelId,
  });
  
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> requiredSamplesCount =&gt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 需要的语音样本数量</span>
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> uploadedSamplesCount =&gt; samples.length;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasEnoughSamples =&gt; uploadedSamplesCount &gt;= requiredSamplesCount;
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> completionPercentage =&gt; uploadedSamplesCount / requiredSamplesCount;
}

<span class="hljs-comment">// 语音样本</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceSample</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> sessionId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> audioUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> transcription;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> duration;
  <span class="hljs-keyword">final</span> SampleQuality quality;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> uploadedAt;
  
  <span class="hljs-keyword">const</span> VoiceSample({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.sessionId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.audioUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.transcription,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.duration,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.quality,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.uploadedAt,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isGoodQuality =&gt; quality == SampleQuality.high || 
                          quality == SampleQuality.excellent;
}

<span class="hljs-comment">// 训练进度</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrainingProgress</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> jobId;
  <span class="hljs-keyword">final</span> TrainingStage currentStage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> progressPercentage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> estimatedTimeRemaining;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> statusMessage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> lastUpdated;
  
  <span class="hljs-keyword">const</span> TrainingProgress({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.jobId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.currentStage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.progressPercentage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.estimatedTimeRemaining,
    <span class="hljs-keyword">this</span>.statusMessage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.lastUpdated,
  });
  
  <span class="hljs-keyword">factory</span> TrainingProgress.initial() {
    <span class="hljs-keyword">return</span> TrainingProgress(
      jobId: <span class="hljs-string">&#x27;&#x27;</span>,
      currentStage: TrainingStage.initializing,
      progressPercentage: <span class="hljs-number">0.0</span>,
      estimatedTimeRemaining: <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">2</span>),
      lastUpdated: <span class="hljs-built_in">DateTime</span>.now(),
    );
  }
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isCompleted =&gt; progressPercentage &gt;= <span class="hljs-number">1.0</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isFailed =&gt; currentStage == TrainingStage.failed;
}
</code></pre>
<h2 id="ui-组件">UI 组件</h2>
<h3 id="虚拟形象配置界面">虚拟形象配置界面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象配置页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarConfigurationPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  
  <span class="hljs-keyword">const</span> AvatarConfigurationPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId});
  
  <span class="hljs-meta">@override</span>
  _AvatarConfigurationPageState createState() =&gt; _AvatarConfigurationPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_AvatarConfigurationPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">AvatarConfigurationPage</span>&gt;
    <span class="hljs-title">with</span> <span class="hljs-title">TickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _tabController;
  <span class="hljs-keyword">late</span> AvatarBloc _avatarBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _tabController = TabController(length: <span class="hljs-number">3</span>, vsync: <span class="hljs-keyword">this</span>);
    _avatarBloc = context.read&lt;AvatarBloc&gt;();
    _avatarBloc.add(LoadAvatarConfig(widget.userId));
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">&#x27;虚拟形象设置&#x27;</span>),
        bottom: TabBar(
          controller: _tabController,
          tabs: [
            Tab(text: <span class="hljs-string">&#x27;外观&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;声音&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;性格&#x27;</span>),
          ],
        ),
      ),
      body: BlocBuilder&lt;AvatarBloc, AvatarState&gt;(
        builder: (context, state) {
          <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> AvatarConfigLoaded) {
            <span class="hljs-keyword">return</span> TabBarView(
              controller: _tabController,
              children: [
                _buildAppearanceTab(state.config),
                _buildVoiceTab(state.config),
                _buildBehaviorTab(state.config),
              ],
            );
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> AvatarError) {
            <span class="hljs-keyword">return</span> _buildErrorState(state.message);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> _buildLoadingState();
          }
        },
      ),
    );
  }
  
  Widget _buildAppearanceTab(AvatarConfiguration config) {
    <span class="hljs-keyword">return</span> SingleChildScrollView(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildAvatarPreview(config.appearance),
          SizedBox(height: <span class="hljs-number">24</span>),
          _buildFaceCustomization(config.appearance.face),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildHairCustomization(config.appearance.hair),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildClothingCustomization(config.appearance.clothing),
        ],
      ),
    );
  }
  
  Widget _buildVoiceTab(AvatarConfiguration config) {
    <span class="hljs-keyword">return</span> SingleChildScrollView(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildVoiceTypeSelection(config.voiceSettings),
          SizedBox(height: <span class="hljs-number">16</span>),
          <span class="hljs-keyword">if</span> (config.voiceSettings.hasCustomVoice) 
            _buildCustomVoiceControls(config.voiceSettings),
          _buildVoicePreviewPlayer(config.voiceSettings),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildVoiceParameterSliders(config.voiceSettings),
          SizedBox(height: <span class="hljs-number">24</span>),
          _buildVoiceCloneSection(),
        ],
      ),
    );
  }
}
</code></pre>
<h3 id="语音克隆界面">语音克隆界面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 语音克隆训练页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VoiceCloneTrainingPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> VoiceCloneSession session;
  
  <span class="hljs-keyword">const</span> VoiceCloneTrainingPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.session});
  
  <span class="hljs-meta">@override</span>
  _VoiceCloneTrainingPageState createState() =&gt; _VoiceCloneTrainingPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_VoiceCloneTrainingPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">VoiceCloneTrainingPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> VoiceTrainingBloc _trainingBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _trainingBloc = context.read&lt;VoiceTrainingBloc&gt;();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">&#x27;语音克隆训练&#x27;</span>)),
      body: BlocBuilder&lt;VoiceTrainingBloc, VoiceTrainingState&gt;(
        builder: (context, state) {
          <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> VoiceTrainingInProgress) {
            <span class="hljs-keyword">return</span> _buildTrainingProgress(state.progress);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> VoiceTrainingCompleted) {
            <span class="hljs-keyword">return</span> _buildTrainingCompleted(state.result);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> VoiceTrainingError) {
            <span class="hljs-keyword">return</span> _buildTrainingError(state.message);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> _buildTrainingInitial();
          }
        },
      ),
    );
  }
  
  Widget _buildTrainingProgress(TrainingProgress progress) {
    <span class="hljs-keyword">return</span> Padding(
      padding: EdgeInsets.all(<span class="hljs-number">24</span>),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            <span class="hljs-string">&#x27;正在训练您的专属语音&#x27;</span>,
            style: Theme.of(context).textTheme.headlineSmall,
            textAlign: TextAlign.center,
          ),
          SizedBox(height: <span class="hljs-number">32</span>),
          CircularProgressIndicator(
            value: progress.progressPercentage,
            strokeWidth: <span class="hljs-number">8</span>,
            backgroundColor: Colors.grey[<span class="hljs-number">300</span>],
          ),
          SizedBox(height: <span class="hljs-number">16</span>),
          Text(
            <span class="hljs-string">&#x27;<span class="hljs-subst">${(progress.progressPercentage * <span class="hljs-number">100</span>).toInt()}</span>% 完成&#x27;</span>,
            style: Theme.of(context).textTheme.titleLarge,
          ),
          SizedBox(height: <span class="hljs-number">8</span>),
          Text(
            <span class="hljs-string">&#x27;预计剩余时间: <span class="hljs-subst">${progress.estimatedTimeRemaining.inMinutes}</span> 分钟&#x27;</span>,
            style: Theme.of(context).textTheme.bodyMedium,
          ),
          SizedBox(height: <span class="hljs-number">16</span>),
          <span class="hljs-keyword">if</span> (progress.statusMessage != <span class="hljs-keyword">null</span>)
            Text(
              progress.statusMessage!,
              style: Theme.of(context).textTheme.bodySmall,
              textAlign: TextAlign.center,
            ),
        ],
      ),
    );
  }
}
</code></pre>
<h2 id="工具类">工具类</h2>
<h3 id="音频处理工具">音频处理工具</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 音频文件处理工具</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AudioProcessingUtils</span> </span>{
  <span class="hljs-comment">// 压缩音频文件</span>
  <span class="hljs-keyword">static</span> Future&lt;Uint8List&gt; compressAudioFile(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> file = File(filePath);
      <span class="hljs-keyword">final</span> originalBytes = <span class="hljs-keyword">await</span> file.readAsBytes();
      
      <span class="hljs-comment">// 使用 flutter_image_compress 进行音频压缩</span>
      <span class="hljs-comment">// 注意：这里需要适配音频压缩，实际实现可能需要专门的音频处理库</span>
      <span class="hljs-keyword">final</span> compressedBytes = <span class="hljs-keyword">await</span> FlutterImageCompress.compressWithList(
        originalBytes,
        quality: <span class="hljs-number">70</span>, <span class="hljs-comment">// 压缩质量</span>
      );
      
      <span class="hljs-keyword">return</span> compressedBytes;
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> AudioProcessingException(<span class="hljs-string">&#x27;音频压缩失败: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
  
  <span class="hljs-comment">// 验证音频文件格式</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isValidAudioFormat(<span class="hljs-built_in">String</span> filePath) {
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">extension</span> = path.<span class="hljs-keyword">extension</span>(filePath).toLowerCase();
    <span class="hljs-keyword">const</span> supportedFormats = [<span class="hljs-string">&#x27;.mp3&#x27;</span>, <span class="hljs-string">&#x27;.wav&#x27;</span>, <span class="hljs-string">&#x27;.m4a&#x27;</span>, <span class="hljs-string">&#x27;.aac&#x27;</span>];
    <span class="hljs-keyword">return</span> supportedFormats.contains(<span class="hljs-keyword">extension</span>);
  }
  
  <span class="hljs-comment">// 获取音频文件时长</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">Duration</span>&gt; getAudioDuration(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 这里需要使用音频处理库来获取时长</span>
    <span class="hljs-comment">// 示例实现</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 使用适当的音频库获取时长</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>); <span class="hljs-comment">// 示例返回值</span>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> AudioProcessingException(<span class="hljs-string">&#x27;无法获取音频时长: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
  
  <span class="hljs-comment">// 检查音频质量</span>
  <span class="hljs-keyword">static</span> Future&lt;SampleQuality&gt; analyzeAudioQuality(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 分析音频质量指标</span>
      <span class="hljs-keyword">final</span> duration = <span class="hljs-keyword">await</span> getAudioDuration(filePath);
      <span class="hljs-keyword">final</span> fileSize = <span class="hljs-keyword">await</span> File(filePath).length();
      
      <span class="hljs-comment">// 基于时长和文件大小的简单质量评估</span>
      <span class="hljs-keyword">if</span> (duration.inSeconds &lt; <span class="hljs-number">5</span>) {
        <span class="hljs-keyword">return</span> SampleQuality.poor;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (duration.inSeconds &gt; <span class="hljs-number">30</span>) {
        <span class="hljs-keyword">return</span> SampleQuality.poor;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fileSize &lt; <span class="hljs-number">50</span> * <span class="hljs-number">1024</span>) { <span class="hljs-comment">// 小于50KB</span>
        <span class="hljs-keyword">return</span> SampleQuality.low;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> SampleQuality.high;
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> SampleQuality.unknown;
    }
  }
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心依赖">核心依赖</h3>
<ul>
<li><strong>clr_voiceclone</strong>: 语音克隆服务 SDK</li>
<li><strong>ui_payment</strong>: 支付界面组件</li>
<li><strong>clr_order</strong>: 订单服务 SDK</li>
<li><strong>clr_payment</strong>: 支付服务 SDK</li>
</ul>
<h3 id="同意管理">同意管理</h3>
<ul>
<li><strong>app_consent</strong>: 应用同意管理</li>
<li><strong>basic_consent</strong>: 基础同意服务</li>
</ul>
<h3 id="框架依赖">框架依赖</h3>
<ul>
<li><strong>basic_modular</strong>: 模块化框架</li>
<li><strong>basic_intl</strong>: 国际化支持</li>
<li><strong>bloc</strong>: 状态管理</li>
</ul>
<h3 id="工具依赖">工具依赖</h3>
<ul>
<li><strong>shared_preferences</strong>: 本地存储</li>
<li><strong>fluttertoast</strong>: Toast 提示</li>
<li><strong>flutter_image_compress</strong>: 图像/音频压缩</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="虚拟形象特定异常">虚拟形象特定异常</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 虚拟形象功能异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AvatarFailure</span> </span>{
  <span class="hljs-keyword">const</span> AvatarFailure();
  
  <span class="hljs-keyword">factory</span> AvatarFailure.consentRequired() = ConsentRequiredFailure;
  <span class="hljs-keyword">factory</span> AvatarFailure.paymentFailed() = PaymentFailedFailure;
  <span class="hljs-keyword">factory</span> AvatarFailure.sessionCreationFailed(<span class="hljs-built_in">String</span> message) = SessionCreationFailure;
  <span class="hljs-keyword">factory</span> AvatarFailure.uploadFailed(<span class="hljs-built_in">String</span> message) = UploadFailure;
  <span class="hljs-keyword">factory</span> AvatarFailure.trainingFailed(<span class="hljs-built_in">String</span> message) = TrainingFailure;
  <span class="hljs-keyword">factory</span> AvatarFailure.configLoadFailed(<span class="hljs-built_in">String</span> message) = ConfigLoadFailure;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsentRequiredFailure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AvatarFailure</span> </span>{
  <span class="hljs-keyword">const</span> ConsentRequiredFailure();
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> message =&gt; <span class="hljs-string">&#x27;使用虚拟形象服务需要您的同意&#x27;</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaymentFailedFailure</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AvatarFailure</span> </span>{
  <span class="hljs-keyword">const</span> PaymentFailedFailure();
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> message =&gt; <span class="hljs-string">&#x27;支付失败，请检查支付方式&#x27;</span>;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AudioProcessingException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">const</span> AudioProcessingException(<span class="hljs-keyword">this</span>.message);
}
</code></pre>
<h2 id="总结">总结</h2>
<p><code>app_avatar</code> 模块为 OneApp 提供了完整的虚拟形象服务，包括语音克隆、外观定制、行为设置等功能。模块严格遵循隐私保护原则，通过完善的同意管理确保用户数据安全。集成的支付服务支持虚拟形象服务的商业化运营，为用户提供个性化的车载助手体验。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>