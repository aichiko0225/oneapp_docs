<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>App Maintenance - &#x7ef4;&#x62a4;&#x4fdd;&#x517b;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="app-maintenance---维护保养模块文档">App Maintenance - 维护保养模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>app_maintenance</code> 是 OneApp 车辆模块群中的维护保养核心模块，提供车辆保养计划管理、保养提醒、服务预约、保养记录跟踪等功能。该模块集成了地图服务、日历组件、地理位置服务等，为用户提供完整的车辆维护保养体验。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: app_maintenance</li>
<li><strong>版本</strong>: 0.2.20</li>
<li><strong>仓库</strong>: <a href="https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-maintenance">https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-maintenance</a></li>
<li><strong>Flutter 版本</strong>: &gt;=2.10.5</li>
<li><strong>Dart 版本</strong>: &gt;=2.16.2 &lt;4.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>app_maintenance/
├── lib/
│   ├── app_maintenance.dart      # 主导出文件
│   └── src/                      # 源代码目录
│       ├── pages/                # 维护保养页面
│       ├── widgets/              # 维护保养组件
│       ├── models/               # 数据模型
│       ├── services/             # 服务层
│       ├── blocs/                # 状态管理
│       ├── utils/                # 工具类
│       └── constants/            # 常量定义
├── assets/                       # 静态资源
├── uml.puml/svg                  # UML 设计图
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-保养计划管理">1. 保养计划管理</h3>
<h4 id="保养计划服务">保养计划服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 保养计划管理服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenancePlanService</span> </span>{
  <span class="hljs-keyword">final</span> MaintenanceRepository _repository;
  <span class="hljs-keyword">final</span> VehicleService _vehicleService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  MaintenancePlanService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._vehicleService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 获取车辆保养计划</span>
  Future&lt;Result&lt;MaintenancePlan&gt;&gt; getVehicleMaintenancePlan(
    <span class="hljs-built_in">String</span> vehicleId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取车辆���息</span>
      <span class="hljs-keyword">final</span> vehicle = <span class="hljs-keyword">await</span> _vehicleService.getVehicleById(vehicleId);
      <span class="hljs-keyword">if</span> (vehicle == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.vehicleNotFound());
      }
      
      <span class="hljs-comment">// 获取保养计划模板</span>
      <span class="hljs-keyword">final</span> planTemplate = <span class="hljs-keyword">await</span> _repository.getMaintenancePlanTemplate(
        vehicle.model,
        vehicle.year,
      );
      
      <span class="hljs-comment">// 获取已完成的保养记录</span>
      <span class="hljs-keyword">final</span> completedServices = <span class="hljs-keyword">await</span> _repository.getCompletedMaintenanceRecords(
        vehicleId,
      );
      
      <span class="hljs-comment">// 计算下次保养时间</span>
      <span class="hljs-keyword">final</span> plan = _calculateMaintenancePlan(
        vehicle: vehicle,
        template: planTemplate,
        completedServices: completedServices,
      );
      
      <span class="hljs-keyword">return</span> Right(plan);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.planLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 计算保养计划</span>
  MaintenancePlan _calculateMaintenancePlan({
    <span class="hljs-keyword">required</span> Vehicle vehicle,
    <span class="hljs-keyword">required</span> MaintenancePlanTemplate template,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;MaintenanceRecord&gt; completedServices,
  }) {
    <span class="hljs-keyword">final</span> currentMileage = vehicle.mileage;
    <span class="hljs-keyword">final</span> lastServiceDate = completedServices.isNotEmpty
        ? completedServices
            .map((record) =&gt; record.serviceDate)
            .reduce((a, b) =&gt; a.isAfter(b) ? a : b)
        : vehicle.purchaseDate;
    
    <span class="hljs-keyword">final</span> upcomingServices = &lt;MaintenanceService&gt;[];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> serviceTemplate <span class="hljs-keyword">in</span> template.services) {
      <span class="hljs-keyword">final</span> nextService = _calculateNextService(
        serviceTemplate: serviceTemplate,
        currentMileage: currentMileage,
        lastServiceDate: lastServiceDate,
        completedServices: completedServices,
      );
      
      <span class="hljs-keyword">if</span> (nextService != <span class="hljs-keyword">null</span>) {
        upcomingServices.add(nextService);
      }
    }
    
    <span class="hljs-comment">// 按紧急程度排序</span>
    upcomingServices.sort((a, b) =&gt; a.priority.compareTo(b.priority));
    
    <span class="hljs-keyword">return</span> MaintenancePlan(
      vehicleId: vehicle.id,
      upcomingServices: upcomingServices,
      lastServiceDate: lastServiceDate,
      totalServicesCompleted: completedServices.length,
      nextServiceDue: upcomingServices.isNotEmpty ? upcomingServices.first : <span class="hljs-keyword">null</span>,
    );
  }
  
  <span class="hljs-comment">// 设置保养提醒</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; setMaintenanceReminder({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> serviceType,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> reminderDate,
    <span class="hljs-keyword">required</span> ReminderType reminderType,
    <span class="hljs-built_in">String?</span> customMessage,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> reminder = MaintenanceReminder(
        id: generateId(),
        vehicleId: vehicleId,
        serviceType: serviceType,
        reminderDate: reminderDate,
        reminderType: reminderType,
        customMessage: customMessage,
        isActive: <span class="hljs-keyword">true</span>,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.createMaintenanceReminder(reminder);
      
      <span class="hljs-comment">// 设置本地通知</span>
      <span class="hljs-keyword">await</span> _notificationService.scheduleMaintenanceReminder(reminder);
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.reminderSetFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 保养计划模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenancePlan</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;MaintenanceService&gt; upcomingServices;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> lastServiceDate;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> totalServicesCompleted;
  <span class="hljs-keyword">final</span> MaintenanceService? nextServiceDue;
  
  <span class="hljs-keyword">const</span> MaintenancePlan({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.upcomingServices,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.lastServiceDate,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalServicesCompleted,
    <span class="hljs-keyword">this</span>.nextServiceDue,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasOverdueServices =&gt; upcomingServices
      .any((service) =&gt; service.isOverdue);
  
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> overdueServicesCount =&gt; upcomingServices
      .where((service) =&gt; service.isOverdue)
      .length;
  
  <span class="hljs-built_in">Duration</span> <span class="hljs-keyword">get</span> timeSinceLastService =&gt; <span class="hljs-built_in">DateTime</span>.now().difference(lastServiceDate);
}

<span class="hljs-comment">// 保养服务模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceService</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> ServiceType type;
  <span class="hljs-keyword">final</span> ServicePriority priority;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> intervalMileage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> intervalTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> estimatedCost;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> estimatedDuration;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> dueDate;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> dueMileage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; requiredParts;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isOverdue;
  
  <span class="hljs-keyword">const</span> MaintenanceService({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.priority,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.intervalMileage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.intervalTime,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.estimatedCost,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.estimatedDuration,
    <span class="hljs-keyword">this</span>.dueDate,
    <span class="hljs-keyword">this</span>.dueMileage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.requiredParts,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isOverdue,
  });
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> priorityDisplayName {
    <span class="hljs-keyword">switch</span> (priority) {
      <span class="hljs-keyword">case</span> ServicePriority.urgent:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;紧急&#x27;</span>;
      <span class="hljs-keyword">case</span> ServicePriority.high:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;重要&#x27;</span>;
      <span class="hljs-keyword">case</span> ServicePriority.medium:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;一般&#x27;</span>;
      <span class="hljs-keyword">case</span> ServicePriority.low:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;可选&#x27;</span>;
    }
  }
  
  Color <span class="hljs-keyword">get</span> priorityColor {
    <span class="hljs-keyword">switch</span> (priority) {
      <span class="hljs-keyword">case</span> ServicePriority.urgent:
        <span class="hljs-keyword">return</span> Colors.red;
      <span class="hljs-keyword">case</span> ServicePriority.high:
        <span class="hljs-keyword">return</span> Colors.orange;
      <span class="hljs-keyword">case</span> ServicePriority.medium:
        <span class="hljs-keyword">return</span> Colors.blue;
      <span class="hljs-keyword">case</span> ServicePriority.low:
        <span class="hljs-keyword">return</span> Colors.grey;
    }
  }
}
</code></pre>
<h3 id="2-服务预约管理">2. 服务预约管理</h3>
<h4 id="服务预约服务">服务预约服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 维护保养预约服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceAppointmentService</span> </span>{
  <span class="hljs-keyword">final</span> AppointmentRepository _repository;
  <span class="hljs-keyword">final</span> ServiceProviderService _providerService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  MaintenanceAppointmentService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._providerService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 创建保养预约</span>
  Future&lt;Result&lt;MaintenanceAppointment&gt;&gt; createMaintenanceAppointment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> serviceProviderId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; serviceTypes,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> preferredDateTime,
    <span class="hljs-built_in">DateTime?</span> alternativeDateTime,
    <span class="hljs-keyword">required</span> CustomerInfo customerInfo,
    <span class="hljs-built_in">String?</span> specialRequests,
    <span class="hljs-built_in">bool</span> pickupService = <span class="hljs-keyword">false</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查服务提供商可用性</span>
      <span class="hljs-keyword">final</span> provider = <span class="hljs-keyword">await</span> _providerService.getServiceProviderById(
        serviceProviderId,
      );
      <span class="hljs-keyword">if</span> (provider == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.providerNotFound());
      }
      
      <span class="hljs-comment">// 检查时间段可用性</span>
      <span class="hljs-keyword">final</span> isAvailable = <span class="hljs-keyword">await</span> _checkTimeSlotAvailability(
        providerId: serviceProviderId,
        dateTime: preferredDateTime,
        serviceTypes: serviceTypes,
      );
      
      <span class="hljs-keyword">if</span> (!isAvailable) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.timeSlotNotAvailable());
      }
      
      <span class="hljs-comment">// 估算服务费用</span>
      <span class="hljs-keyword">final</span> costEstimate = <span class="hljs-keyword">await</span> _calculateServiceCost(
        serviceTypes: serviceTypes,
        providerId: serviceProviderId,
        vehicleId: vehicleId,
      );
      
      <span class="hljs-comment">// 创建预约</span>
      <span class="hljs-keyword">final</span> appointment = MaintenanceAppointment(
        id: generateId(),
        userId: userId,
        vehicleId: vehicleId,
        serviceProviderId: serviceProviderId,
        serviceTypes: serviceTypes,
        customerInfo: customerInfo,
        preferredDateTime: preferredDateTime,
        alternativeDateTime: alternativeDateTime,
        specialRequests: specialRequests,
        pickupService: pickupService,
        costEstimate: costEstimate,
        status: AppointmentStatus.pending,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.createMaintenanceAppointment(appointment);
      
      <span class="hljs-comment">// 发送确认通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendAppointmentConfirmation(
        userId: userId,
        appointment: appointment,
      );
      
      <span class="hljs-comment">// 通知服务提供商</span>
      <span class="hljs-keyword">await</span> _notifyServiceProvider(appointment);
      
      <span class="hljs-keyword">return</span> Right(appointment);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.appointmentCreationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取可用时间段</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;TimeSlot&gt;&gt;&gt; getAvailableTimeSlots({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> serviceProviderId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; serviceTypes,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> date,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> provider = <span class="hljs-keyword">await</span> _providerService.getServiceProviderById(
        serviceProviderId,
      );
      <span class="hljs-keyword">if</span> (provider == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.providerNotFound());
      }
      
      <span class="hljs-comment">// 获取营业时间</span>
      <span class="hljs-keyword">final</span> businessHours = provider.getBusinessHours(date.weekday - <span class="hljs-number">1</span>);
      
      <span class="hljs-comment">// 获取已预约时间段</span>
      <span class="hljs-keyword">final</span> bookedSlots = <span class="hljs-keyword">await</span> _repository.getBookedTimeSlots(
        providerId: serviceProviderId,
        date: date,
      );
      
      <span class="hljs-comment">// 计算服务所需时间</span>
      <span class="hljs-keyword">final</span> estimatedDuration = <span class="hljs-keyword">await</span> _calculateServiceDuration(
        serviceTypes: serviceTypes,
        providerId: serviceProviderId,
      );
      
      <span class="hljs-comment">// 生成可用时间段</span>
      <span class="hljs-keyword">final</span> availableSlots = _generateAvailableTimeSlots(
        businessHours: businessHours,
        bookedSlots: bookedSlots,
        serviceDuration: estimatedDuration,
      );
      
      <span class="hljs-keyword">return</span> Right(availableSlots);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.timeSlotsLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 取消预约</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; cancelAppointment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> appointmentId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> reason,
    <span class="hljs-built_in">String?</span> userId,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> appointment = <span class="hljs-keyword">await</span> _repository.getAppointmentById(appointmentId);
      <span class="hljs-keyword">if</span> (appointment == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.appointmentNotFound());
      }
      
      <span class="hljs-comment">// 检查取消权限</span>
      <span class="hljs-keyword">if</span> (userId != <span class="hljs-keyword">null</span> &amp;&amp; appointment.userId != userId) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.permissionDenied());
      }
      
      <span class="hljs-comment">// 检查是否可以取消</span>
      <span class="hljs-keyword">if</span> (!appointment.canBeCancelled) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.cannotBeCancelled());
      }
      
      <span class="hljs-comment">// 更新预约状态</span>
      <span class="hljs-keyword">await</span> _repository.updateAppointmentStatus(
        appointmentId: appointmentId,
        status: AppointmentStatus.cancelled,
        reason: reason,
        updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-comment">// 发送取消通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendAppointmentCancellation(
        userId: appointment.userId,
        appointment: appointment,
        reason: reason,
      );
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.cancellationFailed(e.toString()));
    }
  }
}
</code></pre>
<h3 id="3-保养记录管理">3. 保养记录管理</h3>
<h4 id="保养记录服务">保养记录服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 保养记录管理服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceRecordService</span> </span>{
  <span class="hljs-keyword">final</span> RecordRepository _repository;
  <span class="hljs-keyword">final</span> TrackingService _trackingService;
  
  MaintenanceRecordService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._trackingService);
  
  <span class="hljs-comment">// 创建保养记录</span>
  Future&lt;Result&lt;MaintenanceRecord&gt;&gt; createMaintenanceRecord({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> serviceProviderId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; servicesPerformed,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> serviceDate,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> mileageAtService,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> totalCost,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;MaintenanceItem&gt; items,
    <span class="hljs-built_in">String?</span> notes,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? images,
    <span class="hljs-built_in">String?</span> invoiceNumber,
    <span class="hljs-built_in">String?</span> technicianName,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> record = MaintenanceRecord(
        id: generateId(),
        vehicleId: vehicleId,
        serviceProviderId: serviceProviderId,
        servicesPerformed: servicesPerformed,
        serviceDate: serviceDate,
        mileageAtService: mileageAtService,
        totalCost: totalCost,
        items: items,
        notes: notes,
        images: images ?? [],
        invoiceNumber: invoiceNumber,
        technicianName: technicianName,
        status: RecordStatus.completed,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.createMaintenanceRecord(record);
      
      <span class="hljs-comment">// 记录用户行为</span>
      <span class="hljs-keyword">await</span> _trackingService.trackMaintenanceCompleted(
        vehicleId: vehicleId,
        servicesPerformed: servicesPerformed,
        totalCost: totalCost,
      );
      
      <span class="hljs-keyword">return</span> Right(record);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.recordCreationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取车辆保养历史</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;MaintenanceRecord&gt;&gt;&gt; getVehicleMaintenanceHistory({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleId,
    <span class="hljs-built_in">DateTime?</span> startDate,
    <span class="hljs-built_in">DateTime?</span> endDate,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? serviceTypes,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> records = <span class="hljs-keyword">await</span> _repository.getVehicleMaintenanceRecords(
        vehicleId: vehicleId,
        startDate: startDate,
        endDate: endDate,
        serviceTypes: serviceTypes,
        page: page,
        pageSize: pageSize,
      );
      
      <span class="hljs-keyword">return</span> Right(records);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.historyLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取保养统计信息</span>
  Future&lt;Result&lt;MaintenanceStatistics&gt;&gt; getMaintenanceStatistics({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleId,
    <span class="hljs-keyword">required</span> StatisticsPeriod period,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> records = <span class="hljs-keyword">await</span> _repository.getVehicleMaintenanceRecords(
        vehicleId: vehicleId,
        startDate: period.startDate,
        endDate: period.endDate,
      );
      
      <span class="hljs-keyword">final</span> statistics = _calculateStatistics(records, period);
      <span class="hljs-keyword">return</span> Right(statistics);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.statisticsLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 计算保养统计信息</span>
  MaintenanceStatistics _calculateStatistics(
    <span class="hljs-built_in">List</span>&lt;MaintenanceRecord&gt; records,
    StatisticsPeriod period,
  ) {
    <span class="hljs-keyword">final</span> totalCost = records.fold&lt;<span class="hljs-built_in">double</span>&gt;(
      <span class="hljs-number">0.0</span>,
      (sum, record) =&gt; sum + record.totalCost,
    );
    
    <span class="hljs-keyword">final</span> serviceFrequency = records.length / period.durationInMonths;
    
    <span class="hljs-keyword">final</span> serviceTypeCount = &lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">int</span>&gt;{};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> record <span class="hljs-keyword">in</span> records) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> service <span class="hljs-keyword">in</span> record.servicesPerformed) {
        serviceTypeCount[service] = (serviceTypeCount[service] ?? <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>;
      }
    }
    
    <span class="hljs-keyword">final</span> mostCommonService = serviceTypeCount.entries
        .reduce((a, b) =&gt; a.value &gt; b.value ? a : b)
        .key;
    
    <span class="hljs-keyword">final</span> averageCostPerService = records.isNotEmpty ? totalCost / records.length : <span class="hljs-number">0.0</span>;
    
    <span class="hljs-keyword">return</span> MaintenanceStatistics(
      period: period,
      totalRecords: records.length,
      totalCost: totalCost,
      averageCostPerService: averageCostPerService,
      serviceFrequency: serviceFrequency,
      mostCommonService: mostCommonService,
      serviceTypeBreakdown: serviceTypeCount,
    );
  }
}

<span class="hljs-comment">// 保养记录模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceRecord</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> serviceProviderId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; servicesPerformed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> serviceDate;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> mileageAtService;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalCost;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;MaintenanceItem&gt; items;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> notes;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; images;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> invoiceNumber;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> technicianName;
  <span class="hljs-keyword">final</span> RecordStatus status;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  
  <span class="hljs-keyword">const</span> MaintenanceRecord({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.serviceProviderId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.servicesPerformed,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.serviceDate,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.mileageAtService,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalCost,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items,
    <span class="hljs-keyword">this</span>.notes,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.images,
    <span class="hljs-keyword">this</span>.invoiceNumber,
    <span class="hljs-keyword">this</span>.technicianName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
  });
  
  <span class="hljs-built_in">Duration</span> <span class="hljs-keyword">get</span> ageOfRecord =&gt; <span class="hljs-built_in">DateTime</span>.now().difference(serviceDate);
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasInvoice =&gt; invoiceNumber != <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasImages =&gt; images.isNotEmpty;
}
</code></pre>
<h3 id="4-服务提供商管理">4. 服务提供商管理</h3>
<h4 id="服务提供商服务">服务提供商服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 服务提供商管理服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceProviderService</span> </span>{
  <span class="hljs-keyword">final</span> ProviderRepository _repository;
  <span class="hljs-keyword">final</span> GeoService _geoService;
  
  ServiceProviderService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._geoService);
  
  <span class="hljs-comment">// 查找附近的服务提供商</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;ServiceProvider&gt;&gt;&gt; findNearbyServiceProviders({
    <span class="hljs-keyword">required</span> LatLng userLocation,
    <span class="hljs-built_in">double</span> radiusKm = <span class="hljs-number">20</span>,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? serviceTypes,
    ServiceProviderType? providerType,
    <span class="hljs-built_in">double?</span> minRating,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> providers = <span class="hljs-keyword">await</span> _repository.findProvidersNearLocation(
        location: userLocation,
        radius: radiusKm,
        serviceTypes: serviceTypes,
        providerType: providerType,
        minRating: minRating,
      );
      
      <span class="hljs-comment">// 计算距离并排序</span>
      <span class="hljs-keyword">final</span> providersWithDistance = providers.map((provider) {
        <span class="hljs-keyword">final</span> distance = _geoService.calculateDistance(
          userLocation,
          provider.location,
        );
        <span class="hljs-keyword">return</span> ProviderWithDistance(provider: provider, distance: distance);
      }).toList();
      
      providersWithDistance.sort((a, b) =&gt; a.distance.compareTo(b.distance));
      
      <span class="hljs-keyword">return</span> Right(providersWithDistance.map((p) =&gt; p.provider).toList());
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.providerSearchFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取服务提供商详情</span>
  Future&lt;Result&lt;ServiceProviderDetail&gt;&gt; getServiceProviderDetail(
    <span class="hljs-built_in">String</span> providerId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> provider = <span class="hljs-keyword">await</span> _repository.getServiceProviderById(providerId);
      <span class="hljs-keyword">if</span> (provider == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(MaintenanceFailure.providerNotFound());
      }
      
      <span class="hljs-keyword">final</span> reviews = <span class="hljs-keyword">await</span> _repository.getProviderReviews(providerId);
      <span class="hljs-keyword">final</span> services = <span class="hljs-keyword">await</span> _repository.getProviderServices(providerId);
      <span class="hljs-keyword">final</span> certifications = <span class="hljs-keyword">await</span> _repository.getProviderCertifications(providerId);
      
      <span class="hljs-keyword">final</span> detail = ServiceProviderDetail(
        provider: provider,
        reviews: reviews,
        services: services,
        certifications: certifications,
      );
      
      <span class="hljs-keyword">return</span> Right(detail);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MaintenanceFailure.providerDetailLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 服务提供商模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServiceProvider</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> ServiceProviderType type;
  <span class="hljs-keyword">final</span> Address address;
  <span class="hljs-keyword">final</span> LatLng location;
  <span class="hljs-keyword">final</span> ContactInfo contactInfo;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BusinessHours&gt; businessHours;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; serviceTypes;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rating;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> reviewCount;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; certifications;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; images;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isAuthorized;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isActive;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> offersPickupService;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> offers24HourService;
  
  <span class="hljs-keyword">const</span> ServiceProvider({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.address,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.location,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.contactInfo,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.businessHours,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.serviceTypes,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.rating,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.reviewCount,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.certifications,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.images,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isAuthorized,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isActive,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.offersPickupService,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.offers24HourService,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isOpen {
    <span class="hljs-keyword">if</span> (offers24HourService) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    
    <span class="hljs-keyword">final</span> now = <span class="hljs-built_in">DateTime</span>.now();
    <span class="hljs-keyword">final</span> todayHours = businessHours[now.weekday - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">return</span> todayHours.isOpen(now);
  }
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isOfficialDealer =&gt; type == ServiceProviderType.officialDealer;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isCertified =&gt; certifications.isNotEmpty;
}
</code></pre>
<h2 id="页面组件设计">页面组件设计</h2>
<h3 id="保养计划页面">保养计划页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 保养计划页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenancePlanPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleId;
  
  <span class="hljs-keyword">const</span> MaintenancePlanPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleId});
  
  <span class="hljs-meta">@override</span>
  _MaintenancePlanPageState createState() =&gt; _MaintenancePlanPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MaintenancePlanPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MaintenancePlanPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> MaintenancePlanBloc _planBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _planBloc = context.read&lt;MaintenancePlanBloc&gt;();
    _planBloc.add(LoadMaintenancePlan(widget.vehicleId));
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">&#x27;保养计划&#x27;</span>),
        actions: [
          IconButton(
            icon: Icon(Icons.notifications),
            onPressed: () =&gt; _navigateToReminders(),
          ),
        ],
      ),
      body: BlocBuilder&lt;MaintenancePlanBloc, MaintenancePlanState&gt;(
        builder: (context, state) {
          <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> MaintenancePlanLoaded) {
            <span class="hljs-keyword">return</span> _buildPlanContent(state.plan);
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> MaintenancePlanError) {
            <span class="hljs-keyword">return</span> _buildErrorState(state.message);
          }
          <span class="hljs-keyword">return</span> _buildLoadingState();
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () =&gt; _navigateToServiceBooking(),
        child: Icon(Icons.add),
        tooltip: <span class="hljs-string">&#x27;预约保养&#x27;</span>,
      ),
    );
  }
  
  Widget _buildPlanContent(MaintenancePlan plan) {
    <span class="hljs-keyword">return</span> RefreshIndicator(
      onRefresh: () <span class="hljs-keyword">async</span> {
        _planBloc.add(RefreshMaintenancePlan(widget.vehicleId));
      },
      child: ListView(
        padding: EdgeInsets.all(<span class="hljs-number">16</span>),
        children: [
          _buildOverviewCard(plan),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildUpcomingServicesSection(plan.upcomingServices),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildMaintenanceHistorySection(),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildMaintenanceStatisticsSection(),
        ],
      ),
    );
  }
  
  Widget _buildOverviewCard(MaintenancePlan plan) {
    <span class="hljs-keyword">return</span> Card(
      child: Padding(
        padding: EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              <span class="hljs-string">&#x27;保养概览&#x27;</span>,
              style: TextStyle(
                fontSize: <span class="hljs-number">18</span>,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: <span class="hljs-number">12</span>),
            Row(
              children: [
                Expanded(
                  child: _buildStatItem(
                    <span class="hljs-string">&#x27;已完成保养&#x27;</span>,
                    <span class="hljs-string">&#x27;<span class="hljs-subst">${plan.totalServicesCompleted}</span>次&#x27;</span>,
                    Icons.check_circle,
                    Colors.green,
                  ),
                ),
                Expanded(
                  child: _buildStatItem(
                    <span class="hljs-string">&#x27;待处理项目&#x27;</span>,
                    <span class="hljs-string">&#x27;<span class="hljs-subst">${plan.upcomingServices.length}</span>项&#x27;</span>,
                    Icons.schedule,
                    Colors.orange,
                  ),
                ),
              ],
            ),
            <span class="hljs-keyword">if</span> (plan.hasOverdueServices) ...[
              SizedBox(height: <span class="hljs-number">12</span>),
              Container(
                padding: EdgeInsets.all(<span class="hljs-number">12</span>),
                decoration: BoxDecoration(
                  color: Colors.red.withOpacity(<span class="hljs-number">0.1</span>),
                  borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
                  border: Border.all(color: Colors.red),
                ),
                child: Row(
                  children: [
                    Icon(Icons.warning, color: Colors.red),
                    SizedBox(width: <span class="hljs-number">8</span>),
                    Expanded(
                      child: Text(
                        <span class="hljs-string">&#x27;您有 <span class="hljs-subst">${plan.overdueServicesCount}</span> 项逾期保养需要处理&#x27;</span>,
                        style: TextStyle(color: Colors.red),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ],
        ),
      ),
    );
  }
  
  Widget _buildUpcomingServicesSection(<span class="hljs-built_in">List</span>&lt;MaintenanceService&gt; services) {
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">&#x27;即将到期的保养&#x27;</span>,
          style: TextStyle(
            fontSize: <span class="hljs-number">18</span>,
            fontWeight: FontWeight.bold,
          ),
        ),
        SizedBox(height: <span class="hljs-number">12</span>),
        ...services.take(<span class="hljs-number">5</span>).map((service) {
          <span class="hljs-keyword">return</span> Padding(
            padding: EdgeInsets.only(bottom: <span class="hljs-number">8</span>),
            child: MaintenanceServiceCard(
              service: service,
              onTap: () =&gt; _navigateToServiceDetail(service),
              onBookService: () =&gt; _bookService(service),
            ),
          );
        }).toList(),
        <span class="hljs-keyword">if</span> (services.length &gt; <span class="hljs-number">5</span>)
          TextButton(
            onPressed: () =&gt; _showAllUpcomingServices(services),
            child: Text(<span class="hljs-string">&#x27;查看全部 <span class="hljs-subst">${services.length}</span> 项&#x27;</span>),
          ),
      ],
    );
  }
}

<span class="hljs-comment">// 保养服务卡片组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceServiceCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> MaintenanceService service;
  <span class="hljs-keyword">final</span> VoidCallback? onTap;
  <span class="hljs-keyword">final</span> VoidCallback? onBookService;
  
  <span class="hljs-keyword">const</span> MaintenanceServiceCard({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.service,
    <span class="hljs-keyword">this</span>.onTap,
    <span class="hljs-keyword">this</span>.onBookService,
  }) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: EdgeInsets.all(<span class="hljs-number">16</span>),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Expanded(
                    child: Text(
                      service.name,
                      style: TextStyle(
                        fontSize: <span class="hljs-number">16</span>,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  Container(
                    padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">8</span>, vertical: <span class="hljs-number">4</span>),
                    decoration: BoxDecoration(
                      color: service.priorityColor.withOpacity(<span class="hljs-number">0.1</span>),
                      border: Border.all(color: service.priorityColor),
                      borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                    ),
                    child: Text(
                      service.priorityDisplayName,
                      style: TextStyle(
                        fontSize: <span class="hljs-number">12</span>,
                        color: service.priorityColor,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
              SizedBox(height: <span class="hljs-number">8</span>),
              Text(
                service.description,
                style: TextStyle(
                  fontSize: <span class="hljs-number">14</span>,
                  color: Colors.grey[<span class="hljs-number">600</span>],
                ),
              ),
              SizedBox(height: <span class="hljs-number">12</span>),
              Row(
                children: [
                  Icon(
                    Icons.calendar_today,
                    size: <span class="hljs-number">16</span>,
                    color: Colors.grey[<span class="hljs-number">600</span>],
                  ),
                  SizedBox(width: <span class="hljs-number">4</span>),
                  Text(
                    service.dueDate != <span class="hljs-keyword">null</span>
                        ? DateFormat(<span class="hljs-string">&#x27;yyyy-MM-dd&#x27;</span>).format(service.dueDate!)
                        : <span class="hljs-string">&#x27;根据里程&#x27;</span>,
                    style: TextStyle(
                      fontSize: <span class="hljs-number">12</span>,
                      color: Colors.grey[<span class="hljs-number">600</span>],
                    ),
                  ),
                  SizedBox(width: <span class="hljs-number">16</span>),
                  Icon(
                    Icons.attach_money,
                    size: <span class="hljs-number">16</span>,
                    color: Colors.grey[<span class="hljs-number">600</span>],
                  ),
                  SizedBox(width: <span class="hljs-number">4</span>),
                  Text(
                    <span class="hljs-string">&#x27;约 ¥<span class="hljs-subst">${service.estimatedCost.toStringAsFixed(<span class="hljs-number">0</span>)}</span>&#x27;</span>,
                    style: TextStyle(
                      fontSize: <span class="hljs-number">12</span>,
                      color: Colors.grey[<span class="hljs-number">600</span>],
                    ),
                  ),
                  Spacer(),
                  TextButton(
                    onPressed: onBookService,
                    child: Text(<span class="hljs-string">&#x27;预约&#x27;</span>),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 id="保养日历页面">保养日历页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 保养日历页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceCalendarPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleId;
  
  <span class="hljs-keyword">const</span> MaintenanceCalendarPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleId});
  
  <span class="hljs-meta">@override</span>
  _MaintenanceCalendarPageState createState() =&gt; _MaintenanceCalendarPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MaintenanceCalendarPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MaintenanceCalendarPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">DateTime</span> _selectedDay;
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">DateTime</span> _focusedDay;
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">DateTime</span>, <span class="hljs-built_in">List</span>&lt;MaintenanceEvent&gt;&gt; _events = {};
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _selectedDay = <span class="hljs-built_in">DateTime</span>.now();
    _focusedDay = <span class="hljs-built_in">DateTime</span>.now();
    _loadMaintenanceEvents();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">&#x27;保养日历&#x27;</span>),
        actions: [
          IconButton(
            icon: Icon(Icons.add),
            onPressed: () =&gt; _addMaintenanceEvent(),
          ),
        ],
      ),
      body: Column(
        children: [
          TableCalendar&lt;MaintenanceEvent&gt;(
            firstDay: <span class="hljs-built_in">DateTime</span>.utc(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
            lastDay: <span class="hljs-built_in">DateTime</span>.utc(<span class="hljs-number">2030</span>, <span class="hljs-number">12</span>, <span class="hljs-number">31</span>),
            focusedDay: _focusedDay,
            selectedDayPredicate: (day) =&gt; isSameDay(_selectedDay, day),
            eventLoader: (day) =&gt; _getEventsForDay(day),
            onDaySelected: (selectedDay, focusedDay) {
              setState(() {
                _selectedDay = selectedDay;
                _focusedDay = focusedDay;
              });
            },
            onPageChanged: (focusedDay) {
              _focusedDay = focusedDay;
            },
            calendarBuilders: CalendarBuilders(
              markerBuilder: (context, day, events) {
                <span class="hljs-keyword">if</span> (events.isNotEmpty) {
                  <span class="hljs-keyword">return</span> _buildEventMarkers(events.cast&lt;MaintenanceEvent&gt;());
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
              },
            ),
          ),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8.0</span>),
          Expanded(
            child: ListView.builder(
              itemCount: _getEventsForDay(_selectedDay).length,
              itemBuilder: (context, index) {
                <span class="hljs-keyword">final</span> event = _getEventsForDay(_selectedDay)[index];
                <span class="hljs-keyword">return</span> MaintenanceEventCard(
                  event: event,
                  onTap: () =&gt; _showEventDetail(event),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildEventMarkers(<span class="hljs-built_in">List</span>&lt;MaintenanceEvent&gt; events) {
    <span class="hljs-keyword">return</span> Row(
      mainAxisSize: MainAxisSize.min,
      children: events.take(<span class="hljs-number">3</span>).map((event) {
        <span class="hljs-keyword">return</span> Container(
          margin: EdgeInsets.only(top: <span class="hljs-number">5</span>, right: <span class="hljs-number">2</span>),
          width: <span class="hljs-number">6</span>,
          height: <span class="hljs-number">6</span>,
          decoration: BoxDecoration(
            color: event.type.color,
            shape: BoxShape.circle,
          ),
        );
      }).toList(),
    );
  }
}
</code></pre>
<h2 id="状态管理">状态管理</h2>
<h3 id="保养计划状态管理">保养计划状态管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 保养计划状态 BLoC</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenancePlanBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">MaintenancePlanEvent</span>, <span class="hljs-title">MaintenancePlanState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> MaintenancePlanService _planService;
  
  MaintenancePlanBloc(<span class="hljs-keyword">this</span>._planService) : <span class="hljs-keyword">super</span>(MaintenancePlanInitial()) {
    <span class="hljs-keyword">on</span>&lt;LoadMaintenancePlan&gt;(_onLoadMaintenancePlan);
    <span class="hljs-keyword">on</span>&lt;RefreshMaintenancePlan&gt;(_onRefreshMaintenancePlan);
    <span class="hljs-keyword">on</span>&lt;UpdateMaintenancePlan&gt;(_onUpdateMaintenancePlan);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onLoadMaintenancePlan(
    LoadMaintenancePlan event,
    Emitter&lt;MaintenancePlanState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(MaintenancePlanLoading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _planService.getVehicleMaintenancePlan(event.vehicleId);
    result.fold(
      (failure) =&gt; emit(MaintenancePlanError(failure.message)),
      (plan) =&gt; emit(MaintenancePlanLoaded(plan)),
    );
  }
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心依赖">核心依赖</h3>
<ul>
<li><strong>basic_modular</strong>: 模块化框架</li>
<li><strong>basic_intl</strong>: 国际化支持</li>
<li><strong>clr_maintenance</strong>: 维护保养服务 SDK</li>
<li><strong>clr_geo</strong>: 地理位置服务</li>
</ul>
<h3 id="ui-相关依赖">UI 相关依赖</h3>
<ul>
<li><strong>flutter_pickers</strong>: 选择器组件</li>
<li><strong>ui_mapview</strong>: 地图视图组件</li>
<li><strong>table_calendar</strong>: 日历组件</li>
<li><strong>scroll_to_index</strong>: 滚动定位组件</li>
</ul>
<h3 id="工具依赖">工具依赖</h3>
<ul>
<li><strong>dartz</strong>: 函数式编程支持</li>
<li><strong>freezed_annotation</strong>: 不可变类生成</li>
<li><strong>json_annotation</strong>: JSON 序列化</li>
<li><strong>url_launcher</strong>: 链接打开</li>
<li><strong>basic_track</strong>: 行为追踪</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="维护保养异常">维护保养异常</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 维护保养功能异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MaintenanceFailure</span> </span>{
  <span class="hljs-keyword">const</span> MaintenanceFailure();
  
  <span class="hljs-keyword">factory</span> MaintenanceFailure.vehicleNotFound() = VehicleNotFoundFailure;
  <span class="hljs-keyword">factory</span> MaintenanceFailure.planLoadFailed(<span class="hljs-built_in">String</span> message) = PlanLoadFailure;
  <span class="hljs-keyword">factory</span> MaintenanceFailure.appointmentCreationFailed(<span class="hljs-built_in">String</span> message) = AppointmentCreationFailure;
  <span class="hljs-keyword">factory</span> MaintenanceFailure.providerNotFound() = ProviderNotFoundFailure;
  <span class="hljs-keyword">factory</span> MaintenanceFailure.timeSlotNotAvailable() = TimeSlotNotAvailableFailure;
  <span class="hljs-keyword">factory</span> MaintenanceFailure.permissionDenied() = PermissionDeniedFailure;
}
</code></pre>
<h2 id="总结">总结</h2>
<p><code>app_maintenance</code> 模块为 OneApp 提供了完整的车辆维护保养解决方案，通过保养计划管理、服务预约、记录跟踪和统计分析，帮助用户科学合理地维护车辆。模块集成了地图服务、日历组件等功能，提供了直观易用的保养管理体验。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>