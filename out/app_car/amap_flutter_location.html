<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>AMap Flutter Location - &#x9ad8;&#x5fb7;&#x5730;&#x56fe;&#x5b9a;&#x4f4d;&#x63d2;&#x4ef6;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="amap-flutter-location---高德地图定位插件">AMap Flutter Location - 高德地图定位插件</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>amap_flutter_location</code> 是 OneApp 中基于高德地图 SDK 的定位服务插件，提供了高精度的位置定位、地理围栏、轨迹记录等功能。该插件为车辆定位、导航、位置服务等功能提供了可靠的地理位置支持。</p>
<h2 id="核心功能">核心功能</h2>
<h3 id="1-位置定位">1. 位置定位</h3>
<ul>
<li><strong>GPS 定位</strong>：基于 GPS 卫星的高精度定位</li>
<li><strong>网络定位</strong>：基于基站和 WiFi 的快速定位</li>
<li><strong>混合定位</strong>：GPS + 网络的融合定位算法</li>
<li><strong>室内定位</strong>：支持室内场景的位置识别</li>
</ul>
<h3 id="2-地理围栏">2. 地理围栏</h3>
<ul>
<li><strong>围栏创建</strong>：创建圆形、多边形地理围栏</li>
<li><strong>进出检测</strong>：实时检测设备进入/离开围栏</li>
<li><strong>多围栏管理</strong>：同时管理多个地理围栏</li>
<li><strong>事件通知</strong>：围栏事件的实时推送</li>
</ul>
<h3 id="3-轨迹记录">3. 轨迹记录</h3>
<ul>
<li><strong>轨迹采集</strong>：实时记录移动轨迹</li>
<li><strong>轨迹优化</strong>：去噪、平滑轨迹数据</li>
<li><strong>轨迹存储</strong>：本地和云端轨迹存储</li>
<li><strong>轨迹分析</strong>：距离、速度、停留点分析</li>
</ul>
<h3 id="4-位置服务">4. 位置服务</h3>
<ul>
<li><strong>逆地理编码</strong>：坐标转换为地址信息</li>
<li><strong>地理编码</strong>：地址转换为坐标信息</li>
<li><strong>POI 搜索</strong>：兴趣点搜索和信息获取</li>
<li><strong>距离计算</strong>：两点间距离和路径计算</li>
</ul>
<h2 id="技术架构">技术架构</h2>
<h3 id="架构设计">架构设计</h3>
<pre><code>┌─────────────────────────────────────┐
│            应用层                    │
│    (app_car, app_navigation)        │
├─────────────────────────────────────┤
│      AMap Flutter Location         │
│  ┌──────────┬──────────┬──────────┐ │
│  │ 定位管理 │ 围栏服务 │ 轨迹记录 │ │
│  ├──────────┼──────────┼──────────┤ │
│  │ 坐标转换 │ 事件处理 │ 数据存储 │ │
│  └──────────┴──────────┴──────────┘ │
├─────────────────────────────────────┤
│         高德地图 Native SDK         │
│  ┌──────────┬──────────┬──────────┐ │
│  │ Android  │   iOS    │ 定位引擎 │ │
│  └──────────┴──────────┴──────────┘ │
├─────────────────────────────────────┤
│           系统定位服务               │
│     (GPS, Network, Sensors)         │
└─────────────────────────────────────┘
</code></pre>
<h3 id="核心组件">核心组件</h3>
<h4 id="1-定位管理器-locationmanager">1. 定位管理器 (LocationManager)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMapLocationManager</span> </span>{
  <span class="hljs-comment">// 初始化定位服务</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; initialize(LocationConfig config);
  
  <span class="hljs-comment">// 开始定位</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; startLocation();
  
  <span class="hljs-comment">// 停止定位</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; stopLocation();
  
  <span class="hljs-comment">// 获取当前位置</span>
  Future&lt;AMapLocation&gt; getCurrentLocation();
  
  <span class="hljs-comment">// 设置定位参数</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; setLocationOption(LocationOption option);
}
</code></pre>
<h4 id="2-地理围栏管理器-geofencemanager">2. 地理围栏管理器 (GeofenceManager)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMapGeofenceManager</span> </span>{
  <span class="hljs-comment">// 添加围栏</span>
  Future&lt;<span class="hljs-built_in">String</span>&gt; addGeofence(GeofenceRegion region);
  
  <span class="hljs-comment">// 移除围栏</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; removeGeofence(<span class="hljs-built_in">String</span> geofenceId);
  
  <span class="hljs-comment">// 获取围栏列表</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;GeofenceRegion&gt;&gt; getGeofences();
  
  <span class="hljs-comment">// 开始围栏监控</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; startGeofenceMonitoring();
  
  <span class="hljs-comment">// 停止围栏监控</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; stopGeofenceMonitoring();
}
</code></pre>
<h4 id="3-轨迹记录器-trackrecorder">3. 轨迹记录器 (TrackRecorder)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMapTrackRecorder</span> </span>{
  <span class="hljs-comment">// 开始录制轨迹</span>
  Future&lt;<span class="hljs-built_in">String</span>&gt; startRecording(TrackConfig config);
  
  <span class="hljs-comment">// 停止录制轨迹</span>
  Future&lt;Track&gt; stopRecording(<span class="hljs-built_in">String</span> trackId);
  
  <span class="hljs-comment">// 暂停录制</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; pauseRecording(<span class="hljs-built_in">String</span> trackId);
  
  <span class="hljs-comment">// 恢复录制</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; resumeRecording(<span class="hljs-built_in">String</span> trackId);
  
  <span class="hljs-comment">// 获取轨迹数据</span>
  Future&lt;Track&gt; getTrack(<span class="hljs-built_in">String</span> trackId);
}
</code></pre>
<h4 id="4-坐标转换器-coordinateconverter">4. 坐标转换器 (CoordinateConverter)</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMapCoordinateConverter</span> </span>{
  <span class="hljs-comment">// 坐标系转换</span>
  LatLng convertCoordinate(LatLng source, CoordinateType from, CoordinateType to);
  
  <span class="hljs-comment">// 批量坐标转换</span>
  <span class="hljs-built_in">List</span>&lt;LatLng&gt; convertCoordinates(<span class="hljs-built_in">List</span>&lt;LatLng&gt; source, CoordinateType from, CoordinateType to);
  
  <span class="hljs-comment">// 逆地理编码</span>
  Future&lt;RegeocodeResult&gt; reverseGeocode(LatLng location);
  
  <span class="hljs-comment">// 地理编码</span>
  Future&lt;GeocodeResult&gt; geocode(<span class="hljs-built_in">String</span> address);
}
</code></pre>
<h2 id="数据模型">数据模型</h2>
<h3 id="位置模型">位置模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AMapLocation</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> latitude;        <span class="hljs-comment">// 纬度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> longitude;       <span class="hljs-comment">// 经度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> altitude;        <span class="hljs-comment">// 海拔</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> accuracy;        <span class="hljs-comment">// 精度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> speed;          <span class="hljs-comment">// 速度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> bearing;        <span class="hljs-comment">// 方向角</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;    <span class="hljs-comment">// 时间戳</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> address;        <span class="hljs-comment">// 地址信息</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> province;       <span class="hljs-comment">// 省份</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> city;          <span class="hljs-comment">// 城市</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> district;      <span class="hljs-comment">// 区县</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> street;        <span class="hljs-comment">// 街道</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> streetNumber;  <span class="hljs-comment">// 门牌号</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> aoiName;       <span class="hljs-comment">// AOI 名称</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> poiName;       <span class="hljs-comment">// POI 名称</span>
  <span class="hljs-keyword">final</span> LocationType locationType; <span class="hljs-comment">// 定位类型</span>
}

<span class="hljs-keyword">enum</span> LocationType {
  gps,              <span class="hljs-comment">// GPS 定位</span>
  network,          <span class="hljs-comment">// 网络定位</span>
  passive,          <span class="hljs-comment">// 被动定位</span>
  offline,          <span class="hljs-comment">// 离线定位</span>
  lastKnown         <span class="hljs-comment">// 上次定位</span>
}
</code></pre>
<h3 id="地理围栏模型">地理围栏模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeofenceRegion</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> GeofenceType type;
  <span class="hljs-keyword">final</span> LatLng center;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> radius;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;LatLng&gt; polygon;
  <span class="hljs-keyword">final</span> GeofenceAction action;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isEnabled;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; metadata;
}

<span class="hljs-keyword">enum</span> GeofenceType {
  circle,           <span class="hljs-comment">// 圆形围栏</span>
  polygon,          <span class="hljs-comment">// 多边形围栏</span>
  poi,             <span class="hljs-comment">// POI 围栏</span>
  district         <span class="hljs-comment">// 行政区围栏</span>
}

<span class="hljs-keyword">enum</span> GeofenceAction {
  enter,           <span class="hljs-comment">// 进入事件</span>
  exit,            <span class="hljs-comment">// 离开事件</span>
  dwell,           <span class="hljs-comment">// 停留事件</span>
  enterOrExit      <span class="hljs-comment">// 进入或离开</span>
}
</code></pre>
<h3 id="轨迹模型">轨迹模型</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Track</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> startTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> endTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;TrackPoint&gt; points;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalDistance;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> totalTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> averageSpeed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maxSpeed;
  <span class="hljs-keyword">final</span> TrackStatistics statistics;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrackPoint</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> latitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> longitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> altitude;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> speed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> bearing;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> accuracy;
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrackStatistics</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalDistance;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> totalTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> movingTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> pausedTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> averageSpeed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maxSpeed;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalAscent;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalDescent;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;StopPoint&gt; stopPoints;
}
</code></pre>
<h2 id="api-接口">API 接口</h2>
<h3 id="定位接口">定位接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocationService</span> </span>{
  <span class="hljs-comment">// 获取当前位置</span>
  Future&lt;ApiResponse&lt;AMapLocation&gt;&gt; getCurrentLocation();
  
  <span class="hljs-comment">// 开始连续定位</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; startContinuousLocation(LocationOption option);
  
  <span class="hljs-comment">// 停止连续定位</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; stopContinuousLocation();
  
  <span class="hljs-comment">// 获取定位权限状态</span>
  Future&lt;ApiResponse&lt;LocationPermission&gt;&gt; getLocationPermission();
  
  <span class="hljs-comment">// 请求定位权限</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; requestLocationPermission();
}
</code></pre>
<h3 id="地理围栏接口">地理围栏接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeofenceService</span> </span>{
  <span class="hljs-comment">// 创建地理围栏</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">String</span>&gt;&gt; createGeofence(CreateGeofenceRequest request);
  
  <span class="hljs-comment">// 删除地理围栏</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">bool</span>&gt;&gt; deleteGeofence(<span class="hljs-built_in">String</span> geofenceId);
  
  <span class="hljs-comment">// 获取围栏列表</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">List</span>&lt;GeofenceRegion&gt;&gt;&gt; getGeofences();
  
  <span class="hljs-comment">// 获取围栏状态</span>
  Future&lt;ApiResponse&lt;GeofenceStatus&gt;&gt; getGeofenceStatus(<span class="hljs-built_in">String</span> geofenceId);
}
</code></pre>
<h3 id="轨迹接口">轨迹接口</h3>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrackService</span> </span>{
  <span class="hljs-comment">// 开始轨迹记录</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">String</span>&gt;&gt; startTrackRecording(TrackConfig config);
  
  <span class="hljs-comment">// 停止轨迹记录</span>
  Future&lt;ApiResponse&lt;Track&gt;&gt; stopTrackRecording(<span class="hljs-built_in">String</span> trackId);
  
  <span class="hljs-comment">// 获取轨迹数据</span>
  Future&lt;ApiResponse&lt;Track&gt;&gt; getTrack(<span class="hljs-built_in">String</span> trackId);
  
  <span class="hljs-comment">// 获取轨迹列表</span>
  Future&lt;ApiResponse&lt;<span class="hljs-built_in">List</span>&lt;TrackSummary&gt;&gt;&gt; getTrackList(TrackQuery query);
}
</code></pre>
<h2 id="配置管理">配置管理</h2>
<h3 id="定位配置">定位配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocationOption</span> </span>{
  <span class="hljs-keyword">final</span> LocationMode locationMode;         <span class="hljs-comment">// 定位模式</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> interval;                     <span class="hljs-comment">// 定位间隔（毫秒）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> needAddress;                 <span class="hljs-comment">// 是否需要地址信息</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> mockEnable;                  <span class="hljs-comment">// 是否允许模拟位置</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> wifiScan;                    <span class="hljs-comment">// 是否开启 WiFi 扫描</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> gpsFirst;                    <span class="hljs-comment">// 是否 GPS 优先</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> httpTimeOut;                  <span class="hljs-comment">// 网络超时时间</span>
  <span class="hljs-keyword">final</span> LocationPurpose locationPurpose;  <span class="hljs-comment">// 定位目的</span>
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> LocationOption defaultOption = LocationOption(
    locationMode: LocationMode.hightAccuracy,
    interval: <span class="hljs-number">2000</span>,
    needAddress: <span class="hljs-keyword">true</span>,
    mockEnable: <span class="hljs-keyword">false</span>,
    wifiScan: <span class="hljs-keyword">true</span>,
    gpsFirst: <span class="hljs-keyword">false</span>,
    httpTimeOut: <span class="hljs-number">30000</span>,
    locationPurpose: LocationPurpose.signIn,
  );
}

<span class="hljs-keyword">enum</span> LocationMode {
  batterySaving,    <span class="hljs-comment">// 低功耗模式</span>
  deviceSensors,    <span class="hljs-comment">// 仅设备传感器</span>
  hightAccuracy     <span class="hljs-comment">// 高精度模式</span>
}
</code></pre>
<h3 id="围栏配置">围栏配置</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeofenceConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enableNotification;    <span class="hljs-comment">// 是否启用通知</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> dwellDelay;            <span class="hljs-comment">// 停留延迟（毫秒）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minimumRadius;      <span class="hljs-comment">// 最小围栏半径</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maximumRadius;      <span class="hljs-comment">// 最大围栏半径</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> maxGeofenceCount;      <span class="hljs-comment">// 最大围栏数量</span>
  
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GeofenceConfig defaultConfig = GeofenceConfig(
    enableNotification: <span class="hljs-keyword">true</span>,
    dwellDelay: <span class="hljs-number">10000</span>,
    minimumRadius: <span class="hljs-number">50.0</span>,
    maximumRadius: <span class="hljs-number">100000.0</span>,
    maxGeofenceCount: <span class="hljs-number">100</span>,
  );
}
</code></pre>
<h2 id="使用示例">使用示例</h2>
<h3 id="基本定位示例">基本定位示例</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 初始化定位服务</span>
<span class="hljs-keyword">final</span> locationManager = AMapLocationManager.instance;
<span class="hljs-keyword">await</span> locationManager.initialize(LocationConfig.defaultConfig);

<span class="hljs-comment">// 设置定位参数</span>
<span class="hljs-keyword">await</span> locationManager.setLocationOption(LocationOption.defaultOption);

<span class="hljs-comment">// 监听位置变化</span>
locationManager.onLocationChanged.listen((location) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;当前位置: <span class="hljs-subst">${location.latitude}</span>, <span class="hljs-subst">${location.longitude}</span>&#x27;</span>);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;地址: <span class="hljs-subst">${location.address}</span>&#x27;</span>);
});

<span class="hljs-comment">// 开始定位</span>
<span class="hljs-keyword">await</span> locationManager.startLocation();
</code></pre>
<h3 id="地理围栏示例">地理围栏示例</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 创建圆形围栏</span>
<span class="hljs-keyword">final</span> geofence = GeofenceRegion(
  id: <span class="hljs-string">&#x27;home_fence&#x27;</span>,
  name: <span class="hljs-string">&#x27;家庭围栏&#x27;</span>,
  type: GeofenceType.circle,
  center: LatLng(<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>), <span class="hljs-comment">// 北京天安门</span>
  radius: <span class="hljs-number">500.0</span>, <span class="hljs-comment">// 500米半径</span>
  action: GeofenceAction.enterOrExit,
  isEnabled: <span class="hljs-keyword">true</span>,
);

<span class="hljs-comment">// 添加围栏</span>
<span class="hljs-keyword">final</span> geofenceManager = AMapGeofenceManager.instance;
<span class="hljs-keyword">final</span> fenceId = <span class="hljs-keyword">await</span> geofenceManager.addGeofence(geofence);

<span class="hljs-comment">// 监听围栏事件</span>
geofenceManager.onGeofenceTriggered.listen((event) {
  <span class="hljs-keyword">switch</span> (event.action) {
    <span class="hljs-keyword">case</span> GeofenceAction.enter:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;进入围栏: <span class="hljs-subst">${event.geofenceId}</span>&#x27;</span>);
      <span class="hljs-comment">// 执行进入围栏的逻辑</span>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> GeofenceAction.exit:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;离开围栏: <span class="hljs-subst">${event.geofenceId}</span>&#x27;</span>);
      <span class="hljs-comment">// 执行离开围栏的逻辑</span>
      <span class="hljs-keyword">break</span>;
  }
});

<span class="hljs-comment">// 开始围栏监控</span>
<span class="hljs-keyword">await</span> geofenceManager.startGeofenceMonitoring();
</code></pre>
<h3 id="轨迹记录示例">轨迹记录示例</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 配置轨迹记录</span>
<span class="hljs-keyword">final</span> trackConfig = TrackConfig(
  name: <span class="hljs-string">&#x27;上班路线&#x27;</span>,
  minDistance: <span class="hljs-number">10.0</span>,    <span class="hljs-comment">// 最小记录距离</span>
  minTime: <span class="hljs-number">5000</span>,        <span class="hljs-comment">// 最小记录时间间隔</span>
  enableOptimization: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 启用轨迹优化</span>
);

<span class="hljs-comment">// 开始记录轨迹</span>
<span class="hljs-keyword">final</span> trackRecorder = AMapTrackRecorder.instance;
<span class="hljs-keyword">final</span> trackId = <span class="hljs-keyword">await</span> trackRecorder.startRecording(trackConfig);

<span class="hljs-comment">// 监听轨迹点</span>
trackRecorder.onTrackPointAdded.listen((point) {
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;新轨迹点: <span class="hljs-subst">${point.latitude}</span>, <span class="hljs-subst">${point.longitude}</span>&#x27;</span>);
});

<span class="hljs-comment">// 停止记录并获取轨迹</span>
<span class="hljs-keyword">final</span> track = <span class="hljs-keyword">await</span> trackRecorder.stopRecording(trackId);
<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;轨迹总距离: <span class="hljs-subst">${track.totalDistance}</span>米&#x27;</span>);
<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;轨迹总时间: <span class="hljs-subst">${track.totalTime}</span>&#x27;</span>);
</code></pre>
<h3 id="坐标转换示例">坐标转换示例</h3>
<pre><code class="language-dart"><span class="hljs-comment">// WGS84 坐标转换为 GCJ02 坐标</span>
<span class="hljs-keyword">final</span> wgs84Point = LatLng(<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>);
<span class="hljs-keyword">final</span> gcj02Point = AMapCoordinateConverter.convertCoordinate(
  wgs84Point,
  CoordinateType.wgs84,
  CoordinateType.gcj02,
);

<span class="hljs-comment">// 逆地理编码</span>
<span class="hljs-keyword">final</span> regeocodeResult = <span class="hljs-keyword">await</span> AMapCoordinateConverter.reverseGeocode(gcj02Point);
<span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;地址: <span class="hljs-subst">${regeocodeResult.formattedAddress}</span>&#x27;</span>);

<span class="hljs-comment">// 地理编码</span>
<span class="hljs-keyword">final</span> geocodeResult = <span class="hljs-keyword">await</span> AMapCoordinateConverter.geocode(<span class="hljs-string">&#x27;北京市天安门广场&#x27;</span>);
<span class="hljs-keyword">if</span> (geocodeResult.geocodes.isNotEmpty) {
  <span class="hljs-keyword">final</span> location = geocodeResult.geocodes.first.location;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;坐标: <span class="hljs-subst">${location.latitude}</span>, <span class="hljs-subst">${location.longitude}</span>&#x27;</span>);
}
</code></pre>
<h2 id="测试策略">测试策略</h2>
<h3 id="单元测试">单元测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;AMapLocation Tests&#x27;</span>, () {
  test(<span class="hljs-string">&#x27;should convert coordinates correctly&#x27;</span>, () {
    <span class="hljs-comment">// Given</span>
    <span class="hljs-keyword">final</span> wgs84Point = LatLng(<span class="hljs-number">39.9042</span>, <span class="hljs-number">116.4074</span>);
    
    <span class="hljs-comment">// When</span>
    <span class="hljs-keyword">final</span> gcj02Point = AMapCoordinateConverter.convertCoordinate(
      wgs84Point,
      CoordinateType.wgs84,
      CoordinateType.gcj02,
    );
    
    <span class="hljs-comment">// Then</span>
    expect(gcj02Point.latitude, isNot(equals(wgs84Point.latitude)));
    expect(gcj02Point.longitude, isNot(equals(wgs84Point.longitude)));
  });
});
</code></pre>
<h3 id="集成测试">集成测试</h3>
<pre><code class="language-dart">group(<span class="hljs-string">&#x27;Location Integration Tests&#x27;</span>, () {
  testWidgets(<span class="hljs-string">&#x27;location service flow&#x27;</span>, (tester) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 1. 初始化定位服务</span>
    <span class="hljs-keyword">await</span> AMapLocationManager.instance.initialize(LocationConfig.defaultConfig);
    
    <span class="hljs-comment">// 2. 开始定位</span>
    <span class="hljs-keyword">await</span> AMapLocationManager.instance.startLocation();
    
    <span class="hljs-comment">// 3. 等待定位结果</span>
    <span class="hljs-keyword">final</span> location = <span class="hljs-keyword">await</span> AMapLocationManager.instance.getCurrentLocation();
    
    <span class="hljs-comment">// 4. 验证定位结果</span>
    expect(location.latitude, greaterThan(<span class="hljs-number">-90</span>));
    expect(location.latitude, lessThan(<span class="hljs-number">90</span>));
    expect(location.longitude, greaterThan(<span class="hljs-number">-180</span>));
    expect(location.longitude, lessThan(<span class="hljs-number">180</span>));
  });
});
</code></pre>
<h2 id="性能优化">性能优化</h2>
<h3 id="定位优化">定位优化</h3>
<ul>
<li><strong>智能定位策略</strong>：根据场景自动选择最佳定位方式</li>
<li><strong>缓存机制</strong>：缓存最近的定位结果</li>
<li><strong>批量处理</strong>：批量处理定位请求</li>
<li><strong>省电模式</strong>：低功耗的定位策略</li>
</ul>
<h3 id="数据优化">数据优化</h3>
<ul>
<li><strong>数据压缩</strong>：压缩轨迹数据减少存储空间</li>
<li><strong>增量同步</strong>：只同步变化的数据</li>
<li><strong>本地缓存</strong>：本地缓存常用的地理信息</li>
<li><strong>数据清理</strong>：定期清理过期的轨迹数据</li>
</ul>
<h2 id="权限管理">权限管理</h2>
<h3 id="位置权限">位置权限</h3>
<pre><code class="language-dart"><span class="hljs-keyword">enum</span> LocationPermission {
  denied,           <span class="hljs-comment">// 拒绝</span>
  deniedForever,    <span class="hljs-comment">// 永久拒绝</span>
  whileInUse,       <span class="hljs-comment">// 使用时允许</span>
  always            <span class="hljs-comment">// 始终允许</span>
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PermissionManager</span> </span>{
  <span class="hljs-comment">// 检查权限状态</span>
  <span class="hljs-keyword">static</span> Future&lt;LocationPermission&gt; checkPermission();
  
  <span class="hljs-comment">// 请求权限</span>
  <span class="hljs-keyword">static</span> Future&lt;LocationPermission&gt; requestPermission();
  
  <span class="hljs-comment">// 打开应用设置</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">bool</span>&gt; openAppSettings();
}
</code></pre>
<h3 id="权限处理示例">权限处理示例</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 检查和请求位置权限</span>
<span class="hljs-keyword">final</span> permission = <span class="hljs-keyword">await</span> PermissionManager.checkPermission();

<span class="hljs-keyword">if</span> (permission == LocationPermission.denied) {
  <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> PermissionManager.requestPermission();
  <span class="hljs-keyword">if</span> (result != LocationPermission.whileInUse &amp;&amp; 
      result != LocationPermission.always) {
    <span class="hljs-comment">// 权限被拒绝，显示说明或引导用户到设置页面</span>
    <span class="hljs-keyword">await</span> showPermissionDialog();
    <span class="hljs-keyword">return</span>;
  }
}

<span class="hljs-comment">// 权限获取成功，开始定位</span>
<span class="hljs-keyword">await</span> startLocationService();
</code></pre>
<h2 id="错误处理">错误处理</h2>
<h3 id="定位错误类型">定位错误类型</h3>
<pre><code class="language-dart"><span class="hljs-keyword">enum</span> LocationErrorType {
  permissionDenied,     <span class="hljs-comment">// 权限被拒绝</span>
  locationServiceDisabled, <span class="hljs-comment">// 定位服务未开启</span>
  networkError,         <span class="hljs-comment">// 网络错误</span>
  timeout,             <span class="hljs-comment">// 超时</span>
  unknownError         <span class="hljs-comment">// 未知错误</span>
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocationException</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Exception</span> </span>{
  <span class="hljs-keyword">final</span> LocationErrorType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> errorCode;
  
  <span class="hljs-keyword">const</span> LocationException(<span class="hljs-keyword">this</span>.type, <span class="hljs-keyword">this</span>.message, [<span class="hljs-keyword">this</span>.errorCode]);
}
</code></pre>
<h2 id="隐私和安全">隐私和安全</h2>
<h3 id="数据隐私">数据隐私</h3>
<ul>
<li><strong>最小权限原则</strong>：只请求必要的定位权限</li>
<li><strong>数据加密</strong>：敏感位置数据加密存储</li>
<li><strong>用户控制</strong>：用户可以随时关闭定位服务</li>
<li><strong>透明度</strong>：明确告知用户数据使用目的</li>
</ul>
<h3 id="安全措施">安全措施</h3>
<ul>
<li><strong>防伪造</strong>：检测和过滤伪造的 GPS 信号</li>
<li><strong>数据校验</strong>：验证定位数据的有效性</li>
<li><strong>传输安全</strong>：使用 HTTPS 传输位置数据</li>
<li><strong>访问控制</strong>：严格控制位置数据的访问权限</li>
</ul>
<h2 id="版本历史">版本历史</h2>
<h3 id="v303-当前版本">v3.0.3 (当前版本)</h3>
<ul>
<li>支持 iOS 16 和 Android 13</li>
<li>优化定位精度和速度</li>
<li>修复地理围栏稳定性问题</li>
<li>改进轨迹记录算法</li>
</ul>
<h3 id="v302">v3.0.2</h3>
<ul>
<li>新增室内定位支持</li>
<li>优化电池使用效率</li>
<li>支持自定义坐标系</li>
<li>修复内存泄漏问题</li>
</ul>
<h2 id="依赖关系">依赖关系</h2>
<h3 id="内部依赖">内部依赖</h3>
<ul>
<li><code>basic_platform</code>: 平台抽象层</li>
<li><code>basic_storage</code>: 本地存储服务</li>
<li><code>basic_network</code>: 网络请求服务</li>
</ul>
<h3 id="外部依赖">外部依赖</h3>
<ul>
<li><code>permission_handler</code>: 权限管理</li>
<li><code>geolocator</code>: 位置服务补充</li>
<li><code>path_provider</code>: 文件路径管理</li>
</ul>
<h2 id="总结">总结</h2>
<p><code>amap_flutter_location</code> 作为高德地图定位服务的 Flutter 插件，为 OneApp 提供了可靠、高效的位置服务能力。通过集成 GPS、网络定位、地理围栏、轨迹记录等功能，该插件能够满足车辆定位、导航、位置服务等多种业务需求。</p>
<p>插件在设计上充分考虑了性能优化、隐私保护、权限管理等关键因素，确保在提供精准位置服务的同时，保护用户隐私和设备安全。这为 OneApp 的车联网服务提供了坚实的技术基础。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>