<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>App Order - &#x8ba2;&#x5355;&#x7ba1;&#x7406;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="app-order---订单管理模块文档">App Order - 订单管理模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>app_order</code> 是 OneApp 车辆模块群中的订单管理核心模块，提供完整的订单生命周期管理，包括订单创建、支付处理、状态跟踪、订单历史等功能。该模块与支付系统、账户系统深度集成，为用户提供统一的订单管理体验。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: app_order</li>
<li><strong>版本</strong>: 0.2.15+1</li>
<li><strong>仓库</strong>: <a href="https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-order">https://gitlab-rd0.maezia.com/dssomobile/oneapp/dssomobile-oneapp-app-order</a></li>
<li><strong>Flutter 版本</strong>: &gt;=3.10.0</li>
<li><strong>Dart 版本</strong>: &gt;=2.16.2 &lt;4.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>app_order/
├── lib/
│   ├── app_order.dart            # 主导出文件
│   └── src/                      # 源代码目录
│       ├── pages/                # 订单页面
│       ├── widgets/              # 订单组件
│       ├── models/               # 数据模型
│       ├── services/             # 服务层
│       ├── blocs/                # 状态管理
│       ├── utils/                # 工具类
│       └── constants/            # 常量定义
├── assets/                       # 静态资源
├── uml.puml/png/svg             # UML 设计图
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-订单创建与管理">1. 订单创建与管理</h3>
<h4 id="订单创建服务">订单创建服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 订单创建服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderCreationService</span> </span>{
  <span class="hljs-keyword">final</span> OrderRepository _repository;
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  <span class="hljs-keyword">final</span> AccountService _accountService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  OrderCreationService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._paymentService,
    <span class="hljs-keyword">this</span>._accountService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 创建订单</span>
  Future&lt;Result&lt;Order&gt;&gt; createOrder({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> OrderType type,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;OrderItem&gt; items,
    <span class="hljs-keyword">required</span> DeliveryInfo deliveryInfo,
    <span class="hljs-built_in">String?</span> couponCode,
    <span class="hljs-built_in">String?</span> notes,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 验证用户账户</span>
      <span class="hljs-keyword">final</span> accountResult = <span class="hljs-keyword">await</span> _accountService.validateAccount(userId);
      <span class="hljs-keyword">if</span> (accountResult.isLeft()) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.accountValidationFailed());
      }
      
      <span class="hljs-comment">// 2. 计算订单金额</span>
      <span class="hljs-keyword">final</span> pricing = <span class="hljs-keyword">await</span> _calculateOrderPricing(
        items: items,
        couponCode: couponCode,
        deliveryInfo: deliveryInfo,
      );
      
      <span class="hljs-comment">// 3. 创建订单</span>
      <span class="hljs-keyword">final</span> order = Order(
        id: generateOrderId(),
        userId: userId,
        type: type,
        items: items,
        deliveryInfo: deliveryInfo,
        pricing: pricing,
        status: OrderStatus.pending,
        couponCode: couponCode,
        notes: notes,
        metadata: metadata,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
        updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-comment">// 4. 保存订单</span>
      <span class="hljs-keyword">await</span> _repository.createOrder(order);
      
      <span class="hljs-comment">// 5. 发送订单创建通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendOrderCreatedNotification(
        userId: userId,
        order: order,
      );
      
      <span class="hljs-keyword">return</span> Right(order);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.creationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 计算订单价格</span>
  Future&lt;OrderPricing&gt; _calculateOrderPricing({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;OrderItem&gt; items,
    <span class="hljs-built_in">String?</span> couponCode,
    <span class="hljs-keyword">required</span> DeliveryInfo deliveryInfo,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-built_in">double</span> subtotal = items.fold(<span class="hljs-number">0.0</span>, (sum, item) =&gt; sum + item.totalPrice);
    
    <span class="hljs-comment">// 计算优惠券折扣</span>
    <span class="hljs-built_in">double</span> discount = <span class="hljs-number">0.0</span>;
    <span class="hljs-keyword">if</span> (couponCode != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">final</span> coupon = <span class="hljs-keyword">await</span> _repository.validateCoupon(couponCode);
      <span class="hljs-keyword">if</span> (coupon != <span class="hljs-keyword">null</span> &amp;&amp; coupon.isValid) {
        discount = coupon.calculateDiscount(subtotal);
      }
    }
    
    <span class="hljs-comment">// 计算配送费</span>
    <span class="hljs-built_in">double</span> deliveryFee = <span class="hljs-keyword">await</span> _calculateDeliveryFee(deliveryInfo, subtotal);
    
    <span class="hljs-comment">// 计算税费</span>
    <span class="hljs-built_in">double</span> tax = _calculateTax(subtotal - discount, deliveryInfo.address);
    
    <span class="hljs-built_in">double</span> total = subtotal - discount + deliveryFee + tax;
    
    <span class="hljs-keyword">return</span> OrderPricing(
      subtotal: subtotal,
      discount: discount,
      deliveryFee: deliveryFee,
      tax: tax,
      total: total,
    );
  }
  
  <span class="hljs-comment">// 取消订单</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; cancelOrder({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> orderId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> reason,
    <span class="hljs-built_in">String?</span> userId,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> order = <span class="hljs-keyword">await</span> _repository.getOrderById(orderId);
      <span class="hljs-keyword">if</span> (order == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.orderNotFound());
      }
      
      <span class="hljs-comment">// 检查取消权限</span>
      <span class="hljs-keyword">if</span> (userId != <span class="hljs-keyword">null</span> &amp;&amp; order.userId != userId) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.permissionDenied());
      }
      
      <span class="hljs-comment">// 检查订单状态是否允许取消</span>
      <span class="hljs-keyword">if</span> (!order.canBeCancelled) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.cannotBeCancelled());
      }
      
      <span class="hljs-comment">// 处理退款</span>
      <span class="hljs-keyword">if</span> (order.isPaid) {
        <span class="hljs-keyword">final</span> refundResult = <span class="hljs-keyword">await</span> _paymentService.processRefund(
          orderId: orderId,
          amount: order.pricing.total,
          reason: reason,
        );
        
        <span class="hljs-keyword">if</span> (refundResult.isLeft()) {
          <span class="hljs-keyword">return</span> Left(OrderFailure.refundFailed());
        }
      }
      
      <span class="hljs-comment">// 更新订单状态</span>
      <span class="hljs-keyword">await</span> _repository.updateOrderStatus(
        orderId: orderId,
        status: OrderStatus.cancelled,
        reason: reason,
        updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.cancellationFailed(e.toString()));
    }
  }
}
</code></pre>
<h3 id="2-订单支付处理">2. 订单支付处理</h3>
<h4 id="支付集成服务">支付集成服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 订单支付服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderPaymentService</span> </span>{
  <span class="hljs-keyword">final</span> PaymentService _paymentService;
  <span class="hljs-keyword">final</span> OrderRepository _repository;
  
  OrderPaymentService(<span class="hljs-keyword">this</span>._paymentService, <span class="hljs-keyword">this</span>._repository);
  
  <span class="hljs-comment">// 处理订单支付</span>
  Future&lt;Result&lt;PaymentResult&gt;&gt; processOrderPayment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> orderId,
    <span class="hljs-keyword">required</span> PaymentMethod paymentMethod,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? paymentData,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> order = <span class="hljs-keyword">await</span> _repository.getOrderById(orderId);
      <span class="hljs-keyword">if</span> (order == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.orderNotFound());
      }
      
      <span class="hljs-keyword">if</span> (order.status != OrderStatus.pending) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.orderNotPayable());
      }
      
      <span class="hljs-comment">// 创建支付请求</span>
      <span class="hljs-keyword">final</span> paymentRequest = PaymentRequest(
        orderId: orderId,
        amount: order.pricing.total,
        currency: <span class="hljs-string">&#x27;CNY&#x27;</span>,
        paymentMethod: paymentMethod,
        description: <span class="hljs-string">&#x27;订单支付 - <span class="hljs-subst">${order.id}</span>&#x27;</span>,
        metadata: {
          <span class="hljs-string">&#x27;order_id&#x27;</span>: orderId,
          <span class="hljs-string">&#x27;user_id&#x27;</span>: order.userId,
          <span class="hljs-string">&#x27;order_type&#x27;</span>: order.type.toString(),
        },
        additionalData: paymentData,
      );
      
      <span class="hljs-comment">// 处理支付</span>
      <span class="hljs-keyword">final</span> paymentResult = <span class="hljs-keyword">await</span> _paymentService.processPayment(paymentRequest);
      
      <span class="hljs-keyword">return</span> paymentResult.fold(
        (failure) =&gt; Left(OrderFailure.paymentFailed(failure.message)),
        (result) <span class="hljs-keyword">async</span> {
          <span class="hljs-comment">// 更新订单支付状态</span>
          <span class="hljs-keyword">await</span> _updateOrderPaymentStatus(orderId, result);
          <span class="hljs-keyword">return</span> Right(result);
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.paymentProcessingFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 更新订单支付状态</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _updateOrderPaymentStatus(
    <span class="hljs-built_in">String</span> orderId,
    PaymentResult paymentResult,
  ) <span class="hljs-keyword">async</span> {
    OrderStatus newStatus;
    <span class="hljs-keyword">switch</span> (paymentResult.status) {
      <span class="hljs-keyword">case</span> PaymentStatus.success:
        newStatus = OrderStatus.paid;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> PaymentStatus.pending:
        newStatus = OrderStatus.paymentPending;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> PaymentStatus.failed:
        newStatus = OrderStatus.paymentFailed;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> PaymentStatus.cancelled:
        newStatus = OrderStatus.pending;
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-keyword">await</span> _repository.updateOrderPayment(
      orderId: orderId,
      paymentId: paymentResult.paymentId,
      paymentStatus: paymentResult.status,
      orderStatus: newStatus,
      paidAt: paymentResult.status == PaymentStatus.success 
          ? <span class="hljs-built_in">DateTime</span>.now() 
          : <span class="hljs-keyword">null</span>,
    );
  }
  
  <span class="hljs-comment">// 验证支付结果</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; verifyPayment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> orderId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> paymentId,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> verificationResult = <span class="hljs-keyword">await</span> _paymentService.verifyPayment(paymentId);
      
      <span class="hljs-keyword">return</span> verificationResult.fold(
        (failure) =&gt; Left(OrderFailure.paymentVerificationFailed()),
        (isValid) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">if</span> (isValid) {
            <span class="hljs-keyword">await</span> _repository.updateOrderStatus(
              orderId: orderId,
              status: OrderStatus.paid,
              updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
            );
            <span class="hljs-keyword">return</span> Right(unit);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">await</span> _repository.updateOrderStatus(
              orderId: orderId,
              status: OrderStatus.paymentFailed,
              updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
            );
            <span class="hljs-keyword">return</span> Left(OrderFailure.paymentVerificationFailed());
          }
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.verificationError(e.toString()));
    }
  }
}
</code></pre>
<h3 id="3-订单状态跟踪">3. 订单状态跟踪</h3>
<h4 id="订单状态管理服务">订单状态管理服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 订单状态跟踪服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderTrackingService</span> </span>{
  <span class="hljs-keyword">final</span> OrderRepository _repository;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  <span class="hljs-keyword">final</span> LogisticsService _logisticsService;
  
  OrderTrackingService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._notificationService,
    <span class="hljs-keyword">this</span>._logisticsService,
  );
  
  <span class="hljs-comment">// 更新订单状态</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; updateOrderStatus({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> orderId,
    <span class="hljs-keyword">required</span> OrderStatus newStatus,
    <span class="hljs-built_in">String?</span> operatorId,
    <span class="hljs-built_in">String?</span> notes,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> order = <span class="hljs-keyword">await</span> _repository.getOrderById(orderId);
      <span class="hljs-keyword">if</span> (order == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.orderNotFound());
      }
      
      <span class="hljs-comment">// 验证状态转换的合法性</span>
      <span class="hljs-keyword">if</span> (!_isValidStatusTransition(order.status, newStatus)) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.invalidStatusTransition());
      }
      
      <span class="hljs-comment">// 创建状态历史记录</span>
      <span class="hljs-keyword">final</span> statusHistory = OrderStatusHistory(
        id: generateId(),
        orderId: orderId,
        fromStatus: order.status,
        toStatus: newStatus,
        operatorId: operatorId,
        notes: notes,
        metadata: metadata,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-comment">// 更新订单状态</span>
      <span class="hljs-keyword">await</span> _repository.updateOrderStatusWithHistory(
        orderId: orderId,
        newStatus: newStatus,
        statusHistory: statusHistory,
        updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-comment">// 执行状态相关的业务逻辑</span>
      <span class="hljs-keyword">await</span> _executeStatusChangeActions(order, newStatus);
      
      <span class="hljs-comment">// 发送状态更新通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendOrderStatusUpdateNotification(
        userId: order.userId,
        orderId: orderId,
        newStatus: newStatus,
      );
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.statusUpdateFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取订单跟踪信息</span>
  Future&lt;Result&lt;OrderTrackingInfo&gt;&gt; getOrderTracking(<span class="hljs-built_in">String</span> orderId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> order = <span class="hljs-keyword">await</span> _repository.getOrderById(orderId);
      <span class="hljs-keyword">if</span> (order == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(OrderFailure.orderNotFound());
      }
      
      <span class="hljs-keyword">final</span> statusHistory = <span class="hljs-keyword">await</span> _repository.getOrderStatusHistory(orderId);
      
      <span class="hljs-comment">// 获取物流信息（如果有）</span>
      LogisticsInfo? logisticsInfo;
      <span class="hljs-keyword">if</span> (order.trackingNumber != <span class="hljs-keyword">null</span>) {
        logisticsInfo = <span class="hljs-keyword">await</span> _logisticsService.getLogisticsInfo(
          order.trackingNumber!,
        );
      }
      
      <span class="hljs-keyword">final</span> trackingInfo = OrderTrackingInfo(
        order: order,
        statusHistory: statusHistory,
        logisticsInfo: logisticsInfo,
        estimatedDelivery: _calculateEstimatedDelivery(order),
      );
      
      <span class="hljs-keyword">return</span> Right(trackingInfo);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(OrderFailure.trackingLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 验证状态转换合法性</span>
  <span class="hljs-built_in">bool</span> _isValidStatusTransition(OrderStatus fromStatus, OrderStatus toStatus) {
    <span class="hljs-keyword">final</span> validTransitions = {
      OrderStatus.pending: [
        OrderStatus.paid,
        OrderStatus.paymentFailed,
        OrderStatus.cancelled,
      ],
      OrderStatus.paid: [
        OrderStatus.processing,
        OrderStatus.cancelled,
      ],
      OrderStatus.processing: [
        OrderStatus.shipped,
        OrderStatus.cancelled,
      ],
      OrderStatus.shipped: [
        OrderStatus.delivered,
        OrderStatus.returnRequested,
      ],
      OrderStatus.delivered: [
        OrderStatus.completed,
        OrderStatus.returnRequested,
      ],
      <span class="hljs-comment">// ... 其他状态转换规则</span>
    };
    
    <span class="hljs-keyword">return</span> validTransitions[fromStatus]?.contains(toStatus) ?? <span class="hljs-keyword">false</span>;
  }
  
  <span class="hljs-comment">// 执行状态变更相关操作</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _executeStatusChangeActions(
    Order order,
    OrderStatus newStatus,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">switch</span> (newStatus) {
      <span class="hljs-keyword">case</span> OrderStatus.paid:
        <span class="hljs-keyword">await</span> _onOrderPaid(order);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> OrderStatus.shipped:
        <span class="hljs-keyword">await</span> _onOrderShipped(order);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> OrderStatus.delivered:
        <span class="hljs-keyword">await</span> _onOrderDelivered(order);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> OrderStatus.completed:
        <span class="hljs-keyword">await</span> _onOrderCompleted(order);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 id="4-订单数据模型">4. 订单数据模型</h3>
<h4 id="核心订单模型">核心订单模型</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 订单模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> OrderType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;OrderItem&gt; items;
  <span class="hljs-keyword">final</span> DeliveryInfo deliveryInfo;
  <span class="hljs-keyword">final</span> OrderPricing pricing;
  <span class="hljs-keyword">final</span> OrderStatus status;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> couponCode;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> notes;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> updatedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> paidAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> shippedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> deliveredAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> completedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> paymentId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> trackingNumber;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;OrderStatusHistory&gt; statusHistory;
  
  <span class="hljs-keyword">const</span> Order({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.items,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.deliveryInfo,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pricing,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">this</span>.couponCode,
    <span class="hljs-keyword">this</span>.notes,
    <span class="hljs-keyword">this</span>.metadata,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.updatedAt,
    <span class="hljs-keyword">this</span>.paidAt,
    <span class="hljs-keyword">this</span>.shippedAt,
    <span class="hljs-keyword">this</span>.deliveredAt,
    <span class="hljs-keyword">this</span>.completedAt,
    <span class="hljs-keyword">this</span>.paymentId,
    <span class="hljs-keyword">this</span>.trackingNumber,
    <span class="hljs-keyword">this</span>.statusHistory = <span class="hljs-keyword">const</span> [],
  });
  
  <span class="hljs-comment">// 业务逻辑方法</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isPaid =&gt; status.index &gt;= OrderStatus.paid.index;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isShipped =&gt; status.index &gt;= OrderStatus.shipped.index;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isDelivered =&gt; status.index &gt;= OrderStatus.delivered.index;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isCompleted =&gt; status == OrderStatus.completed;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isCancelled =&gt; status == OrderStatus.cancelled;
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> canBeCancelled =&gt; [
    OrderStatus.pending,
    OrderStatus.paid,
    OrderStatus.processing,
  ].contains(status);
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> canBeReturned =&gt; [
    OrderStatus.delivered,
    OrderStatus.completed,
  ].contains(status) &amp;&amp; 
      <span class="hljs-built_in">DateTime</span>.now().difference(deliveredAt ?? <span class="hljs-built_in">DateTime</span>.now()).inDays &lt;= <span class="hljs-number">7</span>;
  
  <span class="hljs-built_in">Duration</span> <span class="hljs-keyword">get</span> processingTime =&gt; updatedAt.difference(createdAt);
  
  <span class="hljs-keyword">factory</span> Order.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) {
    <span class="hljs-keyword">return</span> Order(
      id: json[<span class="hljs-string">&#x27;id&#x27;</span>],
      userId: json[<span class="hljs-string">&#x27;user_id&#x27;</span>],
      type: OrderType.fromString(json[<span class="hljs-string">&#x27;type&#x27;</span>]),
      items: (json[<span class="hljs-string">&#x27;items&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">List</span>)
          .map((item) =&gt; OrderItem.fromJson(item))
          .toList(),
      deliveryInfo: DeliveryInfo.fromJson(json[<span class="hljs-string">&#x27;delivery_info&#x27;</span>]),
      pricing: OrderPricing.fromJson(json[<span class="hljs-string">&#x27;pricing&#x27;</span>]),
      status: OrderStatus.fromString(json[<span class="hljs-string">&#x27;status&#x27;</span>]),
      couponCode: json[<span class="hljs-string">&#x27;coupon_code&#x27;</span>],
      notes: json[<span class="hljs-string">&#x27;notes&#x27;</span>],
      metadata: json[<span class="hljs-string">&#x27;metadata&#x27;</span>],
      createdAt: <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;created_at&#x27;</span>]),
      updatedAt: <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;updated_at&#x27;</span>]),
      paidAt: json[<span class="hljs-string">&#x27;paid_at&#x27;</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;paid_at&#x27;</span>]) : <span class="hljs-keyword">null</span>,
      shippedAt: json[<span class="hljs-string">&#x27;shipped_at&#x27;</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;shipped_at&#x27;</span>]) : <span class="hljs-keyword">null</span>,
      deliveredAt: json[<span class="hljs-string">&#x27;delivered_at&#x27;</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;delivered_at&#x27;</span>]) : <span class="hljs-keyword">null</span>,
      completedAt: json[<span class="hljs-string">&#x27;completed_at&#x27;</span>] != <span class="hljs-keyword">null</span> ? <span class="hljs-built_in">DateTime</span>.parse(json[<span class="hljs-string">&#x27;completed_at&#x27;</span>]) : <span class="hljs-keyword">null</span>,
      paymentId: json[<span class="hljs-string">&#x27;payment_id&#x27;</span>],
      trackingNumber: json[<span class="hljs-string">&#x27;tracking_number&#x27;</span>],
    );
  }
}

<span class="hljs-comment">// 订单项模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderItem</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> productId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> productName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> productDescription;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> productImage;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> quantity;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> unitPrice;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> totalPrice;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? productVariant;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata;
  
  <span class="hljs-keyword">const</span> OrderItem({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.productId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.productName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.productDescription,
    <span class="hljs-keyword">this</span>.productImage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.quantity,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.unitPrice,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalPrice,
    <span class="hljs-keyword">this</span>.productVariant,
    <span class="hljs-keyword">this</span>.metadata,
  });
  
  <span class="hljs-keyword">factory</span> OrderItem.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) {
    <span class="hljs-keyword">return</span> OrderItem(
      id: json[<span class="hljs-string">&#x27;id&#x27;</span>],
      productId: json[<span class="hljs-string">&#x27;product_id&#x27;</span>],
      productName: json[<span class="hljs-string">&#x27;product_name&#x27;</span>],
      productDescription: json[<span class="hljs-string">&#x27;product_description&#x27;</span>],
      productImage: json[<span class="hljs-string">&#x27;product_image&#x27;</span>],
      quantity: json[<span class="hljs-string">&#x27;quantity&#x27;</span>],
      unitPrice: (json[<span class="hljs-string">&#x27;unit_price&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">num</span>).toDouble(),
      totalPrice: (json[<span class="hljs-string">&#x27;total_price&#x27;</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">num</span>).toDouble(),
      productVariant: json[<span class="hljs-string">&#x27;product_variant&#x27;</span>],
      metadata: json[<span class="hljs-string">&#x27;metadata&#x27;</span>],
    );
  }
}

<span class="hljs-comment">// 订单状态枚举</span>
<span class="hljs-keyword">enum</span> OrderStatus {
  pending,          <span class="hljs-comment">// 待支付</span>
  paymentPending,   <span class="hljs-comment">// 支付中</span>
  paymentFailed,    <span class="hljs-comment">// 支付失败</span>
  paid,            <span class="hljs-comment">// 已支付</span>
  processing,      <span class="hljs-comment">// 处理中</span>
  shipped,         <span class="hljs-comment">// 已发货</span>
  delivered,       <span class="hljs-comment">// 已送达</span>
  completed,       <span class="hljs-comment">// 已完成</span>
  cancelled,       <span class="hljs-comment">// 已取消</span>
  returnRequested, <span class="hljs-comment">// 申请退货</span>
  returned,        <span class="hljs-comment">// 已退货</span>
  refunded,        <span class="hljs-comment">// 已退款</span>
}

<span class="hljs-keyword">extension</span> OrderStatusExtension <span class="hljs-keyword">on</span> OrderStatus {
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> displayName {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> OrderStatus.pending:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;待支付&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.paymentPending:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;支付中&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.paymentFailed:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;支付失败&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.paid:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已支付&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.processing:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;处理中&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.shipped:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已发货&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.delivered:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已送达&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.completed:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已完成&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.cancelled:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已取消&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.returnRequested:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;申请退货&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.returned:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已退货&#x27;</span>;
      <span class="hljs-keyword">case</span> OrderStatus.refunded:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;已退款&#x27;</span>;
    }
  }
  
  Color <span class="hljs-keyword">get</span> color {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> OrderStatus.pending:
      <span class="hljs-keyword">case</span> OrderStatus.paymentPending:
        <span class="hljs-keyword">return</span> Colors.orange;
      <span class="hljs-keyword">case</span> OrderStatus.paymentFailed:
      <span class="hljs-keyword">case</span> OrderStatus.cancelled:
        <span class="hljs-keyword">return</span> Colors.red;
      <span class="hljs-keyword">case</span> OrderStatus.paid:
      <span class="hljs-keyword">case</span> OrderStatus.processing:
        <span class="hljs-keyword">return</span> Colors.blue;
      <span class="hljs-keyword">case</span> OrderStatus.shipped:
        <span class="hljs-keyword">return</span> Colors.purple;
      <span class="hljs-keyword">case</span> OrderStatus.delivered:
      <span class="hljs-keyword">case</span> OrderStatus.completed:
        <span class="hljs-keyword">return</span> Colors.green;
      <span class="hljs-keyword">case</span> OrderStatus.returnRequested:
      <span class="hljs-keyword">case</span> OrderStatus.returned:
      <span class="hljs-keyword">case</span> OrderStatus.refunded:
        <span class="hljs-keyword">return</span> Colors.grey;
    }
  }
  
  <span class="hljs-keyword">static</span> OrderStatus fromString(<span class="hljs-built_in">String</span> value) {
    <span class="hljs-keyword">return</span> OrderStatus.values.firstWhere(
      (status) =&gt; status.toString().split(<span class="hljs-string">&#x27;.&#x27;</span>).last == value,
      orElse: () =&gt; OrderStatus.pending,
    );
  }
}
</code></pre>
<h2 id="页面组件设计">页面组件设计</h2>
<h3 id="订单列表页面">订单列表页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 订单列表页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderListPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _OrderListPageState createState() =&gt; _OrderListPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_OrderListPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">OrderListPage</span>&gt;
    <span class="hljs-title">with</span> <span class="hljs-title">TickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _tabController;
  <span class="hljs-keyword">late</span> OrderListBloc _orderBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _tabController = TabController(length: <span class="hljs-number">5</span>, vsync: <span class="hljs-keyword">this</span>);
    _orderBloc = context.read&lt;OrderListBloc&gt;();
    _orderBloc.add(LoadOrders());
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">&#x27;我的订单&#x27;</span>),
        bottom: TabBar(
          controller: _tabController,
          isScrollable: <span class="hljs-keyword">true</span>,
          tabs: [
            Tab(text: <span class="hljs-string">&#x27;全部&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;待支付&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;待发货&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;待收货&#x27;</span>),
            Tab(text: <span class="hljs-string">&#x27;已完成&#x27;</span>),
          ],
          onTap: (index) =&gt; _onTabChanged(index),
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildOrderList(<span class="hljs-keyword">null</span>),
          _buildOrderList(OrderStatus.pending),
          _buildOrderList(OrderStatus.paid),
          _buildOrderList(OrderStatus.shipped),
          _buildOrderList(OrderStatus.completed),
        ],
      ),
    );
  }
  
  Widget _buildOrderList(OrderStatus? status) {
    <span class="hljs-keyword">return</span> BlocBuilder&lt;OrderListBloc, OrderListState&gt;(
      builder: (context, state) {
        <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> OrderListLoaded) {
          <span class="hljs-keyword">final</span> filteredOrders = status != <span class="hljs-keyword">null</span>
              ? state.orders.where((order) =&gt; order.status == status).toList()
              : state.orders;
          
          <span class="hljs-keyword">if</span> (filteredOrders.isEmpty) {
            <span class="hljs-keyword">return</span> _buildEmptyState();
          }
          
          <span class="hljs-keyword">return</span> RefreshIndicator(
            onRefresh: () <span class="hljs-keyword">async</span> {
              _orderBloc.add(RefreshOrders());
            },
            child: ListView.builder(
              padding: EdgeInsets.all(<span class="hljs-number">16</span>),
              itemCount: filteredOrders.length,
              itemBuilder: (context, index) {
                <span class="hljs-keyword">return</span> OrderCard(
                  order: filteredOrders[index],
                  onTap: () =&gt; _navigateToOrderDetail(filteredOrders[index]),
                );
              },
            ),
          );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> OrderListError) {
          <span class="hljs-keyword">return</span> _buildErrorState(state.message);
        }
        <span class="hljs-keyword">return</span> _buildLoadingState();
      },
    );
  }
}

<span class="hljs-comment">// 订单卡片组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Order order;
  <span class="hljs-keyword">final</span> VoidCallback? onTap;
  
  <span class="hljs-keyword">const</span> OrderCard({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.order,
    <span class="hljs-keyword">this</span>.onTap,
  }) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      margin: EdgeInsets.only(bottom: <span class="hljs-number">16</span>),
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: EdgeInsets.all(<span class="hljs-number">16</span>),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildHeader(),
              SizedBox(height: <span class="hljs-number">12</span>),
              _buildItems(),
              SizedBox(height: <span class="hljs-number">12</span>),
              _buildFooter(),
            ],
          ),
        ),
      ),
    );
  }
  
  Widget _buildHeader() {
    <span class="hljs-keyword">return</span> Row(
      children: [
        Text(
          <span class="hljs-string">&#x27;订单号: <span class="hljs-subst">${order.id}</span>&#x27;</span>,
          style: TextStyle(
            fontSize: <span class="hljs-number">14</span>,
            color: Colors.grey[<span class="hljs-number">600</span>],
          ),
        ),
        Spacer(),
        Container(
          padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">8</span>, vertical: <span class="hljs-number">4</span>),
          decoration: BoxDecoration(
            color: order.status.color.withOpacity(<span class="hljs-number">0.1</span>),
            border: Border.all(color: order.status.color),
            borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
          ),
          child: Text(
            order.status.displayName,
            style: TextStyle(
              fontSize: <span class="hljs-number">12</span>,
              color: order.status.color,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),
      ],
    );
  }
  
  Widget _buildItems() {
    <span class="hljs-keyword">return</span> Column(
      children: order.items.take(<span class="hljs-number">3</span>).map((item) {
        <span class="hljs-keyword">return</span> Padding(
          padding: EdgeInsets.only(bottom: <span class="hljs-number">8</span>),
          child: Row(
            children: [
              ClipRRect(
                borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
                child: Image.network(
                  item.productImage ?? <span class="hljs-string">&#x27;&#x27;</span>,
                  width: <span class="hljs-number">50</span>,
                  height: <span class="hljs-number">50</span>,
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    <span class="hljs-keyword">return</span> Container(
                      width: <span class="hljs-number">50</span>,
                      height: <span class="hljs-number">50</span>,
                      color: Colors.grey[<span class="hljs-number">300</span>],
                      child: Icon(Icons.image, color: Colors.grey),
                    );
                  },
                ),
              ),
              SizedBox(width: <span class="hljs-number">12</span>),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      item.productName,
                      style: TextStyle(fontSize: <span class="hljs-number">14</span>),
                      maxLines: <span class="hljs-number">1</span>,
                      overflow: TextOverflow.ellipsis,
                    ),
                    Text(
                      <span class="hljs-string">&#x27;数量: <span class="hljs-subst">${item.quantity}</span>&#x27;</span>,
                      style: TextStyle(
                        fontSize: <span class="hljs-number">12</span>,
                        color: Colors.grey[<span class="hljs-number">600</span>],
                      ),
                    ),
                  ],
                ),
              ),
              Text(
                <span class="hljs-string">&#x27;¥<span class="hljs-subst">${item.totalPrice.toStringAsFixed(<span class="hljs-number">2</span>)}</span>&#x27;</span>,
                style: TextStyle(
                  fontSize: <span class="hljs-number">14</span>,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
        );
      }).toList(),
    );
  }
  
  Widget _buildFooter() {
    <span class="hljs-keyword">return</span> Row(
      children: [
        Text(
          <span class="hljs-string">&#x27;共<span class="hljs-subst">${order.items.length}</span>件商品&#x27;</span>,
          style: TextStyle(
            fontSize: <span class="hljs-number">12</span>,
            color: Colors.grey[<span class="hljs-number">600</span>],
          ),
        ),
        Spacer(),
        Text(
          <span class="hljs-string">&#x27;合计: ¥<span class="hljs-subst">${order.pricing.total.toStringAsFixed(<span class="hljs-number">2</span>)}</span>&#x27;</span>,
          style: TextStyle(
            fontSize: <span class="hljs-number">16</span>,
            fontWeight: FontWeight.bold,
            color: Colors.red,
          ),
        ),
      ],
    );
  }
}
</code></pre>
<h2 id="状态管理">状态管理</h2>
<h3 id="订单状态管理">订单状态管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 订单列表状态 BLoC</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderListBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">OrderListEvent</span>, <span class="hljs-title">OrderListState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> OrderRepository _repository;
  
  OrderListBloc(<span class="hljs-keyword">this</span>._repository) : <span class="hljs-keyword">super</span>(OrderListInitial()) {
    <span class="hljs-keyword">on</span>&lt;LoadOrders&gt;(_onLoadOrders);
    <span class="hljs-keyword">on</span>&lt;RefreshOrders&gt;(_onRefreshOrders);
    <span class="hljs-keyword">on</span>&lt;FilterOrders&gt;(_onFilterOrders);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onLoadOrders(
    LoadOrders event,
    Emitter&lt;OrderListState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(OrderListLoading());
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> orders = <span class="hljs-keyword">await</span> _repository.getUserOrders(
        userId: event.userId,
        status: event.status,
        page: <span class="hljs-number">1</span>,
        pageSize: <span class="hljs-number">20</span>,
      );
      
      emit(OrderListLoaded(orders));
    } <span class="hljs-keyword">catch</span> (e) {
      emit(OrderListError(<span class="hljs-string">&#x27;加载订单失败: <span class="hljs-subst">$e</span>&#x27;</span>));
    }
  }
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心依赖">核心依赖</h3>
<ul>
<li><strong>basic_modular</strong>: 模块化框架</li>
<li><strong>basic_modular_route</strong>: 路由管理</li>
<li><strong>basic_network</strong>: 网络请求</li>
<li><strong>basic_logger</strong>: 日志记录</li>
<li><strong>basic_intl</strong>: 国际化支持</li>
</ul>
<h3 id="ui-依赖">UI 依赖</h3>
<ul>
<li><strong>ui_basic</strong>: 基础 UI 组件</li>
<li><strong>ui_payment</strong>: 支付界面组件</li>
</ul>
<h3 id="服务依赖">服务依赖</h3>
<ul>
<li><strong>clr_payment</strong>: 支付服务 SDK</li>
<li><strong>clr_account</strong>: 账户服务 SDK</li>
<li><strong>clr_order</strong>: 订单服务 SDK (本地路径)</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="订单异常定义">订单异常定义</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 订单功能异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderFailure</span> </span>{
  <span class="hljs-keyword">const</span> OrderFailure();
  
  <span class="hljs-keyword">factory</span> OrderFailure.creationFailed(<span class="hljs-built_in">String</span> message) = OrderCreationFailure;
  <span class="hljs-keyword">factory</span> OrderFailure.paymentFailed(<span class="hljs-built_in">String</span> message) = OrderPaymentFailure;
  <span class="hljs-keyword">factory</span> OrderFailure.orderNotFound() = OrderNotFoundFailure;
  <span class="hljs-keyword">factory</span> OrderFailure.permissionDenied() = OrderPermissionDeniedFailure;
  <span class="hljs-keyword">factory</span> OrderFailure.cannotBeCancelled() = OrderCannotBeCancelledFailure;
  <span class="hljs-keyword">factory</span> OrderFailure.invalidStatusTransition() = InvalidStatusTransitionFailure;
}
</code></pre>
<h2 id="总结">总结</h2>
<p><code>app_order</code> 模块为 OneApp 提供了完整的订单管理解决方案，涵盖了订单创建、支付处理、状态跟踪、历史查询等全生命周期功能。模块与支付系统、账户系统深度集成，通过清晰的状态管理和完善的错误处理机制，为用户提供了可靠的订单管理体验。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>