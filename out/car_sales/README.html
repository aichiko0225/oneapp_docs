<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>OneApp Car Sales - &#x6c7d;&#x8f66;&#x9500;&#x552e;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="oneapp-car-sales---汽车销售模块文档">OneApp Car Sales - 汽车销售模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>oneapp_car_sales</code> 是 OneApp 的汽车销售核心模块，提供车型展示、在线选车、试驾预约、销售线索管理、经销商服务等功能。该模块集成了地图服务、触点管理、售后服务等，为用户提供完整的购车体验。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: oneapp_car_sales</li>
<li><strong>版本</strong>: 0.0.1</li>
<li><strong>类型</strong>: Flutter Package</li>
<li><strong>Dart 版本</strong>: &gt;=3.0.0 &lt;4.0.0</li>
<li><strong>Flutter 版本</strong>: &gt;=3.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>oneapp_car_sales/
├── lib/
│   ├── oneapp_car_sales.dart     # 主导出文件
│   └── src/                      # 源代码目录
│       ├── pages/                # 销售页面
│       ├── widgets/              # 销售组件
│       ├── models/               # 数据模型
│       ├── services/             # 服务层
│       ├── blocs/                # 状态管理
│       ├── utils/                # 工具类
│       └── constants/            # 常量定义
├── assets/                       # 静态资源
├── ios/                          # iOS 配置
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-车型展示与选择">1. 车型展示与选择</h3>
<h4 id="车型目录服务">车型目录服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 车型目录服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VehicleCatalogService</span> </span>{
  <span class="hljs-keyword">final</span> CatalogRepository _repository;
  <span class="hljs-keyword">final</span> ConfigurationService _configService;
  
  VehicleCatalogService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._configService);
  
  <span class="hljs-comment">// 获取车型列表</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;VehicleModel&gt;&gt;&gt; getVehicleModels({
    VehicleBrand? brand,
    VehicleCategory? category,
    PriceRange? priceRange,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? features,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> filters = VehicleFilters(
        brand: brand,
        category: category,
        priceRange: priceRange,
        features: features,
      );
      
      <span class="hljs-keyword">final</span> models = <span class="hljs-keyword">await</span> _repository.getVehicleModels(
        filters: filters,
        page: page,
        pageSize: pageSize,
      );
      
      <span class="hljs-keyword">return</span> Right(models);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.catalogLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取车型详情</span>
  Future&lt;Result&lt;VehicleDetail&gt;&gt; getVehicleDetail(<span class="hljs-built_in">String</span> modelId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> detail = <span class="hljs-keyword">await</span> _repository.getVehicleDetail(modelId);
      <span class="hljs-keyword">return</span> Right(detail);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.detailLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取车型配置选项</span>
  Future&lt;Result&lt;VehicleConfiguration&gt;&gt; getVehicleConfiguration(
    <span class="hljs-built_in">String</span> modelId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> configuration = <span class="hljs-keyword">await</span> _configService.getModelConfiguration(modelId);
      <span class="hljs-keyword">return</span> Right(configuration);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.configurationLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 计算车型价格</span>
  Future&lt;Result&lt;VehiclePricing&gt;&gt; calculateVehiclePrice({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> modelId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; selectedOptions,
    <span class="hljs-built_in">String?</span> dealerCode,
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;? promotions,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> pricing = <span class="hljs-keyword">await</span> _repository.calculatePrice(
        modelId: modelId,
        options: selectedOptions,
        dealerCode: dealerCode,
        promotions: promotions,
      );
      
      <span class="hljs-keyword">return</span> Right(pricing);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.pricingCalculationFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 车型数据模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VehicleModel</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> VehicleBrand brand;
  <span class="hljs-keyword">final</span> VehicleCategory category;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; images;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> mainImage;
  <span class="hljs-keyword">final</span> PriceRange priceRange;
  <span class="hljs-keyword">final</span> VehicleSpecs specifications;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; features;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; colors;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rating;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> reviewCount;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isAvailable;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> launchDate;
  
  <span class="hljs-keyword">const</span> VehicleModel({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.brand,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.category,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.images,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.mainImage,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.priceRange,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.specifications,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.features,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.colors,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.rating,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.reviewCount,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isAvailable,
    <span class="hljs-keyword">this</span>.launchDate,
  });
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> displayPrice =&gt; <span class="hljs-string">&#x27;<span class="hljs-subst">${priceRange.min.toStringAsFixed(<span class="hljs-number">1</span>)}</span>万起&#x27;</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isNewModel =&gt; launchDate != <span class="hljs-keyword">null</span> &amp;&amp; 
      <span class="hljs-built_in">DateTime</span>.now().difference(launchDate!).inDays &lt; <span class="hljs-number">90</span>;
}
</code></pre>
<h3 id="2-试驾预约管理">2. 试驾预约管理</h3>
<h4 id="试驾预约服务">试驾预约服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 试驾预约服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDriveService</span> </span>{
  <span class="hljs-keyword">final</span> TestDriveRepository _repository;
  <span class="hljs-keyword">final</span> DealerService _dealerService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  TestDriveService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._dealerService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 创建试驾预约</span>
  Future&lt;Result&lt;TestDriveAppointment&gt;&gt; createTestDriveAppointment({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleModelId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> dealerId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> preferredDateTime,
    <span class="hljs-built_in">String?</span> alternativeDateTime,
    <span class="hljs-keyword">required</span> CustomerInfo customerInfo,
    <span class="hljs-built_in">String?</span> specialRequests,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查时间段可用性</span>
      <span class="hljs-keyword">final</span> isAvailable = <span class="hljs-keyword">await</span> _checkTimeSlotAvailability(
        dealerId: dealerId,
        dateTime: preferredDateTime,
        vehicleModelId: vehicleModelId,
      );
      
      <span class="hljs-keyword">if</span> (!isAvailable) {
        <span class="hljs-keyword">return</span> Left(SalesFailure.timeSlotNotAvailable());
      }
      
      <span class="hljs-comment">// 创建预约</span>
      <span class="hljs-keyword">final</span> appointment = TestDriveAppointment(
        id: generateId(),
        userId: userId,
        vehicleModelId: vehicleModelId,
        dealerId: dealerId,
        customerInfo: customerInfo,
        preferredDateTime: preferredDateTime,
        alternativeDateTime: alternativeDateTime != <span class="hljs-keyword">null</span> 
            ? <span class="hljs-built_in">DateTime</span>.tryParse(alternativeDateTime) 
            : <span class="hljs-keyword">null</span>,
        specialRequests: specialRequests,
        status: TestDriveStatus.pending,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.createTestDriveAppointment(appointment);
      
      <span class="hljs-comment">// 发送确认通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendTestDriveConfirmation(
        userId: userId,
        appointment: appointment,
      );
      
      <span class="hljs-comment">// 通知经销商</span>
      <span class="hljs-keyword">await</span> _notifyDealer(appointment);
      
      <span class="hljs-keyword">return</span> Right(appointment);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.appointmentCreationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取可用时间段</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;TimeSlot&gt;&gt;&gt; getAvailableTimeSlots({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> dealerId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleModelId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">DateTime</span> date,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> dealer = <span class="hljs-keyword">await</span> _dealerService.getDealerById(dealerId);
      <span class="hljs-keyword">if</span> (dealer == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(SalesFailure.dealerNotFound());
      }
      
      <span class="hljs-keyword">final</span> businessHours = dealer.businessHours[date.weekday - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">final</span> bookedSlots = <span class="hljs-keyword">await</span> _repository.getBookedTimeSlots(
        dealerId: dealerId,
        date: date,
      );
      
      <span class="hljs-keyword">final</span> availableSlots = _generateAvailableSlots(
        businessHours: businessHours,
        bookedSlots: bookedSlots,
        vehicleModelId: vehicleModelId,
      );
      
      <span class="hljs-keyword">return</span> Right(availableSlots);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.timeSlotsLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取用户试驾历史</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;TestDriveAppointment&gt;&gt;&gt; getUserTestDriveHistory(
    <span class="hljs-built_in">String</span> userId,
  ) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> appointments = <span class="hljs-keyword">await</span> _repository.getUserTestDriveAppointments(userId);
      <span class="hljs-keyword">return</span> Right(appointments);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.historyLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 试驾预约模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDriveAppointment</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleModelId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> dealerId;
  <span class="hljs-keyword">final</span> CustomerInfo customerInfo;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> preferredDateTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> alternativeDateTime;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> specialRequests;
  <span class="hljs-keyword">final</span> TestDriveStatus status;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> confirmedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> completedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> salesRepId;
  <span class="hljs-keyword">final</span> TestDriveFeedback? feedback;
  
  <span class="hljs-keyword">const</span> TestDriveAppointment({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleModelId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.dealerId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.customerInfo,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.preferredDateTime,
    <span class="hljs-keyword">this</span>.alternativeDateTime,
    <span class="hljs-keyword">this</span>.specialRequests,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">this</span>.confirmedAt,
    <span class="hljs-keyword">this</span>.completedAt,
    <span class="hljs-keyword">this</span>.salesRepId,
    <span class="hljs-keyword">this</span>.feedback,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isUpcoming =&gt; status == TestDriveStatus.confirmed &amp;&amp; 
      preferredDateTime.isAfter(<span class="hljs-built_in">DateTime</span>.now());
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isPast =&gt; completedAt != <span class="hljs-keyword">null</span> || 
      (status == TestDriveStatus.confirmed &amp;&amp; 
       preferredDateTime.isBefore(<span class="hljs-built_in">DateTime</span>.now().subtract(<span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">2</span>))));
}
</code></pre>
<h3 id="3-经销商管理">3. 经销商管理</h3>
<h4 id="经销商服务">经销商服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 经销商服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DealerService</span> </span>{
  <span class="hljs-keyword">final</span> DealerRepository _repository;
  <span class="hljs-keyword">final</span> LocationService _locationService;
  
  DealerService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._locationService);
  
  <span class="hljs-comment">// 查找附近经销商</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;Dealer&gt;&gt;&gt; findNearbyDealers({
    <span class="hljs-keyword">required</span> LatLng userLocation,
    <span class="hljs-built_in">double</span> radiusKm = <span class="hljs-number">50</span>,
    VehicleBrand? brand,
    <span class="hljs-built_in">List</span>&lt;DealerService&gt;? services,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> dealers = <span class="hljs-keyword">await</span> _repository.findDealersNearLocation(
        location: userLocation,
        radius: radiusKm,
        brand: brand,
        services: services,
      );
      
      <span class="hljs-comment">// 计算距离并排序</span>
      <span class="hljs-keyword">final</span> dealersWithDistance = dealers.map((dealer) {
        <span class="hljs-keyword">final</span> distance = _locationService.calculateDistance(
          userLocation,
          dealer.location,
        );
        <span class="hljs-keyword">return</span> DealerWithDistance(dealer: dealer, distance: distance);
      }).toList();
      
      dealersWithDistance.sort((a, b) =&gt; a.distance.compareTo(b.distance));
      
      <span class="hljs-keyword">return</span> Right(dealersWithDistance.map((d) =&gt; d.dealer).toList());
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.dealerSearchFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取经销商详情</span>
  Future&lt;Result&lt;DealerDetail&gt;&gt; getDealerDetail(<span class="hljs-built_in">String</span> dealerId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> dealer = <span class="hljs-keyword">await</span> _repository.getDealerById(dealerId);
      <span class="hljs-keyword">if</span> (dealer == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(SalesFailure.dealerNotFound());
      }
      
      <span class="hljs-keyword">final</span> detail = DealerDetail(
        dealer: dealer,
        salesReps: <span class="hljs-keyword">await</span> _repository.getDealerSalesReps(dealerId),
        reviews: <span class="hljs-keyword">await</span> _repository.getDealerReviews(dealerId),
        inventory: <span class="hljs-keyword">await</span> _repository.getDealerInventory(dealerId),
      );
      
      <span class="hljs-keyword">return</span> Right(detail);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.dealerDetailLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取经销商库存</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;VehicleInventory&gt;&gt;&gt; getDealerInventory({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> dealerId,
    <span class="hljs-built_in">String?</span> modelId,
    <span class="hljs-built_in">bool</span> availableOnly = <span class="hljs-keyword">true</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> inventory = <span class="hljs-keyword">await</span> _repository.getDealerInventory(
        dealerId,
        modelId: modelId,
        availableOnly: availableOnly,
      );
      <span class="hljs-keyword">return</span> Right(inventory);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.inventoryLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 经销商数据模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dealer</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> code;
  <span class="hljs-keyword">final</span> VehicleBrand primaryBrand;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;VehicleBrand&gt; supportedBrands;
  <span class="hljs-keyword">final</span> DealerType type;
  <span class="hljs-keyword">final</span> Address address;
  <span class="hljs-keyword">final</span> LatLng location;
  <span class="hljs-keyword">final</span> ContactInfo contactInfo;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BusinessHours&gt; businessHours;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;DealerService&gt; services;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> rating;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> reviewCount;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; certifications;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; images;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isAuthorized;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isActive;
  
  <span class="hljs-keyword">const</span> Dealer({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.code,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.primaryBrand,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.supportedBrands,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.address,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.location,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.contactInfo,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.businessHours,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.services,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.rating,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.reviewCount,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.certifications,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.images,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isAuthorized,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isActive,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isOpen {
    <span class="hljs-keyword">final</span> now = <span class="hljs-built_in">DateTime</span>.now();
    <span class="hljs-keyword">final</span> todayHours = businessHours[now.weekday - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">return</span> todayHours.isOpen(now);
  }
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> supportsTestDrive =&gt; services.contains(DealerService.testDrive);
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> supportsService =&gt; services.contains(DealerService.afterSales);
}
</code></pre>
<h3 id="4-销售线索管理">4. 销售线索管理</h3>
<h4 id="线索管理服务">线索管理服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 销售线索管理服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SalesLeadService</span> </span>{
  <span class="hljs-keyword">final</span> LeadRepository _repository;
  <span class="hljs-keyword">final</span> CrmIntegrationService _crmService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  SalesLeadService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._crmService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 创建销售线索</span>
  Future&lt;Result&lt;SalesLead&gt;&gt; createSalesLead({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> LeadSource source,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> vehicleModelId,
    <span class="hljs-built_in">String?</span> dealerId,
    <span class="hljs-keyword">required</span> CustomerInfo customerInfo,
    LeadType type = LeadType.inquiry,
    <span class="hljs-built_in">String?</span> notes,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> lead = SalesLead(
        id: generateId(),
        userId: userId,
        source: source,
        type: type,
        vehicleModelId: vehicleModelId,
        dealerId: dealerId,
        customerInfo: customerInfo,
        status: LeadStatus.new_,
        priority: _calculateLeadPriority(source, type, customerInfo),
        notes: notes,
        metadata: metadata,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.createSalesLead(lead);
      
      <span class="hljs-comment">// 同步到 CRM 系统</span>
      <span class="hljs-keyword">await</span> _crmService.syncLead(lead);
      
      <span class="hljs-comment">// 分配给销售代表</span>
      <span class="hljs-keyword">await</span> _assignToSalesRep(lead);
      
      <span class="hljs-keyword">return</span> Right(lead);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.leadCreationFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 更新线索状态</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; updateLeadStatus({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> leadId,
    <span class="hljs-keyword">required</span> LeadStatus status,
    <span class="hljs-built_in">String?</span> salesRepId,
    <span class="hljs-built_in">String?</span> notes,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _repository.updateLeadStatus(
        leadId: leadId,
        status: status,
        salesRepId: salesRepId,
        notes: notes,
        updatedAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-comment">// 发送状态更新通知</span>
      <span class="hljs-keyword">await</span> _notificationService.sendLeadStatusUpdate(
        leadId: leadId,
        status: status,
      );
      
      <span class="hljs-keyword">return</span> Right(unit);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.leadUpdateFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取用户销售线索</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;SalesLead&gt;&gt;&gt; getUserSalesLeads(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> leads = <span class="hljs-keyword">await</span> _repository.getUserSalesLeads(userId);
      <span class="hljs-keyword">return</span> Right(leads);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(SalesFailure.leadsLoadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 计算线索优先级</span>
  LeadPriority _calculateLeadPriority(
    LeadSource source,
    LeadType type,
    CustomerInfo customerInfo,
  ) {
    <span class="hljs-built_in">int</span> score = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 根据来源计分</span>
    <span class="hljs-keyword">switch</span> (source) {
      <span class="hljs-keyword">case</span> LeadSource.testDrive:
        score += <span class="hljs-number">40</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadSource.configurationTool:
        score += <span class="hljs-number">30</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadSource.dealerInquiry:
        score += <span class="hljs-number">35</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadSource.websiteBrowsing:
        score += <span class="hljs-number">20</span>;
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 根据类型计分</span>
    <span class="hljs-keyword">switch</span> (type) {
      <span class="hljs-keyword">case</span> LeadType.purchaseIntent:
        score += <span class="hljs-number">30</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadType.testDriveRequest:
        score += <span class="hljs-number">25</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadType.priceInquiry:
        score += <span class="hljs-number">20</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LeadType.generalInquiry:
        score += <span class="hljs-number">10</span>;
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 根据客户信息计分</span>
    <span class="hljs-keyword">if</span> (customerInfo.hasValidPhone) score += <span class="hljs-number">10</span>;
    <span class="hljs-keyword">if</span> (customerInfo.hasValidEmail) score += <span class="hljs-number">10</span>;
    <span class="hljs-keyword">if</span> (customerInfo.preferredContactTime != <span class="hljs-keyword">null</span>) score += <span class="hljs-number">5</span>;
    
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">70</span>) <span class="hljs-keyword">return</span> LeadPriority.high;
    <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">50</span>) <span class="hljs-keyword">return</span> LeadPriority.medium;
    <span class="hljs-keyword">return</span> LeadPriority.low;
  }
}

<span class="hljs-comment">// 销售线索模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SalesLead</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> LeadSource source;
  <span class="hljs-keyword">final</span> LeadType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> vehicleModelId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> dealerId;
  <span class="hljs-keyword">final</span> CustomerInfo customerInfo;
  <span class="hljs-keyword">final</span> LeadStatus status;
  <span class="hljs-keyword">final</span> LeadPriority priority;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> notes;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> updatedAt;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> salesRepId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;LeadActivity&gt; activities;
  
  <span class="hljs-keyword">const</span> SalesLead({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.source,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicleModelId,
    <span class="hljs-keyword">this</span>.dealerId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.customerInfo,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.priority,
    <span class="hljs-keyword">this</span>.notes,
    <span class="hljs-keyword">this</span>.metadata,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">this</span>.updatedAt,
    <span class="hljs-keyword">this</span>.salesRepId,
    <span class="hljs-keyword">this</span>.activities = <span class="hljs-keyword">const</span> [],
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isActive =&gt; ![LeadStatus.closed, LeadStatus.lost].contains(status);
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasAssignedRep =&gt; salesRepId != <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">Duration</span> <span class="hljs-keyword">get</span> age =&gt; <span class="hljs-built_in">DateTime</span>.now().difference(createdAt);
}
</code></pre>
<h2 id="页面组件设计">页面组件设计</h2>
<h3 id="车型展示页面">车型展示页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 车型展示页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VehicleCatalogPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _VehicleCatalogPageState createState() =&gt; _VehicleCatalogPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_VehicleCatalogPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">VehicleCatalogPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> VehicleCatalogBloc _catalogBloc;
  <span class="hljs-keyword">final</span> SwiperController _swiperController = SwiperController();
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _catalogBloc = context.read&lt;VehicleCatalogBloc&gt;();
    _catalogBloc.add(LoadVehicleModels());
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: CustomScrollView(
        slivers: [
          _buildAppBar(),
          _buildFilterSection(),
          _buildVehicleGrid(),
        ],
      ),
    );
  }
  
  Widget _buildVehicleGrid() {
    <span class="hljs-keyword">return</span> BlocBuilder&lt;VehicleCatalogBloc, VehicleCatalogState&gt;(
      builder: (context, state) {
        <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> VehicleCatalogLoaded) {
          <span class="hljs-keyword">return</span> SliverGrid(
            gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
              crossAxisCount: <span class="hljs-number">2</span>,
              childAspectRatio: <span class="hljs-number">0.75</span>,
              crossAxisSpacing: <span class="hljs-number">16</span>,
              mainAxisSpacing: <span class="hljs-number">16</span>,
            ),
            delegate: SliverChildBuilderDelegate(
              (context, index) {
                <span class="hljs-keyword">return</span> VehicleCard(
                  vehicle: state.vehicles[index],
                  onTap: () =&gt; _navigateToVehicleDetail(state.vehicles[index]),
                );
              },
              childCount: state.vehicles.length,
            ),
          );
        }
        <span class="hljs-keyword">return</span> SliverToBoxAdapter(child: VehicleGridSkeleton());
      },
    );
  }
}

<span class="hljs-comment">// 车型卡片组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VehicleCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> VehicleModel vehicle;
  <span class="hljs-keyword">final</span> VoidCallback? onTap;
  
  <span class="hljs-keyword">const</span> VehicleCard({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicle,
    <span class="hljs-keyword">this</span>.onTap,
  }) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      elevation: <span class="hljs-number">4</span>,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
      ),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildImageSection(),
            _buildInfoSection(),
            _buildActionSection(),
          ],
        ),
      ),
    );
  }
  
  Widget _buildImageSection() {
    <span class="hljs-keyword">return</span> Expanded(
      flex: <span class="hljs-number">3</span>,
      child: Container(
        width: <span class="hljs-built_in">double</span>.infinity,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.vertical(top: Radius.circular(<span class="hljs-number">12</span>)),
          image: DecorationImage(
            image: NetworkImage(vehicle.mainImage),
            fit: BoxFit.cover,
          ),
        ),
        child: Stack(
          children: [
            <span class="hljs-keyword">if</span> (vehicle.isNewModel)
              Positioned(
                top: <span class="hljs-number">8</span>,
                left: <span class="hljs-number">8</span>,
                child: Container(
                  padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">8</span>, vertical: <span class="hljs-number">4</span>),
                  decoration: BoxDecoration(
                    color: Colors.red,
                    borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                  ),
                  child: Text(
                    <span class="hljs-string">&#x27;新车&#x27;</span>,
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: <span class="hljs-number">12</span>,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
            Positioned(
              bottom: <span class="hljs-number">8</span>,
              right: <span class="hljs-number">8</span>,
              child: Container(
                padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">8</span>, vertical: <span class="hljs-number">4</span>),
                decoration: BoxDecoration(
                  color: Colors.black54,
                  borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.star, color: Colors.yellow, size: <span class="hljs-number">14</span>),
                    SizedBox(width: <span class="hljs-number">4</span>),
                    Text(
                      vehicle.rating.toStringAsFixed(<span class="hljs-number">1</span>),
                      style: TextStyle(color: Colors.white, fontSize: <span class="hljs-number">12</span>),
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildInfoSection() {
    <span class="hljs-keyword">return</span> Expanded(
      flex: <span class="hljs-number">2</span>,
      child: Padding(
        padding: EdgeInsets.all(<span class="hljs-number">12</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              vehicle.name,
              style: TextStyle(
                fontSize: <span class="hljs-number">16</span>,
                fontWeight: FontWeight.bold,
              ),
              maxLines: <span class="hljs-number">1</span>,
              overflow: TextOverflow.ellipsis,
            ),
            SizedBox(height: <span class="hljs-number">4</span>),
            Text(
              vehicle.brand.name,
              style: TextStyle(
                fontSize: <span class="hljs-number">14</span>,
                color: Colors.grey[<span class="hljs-number">600</span>],
              ),
            ),
            Spacer(),
            Text(
              vehicle.displayPrice,
              style: TextStyle(
                fontSize: <span class="hljs-number">18</span>,
                fontWeight: FontWeight.bold,
                color: Colors.blue,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h3 id="试驾预约页面">试驾预约页面</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 试驾预约页面</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestDriveBookingPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> VehicleModel vehicle;
  
  <span class="hljs-keyword">const</span> TestDriveBookingPage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.vehicle});
  
  <span class="hljs-meta">@override</span>
  _TestDriveBookingPageState createState() =&gt; _TestDriveBookingPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TestDriveBookingPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TestDriveBookingPage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> TestDriveBloc _testDriveBloc;
  <span class="hljs-keyword">final</span> _formKey = GlobalKey&lt;FormState&gt;();
  <span class="hljs-keyword">final</span> _customerInfoController = CustomerInfoController();
  
  Dealer? _selectedDealer;
  <span class="hljs-built_in">DateTime?</span> _selectedDate;
  TimeSlot? _selectedTimeSlot;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _testDriveBloc = context.read&lt;TestDriveBloc&gt;();
    _loadNearbyDealers();
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">&#x27;预约试驾 - <span class="hljs-subst">${widget.vehicle.name}</span>&#x27;</span>),
      ),
      body: Form(
        key: _formKey,
        child: ListView(
          padding: EdgeInsets.all(<span class="hljs-number">16</span>),
          children: [
            _buildVehicleSection(),
            SizedBox(height: <span class="hljs-number">24</span>),
            _buildDealerSelection(),
            SizedBox(height: <span class="hljs-number">24</span>),
            _buildDateTimeSelection(),
            SizedBox(height: <span class="hljs-number">24</span>),
            _buildCustomerInfoForm(),
            SizedBox(height: <span class="hljs-number">24</span>),
            _buildSpecialRequestsField(),
            SizedBox(height: <span class="hljs-number">32</span>),
            _buildSubmitButton(),
          ],
        ),
      ),
    );
  }
  
  Widget _buildDealerSelection() {
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">&#x27;选择经销商&#x27;</span>,
          style: TextStyle(fontSize: <span class="hljs-number">18</span>, fontWeight: FontWeight.bold),
        ),
        SizedBox(height: <span class="hljs-number">12</span>),
        BlocBuilder&lt;TestDriveBloc, TestDriveState&gt;(
          builder: (context, state) {
            <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> DealersLoaded) {
              <span class="hljs-keyword">return</span> Column(
                children: state.dealers.map((dealer) {
                  <span class="hljs-keyword">return</span> DealerSelectionCard(
                    dealer: dealer,
                    isSelected: _selectedDealer?.id == dealer.id,
                    onSelected: () =&gt; _selectDealer(dealer),
                  );
                }).toList(),
              );
            }
            <span class="hljs-keyword">return</span> DealerSelectionSkeleton();
          },
        ),
      ],
    );
  }
  
  Widget _buildDateTimeSelection() {
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">&#x27;选择时间&#x27;</span>,
          style: TextStyle(fontSize: <span class="hljs-number">18</span>, fontWeight: FontWeight.bold),
        ),
        SizedBox(height: <span class="hljs-number">12</span>),
        DatePickerWidget(
          onDateSelected: (date) =&gt; _selectDate(date),
          minDate: <span class="hljs-built_in">DateTime</span>.now(),
          maxDate: <span class="hljs-built_in">DateTime</span>.now().add(<span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">30</span>)),
        ),
        <span class="hljs-keyword">if</span> (_selectedDate != <span class="hljs-keyword">null</span>) ...[
          SizedBox(height: <span class="hljs-number">16</span>),
          TimeSlotGrid(
            availableSlots: _getAvailableTimeSlots(),
            selectedSlot: _selectedTimeSlot,
            onSlotSelected: (slot) =&gt; _selectTimeSlot(slot),
          ),
        ],
      ],
    );
  }
}
</code></pre>
<h2 id="状态管理">状态管理</h2>
<h3 id="车型目录状态管理">车型目录状态管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 车型目录状态 BLoC</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VehicleCatalogBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">VehicleCatalogEvent</span>, <span class="hljs-title">VehicleCatalogState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> VehicleCatalogService _catalogService;
  
  VehicleCatalogBloc(<span class="hljs-keyword">this</span>._catalogService) : <span class="hljs-keyword">super</span>(VehicleCatalogInitial()) {
    <span class="hljs-keyword">on</span>&lt;LoadVehicleModels&gt;(_onLoadVehicleModels);
    <span class="hljs-keyword">on</span>&lt;FilterVehicles&gt;(_onFilterVehicles);
    <span class="hljs-keyword">on</span>&lt;SearchVehicles&gt;(_onSearchVehicles);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onLoadVehicleModels(
    LoadVehicleModels event,
    Emitter&lt;VehicleCatalogState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(VehicleCatalogLoading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _catalogService.getVehicleModels(
      brand: event.brand,
      category: event.category,
      priceRange: event.priceRange,
    );
    
    result.fold(
      (failure) =&gt; emit(VehicleCatalogError(failure.message)),
      (vehicles) =&gt; emit(VehicleCatalogLoaded(vehicles)),
    );
  }
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心模块依赖">核心模块依赖</h3>
<ul>
<li><strong>basic_utils</strong>: 基础工具类</li>
<li><strong>basic_uis</strong>: 基础 UI 组件</li>
<li><strong>app_configuration</strong>: 应用配置</li>
<li><strong>oneapp_after_sales</strong>: 售后服务集成</li>
<li><strong>oneapp_touch_point</strong>: 触点管理集成</li>
</ul>
<h3 id="ui-相关依赖">UI 相关依赖</h3>
<ul>
<li><strong>card_swiper</strong>: 卡片轮播组件，用于车型图片展示</li>
<li><strong>flutter_pickers</strong>: 选择器组件，用于日期时间选择</li>
<li><strong>ui_mapview</strong>: 地图视图组件，用于经销商位置展示</li>
</ul>
<h3 id="定位相关依赖">定位相关依赖</h3>
<ul>
<li><strong>amap_flutter_location</strong>: 高德地图定位服务</li>
<li><strong>permission_handler</strong>: 权限管理</li>
</ul>
<h3 id="框架依赖">框架依赖</h3>
<ul>
<li><strong>basic_modular</strong>: 模块化框架</li>
<li><strong>flutter_localizations</strong>: 国际化支持</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="销售模块异常">销售模块异常</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 销售功能异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SalesFailure</span> </span>{
  <span class="hljs-keyword">const</span> SalesFailure();
  
  <span class="hljs-keyword">factory</span> SalesFailure.catalogLoadFailed(<span class="hljs-built_in">String</span> message) = CatalogLoadFailure;
  <span class="hljs-keyword">factory</span> SalesFailure.dealerNotFound() = DealerNotFoundFailure;
  <span class="hljs-keyword">factory</span> SalesFailure.timeSlotNotAvailable() = TimeSlotNotAvailableFailure;
  <span class="hljs-keyword">factory</span> SalesFailure.appointmentCreationFailed(<span class="hljs-built_in">String</span> message) = AppointmentCreationFailure;
  <span class="hljs-keyword">factory</span> SalesFailure.leadCreationFailed(<span class="hljs-built_in">String</span> message) = LeadCreationFailure;
}
</code></pre>
<h2 id="总结">总结</h2>
<p><code>oneapp_car_sales</code> 模块为 OneApp 提供了完整的汽车销售解决方案，通过车型展示、试驾预约、经销商服务和销售线索管理，构建了完整的数字化购车体验。模块与地图服务、触点管理、售后服务等深度集成，为用户和经销商提供了高效的销售服务平台。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>