<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Basic Logger - &#x65e5;&#x5fd7;&#x7cfb;&#x7edf;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="basic-logger---日志系统模块文档">Basic Logger - 日志系统模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>basic_logger</code> 是 OneApp 基础工具模块群中的日志系统核心模块，提供统一的日志记录、管理和分析功能。该模块支持多级别日志、文件存储、网络上传、崩溃日志收集等功能，并提供了 Android 和 iOS 的原生日志监控能力。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: basic_logger</li>
<li><strong>版本</strong>: 0.2.5</li>
<li><strong>类型</strong>: Flutter Plugin</li>
<li><strong>Flutter 版本</strong>: &gt;=2.10.5</li>
<li><strong>Dart 版本</strong>: &gt;=2.16.2 &lt;4.0.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>basic_logger/
├── lib/
│   ├── basic_logger.dart         # 主导出文件
│   └── src/                      # 源代码目录
│       ├── logger/               # 日志核心实现
│       ├── appenders/            # 日志输出器
│       ├── formatters/           # 日志格式化器
│       ├── filters/              # 日志过滤器
│       ├── models/               # 数据模型
│       └── utils/                # 工具类
├── android/                      # Android 原生实现
│   ├── src/main/
│   │   ├── kotlin/               # Kotlin 源码
│   │   └── java/                 # Java 源码 (遗留)
│   └── build.gradle             # Android 构建配置
├── ios/                          # iOS 原生实现
│   ├── Classes/                  # Objective-C/Swift 源码
│   └── basic_logger.podspec     # CocoaPods 配置
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-日志记录器核心">1. 日志记录器核心</h3>
<h4 id="日志记录器实现">日志记录器实现</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 日志记录器核心类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicLogger</span> </span>{
  <span class="hljs-keyword">static</span> BasicLogger? _instance;
  <span class="hljs-keyword">static</span> BasicLogger <span class="hljs-keyword">get</span> instance =&gt; _instance ??= BasicLogger._internal();
  
  BasicLogger._internal();
  
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;LogAppender&gt; _appenders = [];
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;LogFilter&gt; _filters = [];
  LogLevel _minimumLevel = LogLevel.info;
  LogFormatter _formatter = DefaultLogFormatter();
  
  <span class="hljs-comment">// 初始化日志系统</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initialize({
    LogLevel minimumLevel = LogLevel.info,
    <span class="hljs-built_in">List</span>&lt;LogAppender&gt;? appenders,
    <span class="hljs-built_in">List</span>&lt;LogFilter&gt;? filters,
    LogFormatter? formatter,
  }) <span class="hljs-keyword">async</span> {
    _minimumLevel = minimumLevel;
    
    <span class="hljs-keyword">if</span> (appenders != <span class="hljs-keyword">null</span>) {
      _appenders.clear();
      _appenders.addAll(appenders);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 默认添加控制台和文件输出器</span>
      _appenders.addAll([
        ConsoleAppender(),
        FileAppender(),
      ]);
    }
    
    <span class="hljs-keyword">if</span> (filters != <span class="hljs-keyword">null</span>) {
      _filters.clear();
      _filters.addAll(filters);
    }
    
    <span class="hljs-keyword">if</span> (formatter != <span class="hljs-keyword">null</span>) {
      _formatter = formatter;
    }
    
    <span class="hljs-comment">// 初始化各个输出器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> appender <span class="hljs-keyword">in</span> _appenders) {
      <span class="hljs-keyword">await</span> appender.initialize();
    }
  }
  
  <span class="hljs-comment">// 记录日志</span>
  <span class="hljs-keyword">void</span> log(
    LogLevel level,
    <span class="hljs-built_in">String</span> message, {
    <span class="hljs-built_in">String?</span> tag,
    <span class="hljs-built_in">Object?</span> error,
    StackTrace? stackTrace,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context,
  }) {
    <span class="hljs-keyword">if</span> (level.index &lt; _minimumLevel.index) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">final</span> logEntry = LogEntry(
      level: level,
      message: message,
      tag: tag ?? <span class="hljs-string">&#x27;BasicLogger&#x27;</span>,
      error: error,
      stackTrace: stackTrace,
      context: context,
      timestamp: <span class="hljs-built_in">DateTime</span>.now(),
      thread: _getCurrentThread(),
    );
    
    <span class="hljs-comment">// 应用过滤器</span>
    <span class="hljs-built_in">bool</span> shouldLog = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> filter <span class="hljs-keyword">in</span> _filters) {
      <span class="hljs-keyword">if</span> (!filter.shouldLog(logEntry)) {
        shouldLog = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">break</span>;
      }
    }
    
    <span class="hljs-keyword">if</span> (shouldLog) {
      <span class="hljs-keyword">final</span> formattedLog = _formatter.format(logEntry);
      
      <span class="hljs-comment">// 发送到所有输出器</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> appender <span class="hljs-keyword">in</span> _appenders) {
        appender.append(formattedLog, logEntry);
      }
    }
  }
  
  <span class="hljs-comment">// 便捷方法</span>
  <span class="hljs-keyword">void</span> debug(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> tag, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context}) {
    log(LogLevel.debug, message, tag: tag, context: context);
  }
  
  <span class="hljs-keyword">void</span> info(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> tag, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context}) {
    log(LogLevel.info, message, tag: tag, context: context);
  }
  
  <span class="hljs-keyword">void</span> warning(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> tag, <span class="hljs-built_in">Object?</span> error, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context}) {
    log(LogLevel.warning, message, tag: tag, error: error, context: context);
  }
  
  <span class="hljs-keyword">void</span> error(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> tag, <span class="hljs-built_in">Object?</span> error, StackTrace? stackTrace, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context}) {
    log(LogLevel.error, message, tag: tag, error: error, stackTrace: stackTrace, context: context);
  }
  
  <span class="hljs-keyword">void</span> fatal(<span class="hljs-built_in">String</span> message, {<span class="hljs-built_in">String?</span> tag, <span class="hljs-built_in">Object?</span> error, StackTrace? stackTrace, <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context}) {
    log(LogLevel.fatal, message, tag: tag, error: error, stackTrace: stackTrace, context: context);
  }
  
  <span class="hljs-built_in">String</span> _getCurrentThread() {
    <span class="hljs-comment">// 获取当前线程信息</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;main&#x27;</span>; <span class="hljs-comment">// 简化实现</span>
  }
}

<span class="hljs-comment">// 日志级别枚举</span>
<span class="hljs-keyword">enum</span> LogLevel {
  debug,
  info,
  warning,
  error,
  fatal;
  
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> name {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> LogLevel.debug:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;DEBUG&#x27;</span>;
      <span class="hljs-keyword">case</span> LogLevel.info:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;INFO&#x27;</span>;
      <span class="hljs-keyword">case</span> LogLevel.warning:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;WARN&#x27;</span>;
      <span class="hljs-keyword">case</span> LogLevel.error:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;ERROR&#x27;</span>;
      <span class="hljs-keyword">case</span> LogLevel.fatal:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;FATAL&#x27;</span>;
    }
  }
  
  Color <span class="hljs-keyword">get</span> color {
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">case</span> LogLevel.debug:
        <span class="hljs-keyword">return</span> Colors.grey;
      <span class="hljs-keyword">case</span> LogLevel.info:
        <span class="hljs-keyword">return</span> Colors.blue;
      <span class="hljs-keyword">case</span> LogLevel.warning:
        <span class="hljs-keyword">return</span> Colors.orange;
      <span class="hljs-keyword">case</span> LogLevel.error:
        <span class="hljs-keyword">return</span> Colors.red;
      <span class="hljs-keyword">case</span> LogLevel.fatal:
        <span class="hljs-keyword">return</span> Colors.purple;
    }
  }
}

<span class="hljs-comment">// 日志条目模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogEntry</span> </span>{
  <span class="hljs-keyword">final</span> LogLevel level;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> message;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> tag;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Object?</span> error;
  <span class="hljs-keyword">final</span> StackTrace? stackTrace;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> timestamp;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> thread;
  
  <span class="hljs-keyword">const</span> LogEntry({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.level,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.message,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tag,
    <span class="hljs-keyword">this</span>.error,
    <span class="hljs-keyword">this</span>.stackTrace,
    <span class="hljs-keyword">this</span>.context,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.timestamp,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.thread,
  });
  
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">&#x27;level&#x27;</span>: level.name,
      <span class="hljs-string">&#x27;message&#x27;</span>: message,
      <span class="hljs-string">&#x27;tag&#x27;</span>: tag,
      <span class="hljs-string">&#x27;error&#x27;</span>: error?.toString(),
      <span class="hljs-string">&#x27;stackTrace&#x27;</span>: stackTrace?.toString(),
      <span class="hljs-string">&#x27;context&#x27;</span>: context,
      <span class="hljs-string">&#x27;timestamp&#x27;</span>: timestamp.toIso8601String(),
      <span class="hljs-string">&#x27;thread&#x27;</span>: thread,
    };
  }
}
</code></pre>
<h3 id="2-日志输出器-appenders">2. 日志输出器 (Appenders)</h3>
<h4 id="控制台输出器">控制台输出器</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 控制台日志输出器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsoleAppender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogAppender</span> </span>{
  <span class="hljs-built_in">bool</span> _enableColors = <span class="hljs-keyword">true</span>;
  
  ConsoleAppender({<span class="hljs-built_in">bool</span> enableColors = <span class="hljs-keyword">true</span>}) : _enableColors = enableColors;
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initialize() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 控制台输出器无需初始化</span>
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> append(<span class="hljs-built_in">String</span> formattedLog, LogEntry entry) {
    <span class="hljs-keyword">if</span> (kDebugMode) {
      <span class="hljs-keyword">if</span> (_enableColors) {
        _printWithColor(formattedLog, entry.level);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(formattedLog);
      }
    }
  }
  
  <span class="hljs-keyword">void</span> _printWithColor(<span class="hljs-built_in">String</span> message, LogLevel level) {
    <span class="hljs-comment">// ANSI 颜色代码</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> reset = <span class="hljs-string">&#x27;\x1B[0m&#x27;</span>;
    <span class="hljs-built_in">String</span> colorCode;
    
    <span class="hljs-keyword">switch</span> (level) {
      <span class="hljs-keyword">case</span> LogLevel.debug:
        colorCode = <span class="hljs-string">&#x27;\x1B[37m&#x27;</span>; <span class="hljs-comment">// 白色</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LogLevel.info:
        colorCode = <span class="hljs-string">&#x27;\x1B[36m&#x27;</span>; <span class="hljs-comment">// 青色</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LogLevel.warning:
        colorCode = <span class="hljs-string">&#x27;\x1B[33m&#x27;</span>; <span class="hljs-comment">// 黄色</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LogLevel.error:
        colorCode = <span class="hljs-string">&#x27;\x1B[31m&#x27;</span>; <span class="hljs-comment">// 红色</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> LogLevel.fatal:
        colorCode = <span class="hljs-string">&#x27;\x1B[35m&#x27;</span>; <span class="hljs-comment">// 紫色</span>
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;<span class="hljs-subst">$colorCode</span><span class="hljs-subst">$message</span><span class="hljs-subst">$reset</span>&#x27;</span>);
  }
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; close() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 控制台输出器无需关闭</span>
  }
}
</code></pre>
<h4 id="文件输出器">文件输出器</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 文件日志输出器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileAppender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogAppender</span> </span>{
  <span class="hljs-keyword">late</span> File _logFile;
  <span class="hljs-keyword">late</span> RandomAccessFile _fileHandle;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> _maxFileSize;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> _maxBackupFiles;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> _flushInterval;
  Timer? _flushTimer;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; _buffer = [];
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> _bufferSize;
  
  FileAppender({
    <span class="hljs-built_in">int</span> maxFileSize = <span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 10MB</span>
    <span class="hljs-built_in">int</span> maxBackupFiles = <span class="hljs-number">5</span>,
    <span class="hljs-built_in">Duration</span> flushInterval = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">5</span>),
    <span class="hljs-built_in">int</span> bufferSize = <span class="hljs-number">100</span>,
  }) : _maxFileSize = maxFileSize,
       _maxBackupFiles = maxBackupFiles,
       _flushInterval = flushInterval,
       _bufferSize = bufferSize;
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initialize() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> directory = <span class="hljs-keyword">await</span> getApplicationDocumentsDirectory();
    <span class="hljs-keyword">final</span> logDir = Directory(<span class="hljs-string">&#x27;<span class="hljs-subst">${directory.path}</span>/logs&#x27;</span>);
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">await</span> logDir.exists()) {
      <span class="hljs-keyword">await</span> logDir.create(recursive: <span class="hljs-keyword">true</span>);
    }
    
    _logFile = File(<span class="hljs-string">&#x27;<span class="hljs-subst">${logDir.path}</span>/app.log&#x27;</span>);
    _fileHandle = <span class="hljs-keyword">await</span> _logFile.open(mode: FileMode.append);
    
    <span class="hljs-comment">// 启动定时刷新</span>
    _flushTimer = Timer.periodic(_flushInterval, (_) =&gt; _flush());
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> append(<span class="hljs-built_in">String</span> formattedLog, LogEntry entry) {
    _buffer.add(formattedLog);
    
    <span class="hljs-comment">// 缓冲区满时立即刷新</span>
    <span class="hljs-keyword">if</span> (_buffer.length &gt;= _bufferSize) {
      _flush();
    }
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _flush() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_buffer.isEmpty) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> content = _buffer.join(<span class="hljs-string">&#x27;\n&#x27;</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>;
      <span class="hljs-keyword">await</span> _fileHandle.writeString(content);
      <span class="hljs-keyword">await</span> _fileHandle.flush();
      _buffer.clear();
      
      <span class="hljs-comment">// 检查文件大小，必要时进行轮转</span>
      <span class="hljs-keyword">await</span> _checkFileRotation();
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Failed to flush log buffer: <span class="hljs-subst">$e</span>&#x27;</span>);
    }
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _checkFileRotation() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> fileSize = <span class="hljs-keyword">await</span> _logFile.length();
    <span class="hljs-keyword">if</span> (fileSize &gt; _maxFileSize) {
      <span class="hljs-keyword">await</span> _rotateLogFiles();
    }
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _rotateLogFiles() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> _fileHandle.close();
    
    <span class="hljs-comment">// 轮转备份文件</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = _maxBackupFiles - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">1</span>; i--) {
      <span class="hljs-keyword">final</span> oldFile = File(<span class="hljs-string">&#x27;<span class="hljs-subst">${_logFile.path}</span>.<span class="hljs-subst">$i</span>&#x27;</span>);
      <span class="hljs-keyword">final</span> newFile = File(<span class="hljs-string">&#x27;<span class="hljs-subst">${_logFile.path}</span>.<span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span>&#x27;</span>);
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> oldFile.exists()) {
        <span class="hljs-keyword">if</span> (i == _maxBackupFiles - <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">await</span> oldFile.delete();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">await</span> oldFile.rename(newFile.path);
        }
      }
    }
    
    <span class="hljs-comment">// 将当前日志文件重命名为 .1</span>
    <span class="hljs-keyword">await</span> _logFile.rename(<span class="hljs-string">&#x27;<span class="hljs-subst">${_logFile.path}</span>.1&#x27;</span>);
    
    <span class="hljs-comment">// 创建新的日志文件</span>
    _logFile = File(_logFile.path.replaceAll(<span class="hljs-string">&#x27;.1&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>));
    _fileHandle = <span class="hljs-keyword">await</span> _logFile.open(mode: FileMode.write);
  }
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; close() <span class="hljs-keyword">async</span> {
    _flushTimer?.cancel();
    <span class="hljs-keyword">await</span> _flush();
    <span class="hljs-keyword">await</span> _fileHandle.close();
  }
}
</code></pre>
<h4 id="网络输出器">网络输出器</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 网络日志输出器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetworkAppender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogAppender</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> _endpoint;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; _headers;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> _batchInterval;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> _batchSize;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;LogEntry&gt; _batch = [];
  Timer? _batchTimer;
  <span class="hljs-keyword">final</span> Dio _dio;
  
  NetworkAppender({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> endpoint,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt;? headers,
    <span class="hljs-built_in">Duration</span> batchInterval = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">30</span>),
    <span class="hljs-built_in">int</span> batchSize = <span class="hljs-number">50</span>,
  }) : _endpoint = endpoint,
       _headers = headers ?? {},
       _batchInterval = batchInterval,
       _batchSize = batchSize,
       _dio = Dio();
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initialize() <span class="hljs-keyword">async</span> {
    _batchTimer = Timer.periodic(_batchInterval, (_) =&gt; _sendBatch());
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> append(<span class="hljs-built_in">String</span> formattedLog, LogEntry entry) {
    _batch.add(entry);
    
    <span class="hljs-keyword">if</span> (_batch.length &gt;= _batchSize) {
      _sendBatch();
    }
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _sendBatch() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_batch.isEmpty) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">final</span> batch = <span class="hljs-built_in">List</span>&lt;LogEntry&gt;.from(_batch);
    _batch.clear();
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> payload = {
        <span class="hljs-string">&#x27;logs&#x27;</span>: batch.map((entry) =&gt; entry.toJson()).toList(),
        <span class="hljs-string">&#x27;device_info&#x27;</span>: <span class="hljs-keyword">await</span> _getDeviceInfo(),
        <span class="hljs-string">&#x27;app_info&#x27;</span>: <span class="hljs-keyword">await</span> _getAppInfo(),
        <span class="hljs-string">&#x27;timestamp&#x27;</span>: <span class="hljs-built_in">DateTime</span>.now().toIso8601String(),
      };
      
      <span class="hljs-keyword">await</span> _dio.post(
        _endpoint,
        data: payload,
        options: Options(headers: _headers),
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Failed to send log batch: <span class="hljs-subst">$e</span>&#x27;</span>);
      <span class="hljs-comment">// 可以考虑将失败的日志保存到本地，稍后重试</span>
    }
  }
  
  Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; _getDeviceInfo() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 获取设备信息</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">&#x27;platform&#x27;</span>: Platform.isAndroid ? <span class="hljs-string">&#x27;android&#x27;</span> : <span class="hljs-string">&#x27;ios&#x27;</span>,
      <span class="hljs-string">&#x27;version&#x27;</span>: Platform.operatingSystemVersion,
      <span class="hljs-comment">// 更多设备信息...</span>
    };
  }
  
  Future&lt;<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;&gt; _getAppInfo() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> packageInfo = <span class="hljs-keyword">await</span> PackageInfo.fromPlatform();
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">&#x27;app_name&#x27;</span>: packageInfo.appName,
      <span class="hljs-string">&#x27;package_name&#x27;</span>: packageInfo.packageName,
      <span class="hljs-string">&#x27;version&#x27;</span>: packageInfo.version,
      <span class="hljs-string">&#x27;build_number&#x27;</span>: packageInfo.buildNumber,
    };
  }
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; close() <span class="hljs-keyword">async</span> {
    _batchTimer?.cancel();
    <span class="hljs-keyword">await</span> _sendBatch();
  }
}
</code></pre>
<h3 id="3-日志格式化器">3. 日志格式化器</h3>
<h4 id="默认格式化器">默认格式化器</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 日志格式化器接口</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFormatter</span> </span>{
  <span class="hljs-built_in">String</span> format(LogEntry entry);
}

<span class="hljs-comment">// 默认日志格式化器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultLogFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogFormatter</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> _pattern;
  <span class="hljs-keyword">final</span> DateFormat _dateFormat;
  
  DefaultLogFormatter({
    <span class="hljs-built_in">String</span> pattern = <span class="hljs-string">&#x27;{timestamp} [{level}] {tag}: {message}&#x27;</span>,
  }) : _pattern = pattern,
       _dateFormat = DateFormat(<span class="hljs-string">&#x27;yyyy-MM-dd HH:mm:ss.SSS&#x27;</span>);
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> format(LogEntry entry) {
    <span class="hljs-built_in">String</span> result = _pattern;
    
    result = result.replaceAll(<span class="hljs-string">&#x27;{timestamp}&#x27;</span>, _dateFormat.format(entry.timestamp));
    result = result.replaceAll(<span class="hljs-string">&#x27;{level}&#x27;</span>, entry.level.name);
    result = result.replaceAll(<span class="hljs-string">&#x27;{tag}&#x27;</span>, entry.tag);
    result = result.replaceAll(<span class="hljs-string">&#x27;{message}&#x27;</span>, entry.message);
    result = result.replaceAll(<span class="hljs-string">&#x27;{thread}&#x27;</span>, entry.thread);
    
    <span class="hljs-comment">// 添加错误信息</span>
    <span class="hljs-keyword">if</span> (entry.error != <span class="hljs-keyword">null</span>) {
      result += <span class="hljs-string">&#x27;\nError: <span class="hljs-subst">${entry.error}</span>&#x27;</span>;
    }
    
    <span class="hljs-comment">// 添加堆栈跟踪</span>
    <span class="hljs-keyword">if</span> (entry.stackTrace != <span class="hljs-keyword">null</span>) {
      result += <span class="hljs-string">&#x27;\nStackTrace:\n<span class="hljs-subst">${entry.stackTrace}</span>&#x27;</span>;
    }
    
    <span class="hljs-comment">// 添加上下文信息</span>
    <span class="hljs-keyword">if</span> (entry.context != <span class="hljs-keyword">null</span> &amp;&amp; entry.context!.isNotEmpty) {
      result += <span class="hljs-string">&#x27;\nContext: <span class="hljs-subst">${jsonEncode(entry.context)}</span>&#x27;</span>;
    }
    
    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// JSON 格式化器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonLogFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogFormatter</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> _prettyPrint;
  
  JsonLogFormatter({<span class="hljs-built_in">bool</span> prettyPrint = <span class="hljs-keyword">false</span>}) : _prettyPrint = prettyPrint;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> format(LogEntry entry) {
    <span class="hljs-keyword">final</span> json = entry.toJson();
    
    <span class="hljs-keyword">if</span> (_prettyPrint) {
      <span class="hljs-keyword">const</span> encoder = JsonEncoder.withIndent(<span class="hljs-string">&#x27;  &#x27;</span>);
      <span class="hljs-keyword">return</span> encoder.convert(json);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> jsonEncode(json);
    }
  }
}
</code></pre>
<h3 id="4-崩溃日志处理">4. 崩溃日志处理</h3>
<h4 id="崩溃日志收集器">崩溃日志收集器</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 崩溃日志收集器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CrashLogCollector</span> </span>{
  <span class="hljs-keyword">static</span> CrashLogCollector? _instance;
  <span class="hljs-keyword">static</span> CrashLogCollector <span class="hljs-keyword">get</span> instance =&gt; _instance ??= CrashLogCollector._internal();
  
  CrashLogCollector._internal();
  
  <span class="hljs-keyword">late</span> BasicLogger _logger;
  <span class="hljs-built_in">bool</span> _isInitialized = <span class="hljs-keyword">false</span>;
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; initialize(BasicLogger logger) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_isInitialized) <span class="hljs-keyword">return</span>;
    
    _logger = logger;
    
    <span class="hljs-comment">// 捕获 Flutter 框架错误</span>
    FlutterError.onError = (FlutterErrorDetails details) {
      _logFlutterError(details);
    };
    
    <span class="hljs-comment">// 捕获其他未处理的异常</span>
    PlatformDispatcher.instance.onError = (error, stack) {
      _logUnhandledException(error, stack);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    };
    
    <span class="hljs-comment">// 捕获 Zone 错误</span>
    runZonedGuarded(() {
      <span class="hljs-comment">// 应用代码在这里运行</span>
    }, (error, stack) {
      _logZoneError(error, stack);
    });
    
    _isInitialized = <span class="hljs-keyword">true</span>;
  }
  
  <span class="hljs-keyword">void</span> _logFlutterError(FlutterErrorDetails details) {
    _logger.fatal(
      <span class="hljs-string">&#x27;Flutter Error: <span class="hljs-subst">${details.summary}</span>&#x27;</span>,
      tag: <span class="hljs-string">&#x27;CrashLogger&#x27;</span>,
      error: details.exception,
      stackTrace: details.stack,
      context: {
        <span class="hljs-string">&#x27;library&#x27;</span>: details.<span class="hljs-keyword">library</span>,
        <span class="hljs-string">&#x27;context&#x27;</span>: details.context?.toString(),
        <span class="hljs-string">&#x27;information_collector&#x27;</span>: details.informationCollector?.toString(),
      },
    );
  }
  
  <span class="hljs-keyword">void</span> _logUnhandledException(<span class="hljs-built_in">Object</span> error, StackTrace stack) {
    _logger.fatal(
      <span class="hljs-string">&#x27;Unhandled Exception: <span class="hljs-subst">$error</span>&#x27;</span>,
      tag: <span class="hljs-string">&#x27;CrashLogger&#x27;</span>,
      error: error,
      stackTrace: stack,
    );
  }
  
  <span class="hljs-keyword">void</span> _logZoneError(<span class="hljs-built_in">Object</span> error, StackTrace stack) {
    _logger.fatal(
      <span class="hljs-string">&#x27;Zone Error: <span class="hljs-subst">$error</span>&#x27;</span>,
      tag: <span class="hljs-string">&#x27;CrashLogger&#x27;</span>,
      error: error,
      stackTrace: stack,
    );
  }
  
  <span class="hljs-comment">// 手动记录崩溃</span>
  <span class="hljs-keyword">void</span> logCrash({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> message,
    <span class="hljs-built_in">Object?</span> error,
    StackTrace? stackTrace,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context,
  }) {
    _logger.fatal(
      message,
      tag: <span class="hljs-string">&#x27;ManualCrash&#x27;</span>,
      error: error,
      stackTrace: stackTrace,
      context: context,
    );
  }
}
</code></pre>
<h2 id="android-原生实现">Android 原生实现</h2>
<h3 id="android-日志监控">Android 日志监控</h3>
<pre><code class="language-kotlin"><span class="hljs-comment">// Android ���志监控插件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogcatMonitorPlugin</span> : <span class="hljs-type">FlutterPlugin</span>, <span class="hljs-type">MethodCallHandler {</span></span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> channel: MethodChannel
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> logcatMonitor: LogcatMonitor? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAttachedToEngine</span><span class="hljs-params">(binding: <span class="hljs-type">FlutterPlugin</span>.<span class="hljs-type">FlutterPluginBinding</span>)</span></span> {
        channel = MethodChannel(binding.binaryMessenger, <span class="hljs-string">&quot;basic_logger&quot;</span>)
        channel.setMethodCallHandler(<span class="hljs-keyword">this</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodCall</span><span class="hljs-params">(call: <span class="hljs-type">MethodCall</span>, result: <span class="hljs-type">MethodChannel</span>.<span class="hljs-type">Result</span>)</span></span> {
        <span class="hljs-keyword">when</span> (call.method) {
            <span class="hljs-string">&quot;startLogcatMonitor&quot;</span> -&gt; {
                startLogcatMonitor(result)
            }
            <span class="hljs-string">&quot;stopLogcatMonitor&quot;</span> -&gt; {
                stopLogcatMonitor(result)
            }
            <span class="hljs-string">&quot;getNativeLogs&quot;</span> -&gt; {
                getNativeLogs(result)
            }
            <span class="hljs-keyword">else</span> -&gt; {
                result.notImplemented()
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startLogcatMonitor</span><span class="hljs-params">(result: <span class="hljs-type">MethodChannel</span>.<span class="hljs-type">Result</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            logcatMonitor = LogcatMonitor { logEntry -&gt;
                <span class="hljs-comment">// 将原生日志传递到 Flutter</span>
                channel.invokeMethod(<span class="hljs-string">&quot;onNativeLog&quot;</span>, logEntry.toMap())
            }
            logcatMonitor?.start()
            result.success(<span class="hljs-literal">true</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            result.error(<span class="hljs-string">&quot;MONITOR_ERROR&quot;</span>, <span class="hljs-string">&quot;Failed to start logcat monitor&quot;</span>, e.message)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopLogcatMonitor</span><span class="hljs-params">(result: <span class="hljs-type">MethodChannel</span>.<span class="hljs-type">Result</span>)</span></span> {
        logcatMonitor?.stop()
        logcatMonitor = <span class="hljs-literal">null</span>
        result.success(<span class="hljs-literal">true</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getNativeLogs</span><span class="hljs-params">(result: <span class="hljs-type">MethodChannel</span>.<span class="hljs-type">Result</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> logs = logcatMonitor?.getRecentLogs() ?: emptyList()
            result.success(logs.map { it.toMap() })
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            result.error(<span class="hljs-string">&quot;LOG_ERROR&quot;</span>, <span class="hljs-string">&quot;Failed to get native logs&quot;</span>, e.message)
        }
    }
}

<span class="hljs-comment">// Logcat 监控器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogcatMonitor</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> onLogEntry: (LogEntry) -&gt; <span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> process: Process? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isRunning = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logBuffer = mutableListOf&lt;LogEntry&gt;()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (isRunning) <span class="hljs-keyword">return</span>
        
        isRunning = <span class="hljs-literal">true</span>
        thread {
            <span class="hljs-keyword">try</span> {
                process = Runtime.getRuntime().exec(<span class="hljs-string">&quot;logcat -v time&quot;</span>)
                <span class="hljs-keyword">val</span> reader = BufferedReader(InputStreamReader(process!!.inputStream))
                
                reader.useLines { lines -&gt;
                    lines.forEach { line -&gt;
                        <span class="hljs-keyword">if</span> (isRunning) {
                            parseLogLine(line)?.let { logEntry -&gt;
                                logBuffer.add(logEntry)
                                onLogEntry(logEntry)
                                
                                <span class="hljs-comment">// 保持缓冲区大小</span>
                                <span class="hljs-keyword">if</span> (logBuffer.size &gt; <span class="hljs-number">1000</span>) {
                                    logBuffer.removeAt(<span class="hljs-number">0</span>)
                                }
                            }
                        }
                    }
                }
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                Log.e(<span class="hljs-string">&quot;LogcatMonitor&quot;</span>, <span class="hljs-string">&quot;Error reading logcat&quot;</span>, e)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
        isRunning = <span class="hljs-literal">false</span>
        process?.destroy()
        process = <span class="hljs-literal">null</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getRecentLogs</span><span class="hljs-params">()</span></span>: List&lt;LogEntry&gt; {
        <span class="hljs-keyword">return</span> logBuffer.toList()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">parseLogLine</span><span class="hljs-params">(line: <span class="hljs-type">String</span>)</span></span>: LogEntry? {
        <span class="hljs-comment">// 解析 logcat 输出格式</span>
        <span class="hljs-comment">// 示例: &quot;01-01 12:00:00.000 D/Tag(12345): Message&quot;</span>
        <span class="hljs-keyword">val</span> pattern = Regex(<span class="hljs-string">&quot;&quot;&quot;(\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})\s+([VDIWEF])/([^(]+)\((\d+)\):\s+(.*)&quot;&quot;&quot;</span>)
        <span class="hljs-keyword">val</span> match = pattern.find(line) ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
        
        <span class="hljs-keyword">val</span> (timestamp, level, tag, pid, message) = match.destructured
        
        <span class="hljs-keyword">return</span> LogEntry(
            timestamp = timestamp,
            level = level,
            tag = tag,
            pid = pid.toInt(),
            message = message
        )
    }
}
</code></pre>
<h2 id="ios-原生实现">iOS 原生实现</h2>
<h3 id="ios-日志监控">iOS 日志监控</h3>
<pre><code class="language-objc"><span class="hljs-comment">// iOS 日志监控插件</span>
<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">KitLoggerIosPlugin</span></span>

+ (<span class="hljs-type">void</span>)registerWithRegistrar:(<span class="hljs-built_in">NSObject</span>&lt;FlutterPluginRegistrar&gt;*)registrar {
    FlutterMethodChannel* channel = [FlutterMethodChannel
        methodChannelWithName:<span class="hljs-string">@&quot;basic_logger&quot;</span>
        binaryMessenger:[registrar messenger]];
    
    KitLoggerIosPlugin* instance = [[KitLoggerIosPlugin alloc] init];
    instance.channel = channel;
    [registrar addMethodCallDelegate:instance channel:channel];
}

- (<span class="hljs-type">void</span>)handleMethodCall:(FlutterMethodCall*)call result:(FlutterResult)result {
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">@&quot;startSystemLogMonitor&quot;</span> isEqualToString:call.method]) {
        [<span class="hljs-keyword">self</span> startSystemLogMonitor:result];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">@&quot;stopSystemLogMonitor&quot;</span> isEqualToString:call.method]) {
        [<span class="hljs-keyword">self</span> stopSystemLogMonitor:result];
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">@&quot;getSystemLogs&quot;</span> isEqualToString:call.method]) {
        [<span class="hljs-keyword">self</span> getSystemLogs:result];
    } <span class="hljs-keyword">else</span> {
        result(FlutterMethodNotImplemented);
    }
}

- (<span class="hljs-type">void</span>)startSystemLogMonitor:(FlutterResult)result {
    <span class="hljs-comment">// iOS 系统日志监控实现</span>
    <span class="hljs-keyword">self</span>.logStore = [[OSLogStore alloc] initWithScope:OSLogStoreCurrentProcessIdentifier
                                                error:<span class="hljs-literal">nil</span>];
    
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.logStore) {
        [<span class="hljs-keyword">self</span> startLogMonitoring];
        result(@YES);
    } <span class="hljs-keyword">else</span> {
        result([FlutterError errorWithCode:<span class="hljs-string">@&quot;MONITOR_ERROR&quot;</span>
                                   message:<span class="hljs-string">@&quot;Failed to initialize log store&quot;</span>
                                   details:<span class="hljs-literal">nil</span>]);
    }
}

- (<span class="hljs-type">void</span>)startLogMonitoring {
    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^{
        <span class="hljs-built_in">NSPredicate</span> *predicate = [<span class="hljs-built_in">NSPredicate</span> predicateWithFormat:<span class="hljs-string">@&quot;subsystem == %@&quot;</span>, 
                                  [[<span class="hljs-built_in">NSBundle</span> mainBundle] bundleIdentifier]];
        
        OSLogEnumerator *enumerator = [<span class="hljs-keyword">self</span>.logStore entriesEnumeratorWithOptions:<span class="hljs-number">0</span>
                                                                        position:<span class="hljs-literal">nil</span>
                                                                       predicate:predicate
                                                                           error:<span class="hljs-literal">nil</span>];
        
        <span class="hljs-keyword">for</span> (OSLogEntryLog *entry <span class="hljs-keyword">in</span> enumerator) {
            <span class="hljs-built_in">NSDictionary</span> *logData = @{
                <span class="hljs-string">@&quot;timestamp&quot;</span>: @([entry.date timeIntervalSince1970]),
                <span class="hljs-string">@&quot;level&quot;</span>: [<span class="hljs-keyword">self</span> logLevelString:entry.level],
                <span class="hljs-string">@&quot;category&quot;</span>: entry.category,
                <span class="hljs-string">@&quot;message&quot;</span>: entry.composedMessage
            };
            
            <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
                [<span class="hljs-keyword">self</span>.channel invokeMethod:<span class="hljs-string">@&quot;onSystemLog&quot;</span> arguments:logData];
            });
        }
    });
}

<span class="hljs-keyword">@end</span>
</code></pre>
<h2 id="使用示例">使用示例</h2>
<h3 id="基本使用">基本使用</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 初始化日志系统</span>
<span class="hljs-keyword">await</span> BasicLogger.instance.initialize(
  minimumLevel: LogLevel.debug,
  appenders: [
    ConsoleAppender(enableColors: <span class="hljs-keyword">true</span>),
    FileAppender(
      maxFileSize: <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 5MB</span>
      maxBackupFiles: <span class="hljs-number">3</span>,
    ),
    NetworkAppender(
      endpoint: <span class="hljs-string">&#x27;https://api.example.com/logs&#x27;</span>,
      headers: {<span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer token&#x27;</span>},
    ),
  ],
  formatter: DefaultLogFormatter(
    pattern: <span class="hljs-string">&#x27;{timestamp} [{level}] {tag}: {message}&#x27;</span>,
  ),
);

<span class="hljs-comment">// 初始化崩溃日志收集</span>
<span class="hljs-keyword">await</span> CrashLogCollector.instance.initialize(BasicLogger.instance);

<span class="hljs-comment">// 记录不同级别的日志</span>
BasicLogger.instance.debug(<span class="hljs-string">&#x27;Debug message&#x27;</span>);
BasicLogger.instance.info(<span class="hljs-string">&#x27;Info message&#x27;</span>, context: {<span class="hljs-string">&#x27;user_id&#x27;</span>: <span class="hljs-string">&#x27;123&#x27;</span>});
BasicLogger.instance.warning(<span class="hljs-string">&#x27;Warning message&#x27;</span>);
BasicLogger.instance.error(<span class="hljs-string">&#x27;Error occurred&#x27;</span>, error: exception);
BasicLogger.instance.fatal(<span class="hljs-string">&#x27;Fatal error&#x27;</span>, error: exception, stackTrace: stackTrace);
</code></pre>
<h3 id="高级配置">高级配置</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 自定义过滤器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TagFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogFilter</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt; _allowedTags;
  
  TagFilter(<span class="hljs-keyword">this</span>._allowedTags);
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldLog(LogEntry entry) {
    <span class="hljs-keyword">return</span> _allowedTags.contains(entry.tag);
  }
}

<span class="hljs-comment">// 使用自定义配置</span>
<span class="hljs-keyword">await</span> BasicLogger.instance.initialize(
  minimumLevel: LogLevel.info,
  appenders: [
    ConsoleAppender(),
    FileAppender(),
    NetworkAppender(
      endpoint: <span class="hljs-string">&#x27;https://log-server.com/api/logs&#x27;</span>,
      batchSize: <span class="hljs-number">20</span>,
      batchInterval: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
    ),
  ],
  filters: [
    TagFilter({<span class="hljs-string">&#x27;NetworkService&#x27;</span>, <span class="hljs-string">&#x27;UserAction&#x27;</span>, <span class="hljs-string">&#x27;CrashLogger&#x27;</span>}),
  ],
  formatter: JsonLogFormatter(prettyPrint: <span class="hljs-keyword">false</span>),
);
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="核心依赖">核心依赖</h3>
<ul>
<li><strong>flutter</strong>: Flutter SDK</li>
<li><strong>archive</strong>: 压缩功能支持</li>
</ul>
<h3 id="开发依赖">开发依赖</h3>
<ul>
<li><strong>flutter_test</strong>: 测试框架</li>
<li><strong>flutter_lints</strong>: 代码检查</li>
<li><strong>mockito</strong>: Mock 测试</li>
<li><strong>build_runner</strong>: 代码生成</li>
</ul>
<h2 id="性能优化">性能优化</h2>
<h3 id="日志性能优化">日志性能优化</h3>
<ul>
<li>异步日志写入</li>
<li>批量网络上传</li>
<li>内存缓冲区管理</li>
<li>日志文件轮转</li>
</ul>
<h3 id="内存管理">内存管理</h3>
<ul>
<li>限制内存缓冲区大小</li>
<li>及时释放不用的日志数据</li>
<li>压缩历史日志文件</li>
</ul>
<h2 id="总结">总结</h2>
<p><code>basic_logger</code> 模块为 OneApp 提供了强大而灵活的日志系统，支持多种输出方式、格式化选项和过滤机制。通过原生平台集成，能够收集系统级日志信息，为应用调试、性能监控和问题诊断提供了完整的解决方案。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>