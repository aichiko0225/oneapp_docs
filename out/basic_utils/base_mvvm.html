<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Base MVVM MVVM&#x67b6;&#x6784;&#x6a21;&#x5757;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="base-mvvm-mvvm架构模块">Base MVVM MVVM架构模块</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>base_mvvm</code> 是 OneApp 基础工具模块群中的 MVVM（Model-View-ViewModel）架构模块，提供了完整的MVVM架构实现和相关基础组件。该模块为Flutter应用开发提供了规范化的架构模式，包含了状态管理、数据绑定、视图抽象等核心功能。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: base_mvvm</li>
<li><strong>版本</strong>: 0.0.1</li>
<li><strong>描述</strong>: MVVM架构基础模块</li>
<li><strong>Flutter 版本</strong>: &gt;=1.17.0</li>
<li><strong>Dart 版本</strong>: &gt;=3.0.0 &lt;4.0.0</li>
</ul>
<h2 id="功能特性">功能特性</h2>
<h3 id="核心功能">核心功能</h3>
<ol>
<li>
<p><strong>MVVM架构实现</strong></p>
<ul>
<li>Model-View-ViewModel分离</li>
<li>数据双向绑定</li>
<li>视图状态管理</li>
<li>命令模式支持</li>
</ul>
</li>
<li>
<p><strong>状态管理系统</strong></p>
<ul>
<li>响应式状态管理</li>
<li>异步状态处理</li>
<li>状态变化通知</li>
<li>状态持久化</li>
</ul>
</li>
<li>
<p><strong>基础组件库</strong></p>
<ul>
<li>可刷新列表组件</li>
<li>网络图片缓存</li>
<li>加载状态组件</li>
<li>错误处理组件</li>
</ul>
</li>
<li>
<p><strong>数据流管理</strong></p>
<ul>
<li>单向数据流</li>
<li>事件驱动更新</li>
<li>数据流监听</li>
<li>副作用处理</li>
</ul>
</li>
</ol>
<h2 id="技术架构">技术架构</h2>
<h3 id="目录结构">目录结构</h3>
<pre><code>lib/
├── base_mvvm.dart              # 模块入口文件
├── src/                        # 源代码目录
│   ├── mvvm/                   # MVVM核心
│   ├── base_components/        # 基础组件
│   ├── state_management/       # 状态管理
│   ├── data_binding/           # 数据绑定
│   ├── commands/               # 命令模式
│   └── utils/                  # 工具类
├── widgets/                    # 通用Widget
└── test/                       # 测试文件
</code></pre>
<h3 id="依赖关系">依赖关系</h3>
<h4 id="状态管理依赖">状态管理依赖</h4>
<ul>
<li><code>provider: ^6.0.5</code> - 状态管理框架</li>
<li><code>rxdart: ^0.27.7</code> - 响应式编程</li>
</ul>
<h4 id="ui组件依赖">UI组件依赖</h4>
<ul>
<li><code>easy_refresh: ^3.3.2+1</code> - 下拉刷新组件</li>
<li><code>cached_network_image: ^3.3.0</code> - 网络图片缓存</li>
<li><code>flutter_cache_manager: ^3.3.1</code> - 缓存管理</li>
</ul>
<h4 id="工具依赖">工具依赖</h4>
<ul>
<li><code>path_provider: ^2.1.3</code> - 文件路径</li>
<li><code>logger: 1.4.0</code> - 日志框架</li>
</ul>
<h4 id="内部依赖">内部依赖</h4>
<ul>
<li><code>basic_utils</code> - 基础工具（本地路径）</li>
<li><code>basic_uis</code> - 基础UI组件（本地路径）</li>
</ul>
<h2 id="核心模块分析">核心模块分析</h2>
<h3 id="1-模块入口-base_mvvmdart">1. 模块入口 (<code>base_mvvm.dart</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>MVVM架构组件统一导出</li>
<li>架构配置初始化</li>
<li>依赖注入设置</li>
</ul>
<h3 id="2-mvvm核心-srcmvvm">2. MVVM核心 (<code>src/mvvm/</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>MVVM架构模式实现</li>
<li>基础类定义</li>
<li>生命周期管理</li>
<li>数据流控制</li>
</ul>
<p><strong>主要组件</strong>:</p>
<ul>
<li><code>BaseModel</code> - 数据模型基类</li>
<li><code>BaseView</code> - 视图基类</li>
<li><code>BaseViewModel</code> - 视图模型基类</li>
<li><code>MVVMController</code> - MVVM控制器</li>
</ul>
<h4 id="baseviewmodel-实现">BaseViewModel 实现</h4>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  <span class="hljs-built_in">bool</span> _isLoading = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">String?</span> _errorMessage;
  <span class="hljs-built_in">bool</span> _isDisposed = <span class="hljs-keyword">false</span>;

  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLoading =&gt; _isLoading;
  <span class="hljs-built_in">String?</span> <span class="hljs-keyword">get</span> errorMessage =&gt; _errorMessage;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> hasError =&gt; _errorMessage != <span class="hljs-keyword">null</span>;

  <span class="hljs-keyword">void</span> setLoading(<span class="hljs-built_in">bool</span> loading) {
    <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;
    _isLoading = loading;
    notifyListeners();
  }

  <span class="hljs-keyword">void</span> setError(<span class="hljs-built_in">String?</span> error) {
    <span class="hljs-keyword">if</span> (_isDisposed) <span class="hljs-keyword">return</span>;
    _errorMessage = error;
    notifyListeners();
  }

  <span class="hljs-keyword">void</span> clearError() {
    setError(<span class="hljs-keyword">null</span>);
  }

  Future&lt;T?&gt; executeAsync&lt;T&gt;(Future&lt;T&gt; <span class="hljs-built_in">Function</span>() action) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      setLoading(<span class="hljs-keyword">true</span>);
      clearError();
      <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> action();
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (e) {
      setError(e.toString());
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    } <span class="hljs-keyword">finally</span> {
      setLoading(<span class="hljs-keyword">false</span>);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _isDisposed = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h4 id="baseview-实现">BaseView 实现</h4>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseViewModel</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> BaseView({Key? key}) : <span class="hljs-keyword">super</span>(key: key);

  T createViewModel();

  Widget buildView(BuildContext context, T viewModel);

  <span class="hljs-meta">@override</span>
  State&lt;BaseView&lt;T&gt;&gt; createState() =&gt; _BaseViewState&lt;T&gt;();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_BaseViewState</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseViewModel</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">BaseView</span>&lt;<span class="hljs-title">T</span>&gt;&gt; </span>{
  <span class="hljs-keyword">late</span> T _viewModel;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _viewModel = widget.createViewModel();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ChangeNotifierProvider&lt;T&gt;(
      create: (_) =&gt; _viewModel,
      child: Consumer&lt;T&gt;(
        builder: (context, viewModel, child) {
          <span class="hljs-keyword">return</span> Scaffold(
            body: Stack(
              children: [
                widget.buildView(context, viewModel),
                <span class="hljs-keyword">if</span> (viewModel.isLoading)
                  <span class="hljs-keyword">const</span> Center(
                    child: CircularProgressIndicator(),
                  ),
                <span class="hljs-keyword">if</span> (viewModel.hasError)
                  _buildErrorWidget(viewModel.errorMessage!),
              ],
            ),
          );
        },
      ),
    );
  }

  Widget _buildErrorWidget(<span class="hljs-built_in">String</span> error) {
    <span class="hljs-keyword">return</span> Container(
      color: Colors.black54,
      child: Center(
        child: Card(
          margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
          child: Padding(
            padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                <span class="hljs-keyword">const</span> Icon(Icons.error, color: Colors.red, size: <span class="hljs-number">48</span>),
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
                Text(error, textAlign: TextAlign.center),
                <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
                ElevatedButton(
                  onPressed: () =&gt; _viewModel.clearError(),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">&#x27;确定&#x27;</span>),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _viewModel.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 id="3-状态管理-srcstate_management">3. 状态管理 (<code>src/state_management/</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>应用状态统一管理</li>
<li>状态变化监听</li>
<li>状态持久化</li>
<li>状态恢复机制</li>
</ul>
<p><strong>主要组件</strong>:</p>
<ul>
<li><code>StateManager</code> - 状态管理器</li>
<li><code>StateObserver</code> - 状态观察者</li>
<li><code>StatePersistence</code> - 状态持久化</li>
<li><code>StateRestore</code> - 状态恢复</li>
</ul>
<h3 id="4-数据绑定-srcdata_binding">4. 数据绑定 (<code>src/data_binding/</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>视图与数据双向绑定</li>
<li>属性变化监听</li>
<li>数据验证机制</li>
<li>绑定表达式解析</li>
</ul>
<p><strong>主要组件</strong>:</p>
<ul>
<li><code>DataBinder</code> - 数据绑定器</li>
<li><code>PropertyObserver</code> - 属性观察者</li>
<li><code>ValidationRule</code> - 验证规则</li>
<li><code>BindingExpression</code> - 绑定表达式</li>
</ul>
<h3 id="5-命令模式-srccommands">5. 命令模式 (<code>src/commands/</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>用户操作命令封装</li>
<li>命令执行管理</li>
<li>撤销重做支持</li>
<li>命令队列处理</li>
</ul>
<p><strong>主要组件</strong>:</p>
<ul>
<li><code>Command</code> - 命令基类</li>
<li><code>AsyncCommand</code> - 异步命令</li>
<li><code>CommandManager</code> - 命令管理器</li>
<li><code>UndoRedoStack</code> - 撤销重做栈</li>
</ul>
<h4 id="command-实现">Command 实现</h4>
<pre><code class="language-dart"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Command</span> </span>{
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> canExecute;
  Future&lt;<span class="hljs-keyword">void</span>&gt; execute();
  
  <span class="hljs-keyword">final</span> StreamController&lt;<span class="hljs-built_in">bool</span>&gt; _canExecuteController = 
      StreamController&lt;<span class="hljs-built_in">bool</span>&gt;.broadcast();
  
  Stream&lt;<span class="hljs-built_in">bool</span>&gt; <span class="hljs-keyword">get</span> canExecuteChanged =&gt; _canExecuteController.stream;
  
  <span class="hljs-keyword">void</span> notifyCanExecuteChanged() {
    _canExecuteController.add(canExecute);
  }
  
  <span class="hljs-keyword">void</span> dispose() {
    _canExecuteController.close();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncCommand</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Command</span> </span>{
  <span class="hljs-keyword">final</span> Future&lt;<span class="hljs-keyword">void</span>&gt; <span class="hljs-built_in">Function</span>() _action;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> <span class="hljs-built_in">Function</span>()? _canExecuteFunc;
  <span class="hljs-built_in">bool</span> _isExecuting = <span class="hljs-keyword">false</span>;
  
  AsyncCommand(<span class="hljs-keyword">this</span>._action, [<span class="hljs-keyword">this</span>._canExecuteFunc]);
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> canExecute =&gt; !_isExecuting &amp;&amp; (_canExecuteFunc?.call() ?? <span class="hljs-keyword">true</span>);
  
  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; execute() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (!canExecute) <span class="hljs-keyword">return</span>;
    
    _isExecuting = <span class="hljs-keyword">true</span>;
    notifyCanExecuteChanged();
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> _action();
    } <span class="hljs-keyword">finally</span> {
      _isExecuting = <span class="hljs-keyword">false</span>;
      notifyCanExecuteChanged();
    }
  }
}
</code></pre>
<h3 id="6-基础组件-srcbase_components">6. 基础组件 (<code>src/base_components/</code>)</h3>
<p><strong>功能职责</strong>:</p>
<ul>
<li>通用UI组件封装</li>
<li>业务无关组件</li>
<li>可复用组件库</li>
<li>组件样式统一</li>
</ul>
<p><strong>主要组件</strong>:</p>
<ul>
<li><code>RefreshableListView</code> - 可刷新列表</li>
<li><code>NetworkImageWidget</code> - 网络图片组件</li>
<li><code>LoadingWidget</code> - 加载组件</li>
<li><code>ErrorWidget</code> - 错误组件</li>
</ul>
<h4 id="refreshablelistview-实现">RefreshableListView 实现</h4>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RefreshableListView</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> Future&lt;<span class="hljs-built_in">List</span>&lt;T&gt;&gt; <span class="hljs-built_in">Function</span>() onRefresh;
  <span class="hljs-keyword">final</span> Future&lt;<span class="hljs-built_in">List</span>&lt;T&gt;&gt; <span class="hljs-built_in">Function</span>()? onLoadMore;
  <span class="hljs-keyword">final</span> Widget <span class="hljs-built_in">Function</span>(BuildContext, T, <span class="hljs-built_in">int</span>) itemBuilder;
  <span class="hljs-keyword">final</span> Widget? emptyWidget;
  <span class="hljs-keyword">final</span> Widget? errorWidget;
  
  <span class="hljs-keyword">const</span> RefreshableListView({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onRefresh,
    <span class="hljs-keyword">this</span>.onLoadMore,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.itemBuilder,
    <span class="hljs-keyword">this</span>.emptyWidget,
    <span class="hljs-keyword">this</span>.errorWidget,
  }) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  State&lt;RefreshableListView&lt;T&gt;&gt; createState() =&gt; _RefreshableListViewState&lt;T&gt;();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_RefreshableListViewState</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">RefreshableListView</span>&lt;<span class="hljs-title">T</span>&gt;&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;T&gt; _items = [];
  <span class="hljs-built_in">bool</span> _isLoading = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">bool</span> _hasError = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">String?</span> _errorMessage;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _refresh();
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _refresh() <span class="hljs-keyword">async</span> {
    setState(() {
      _isLoading = <span class="hljs-keyword">true</span>;
      _hasError = <span class="hljs-keyword">false</span>;
    });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> items = <span class="hljs-keyword">await</span> widget.onRefresh();
      setState(() {
        _items.clear();
        _items.addAll(items);
        _isLoading = <span class="hljs-keyword">false</span>;
      });
    } <span class="hljs-keyword">catch</span> (e) {
      setState(() {
        _isLoading = <span class="hljs-keyword">false</span>;
        _hasError = <span class="hljs-keyword">true</span>;
        _errorMessage = e.toString();
      });
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadMore() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (widget.onLoadMore == <span class="hljs-keyword">null</span> || _isLoading) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> items = <span class="hljs-keyword">await</span> widget.onLoadMore!();
      setState(() {
        _items.addAll(items);
      });
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// Handle load more error</span>
    }
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">if</span> (_isLoading &amp;&amp; _items.isEmpty) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Center(child: CircularProgressIndicator());
    }

    <span class="hljs-keyword">if</span> (_hasError &amp;&amp; _items.isEmpty) {
      <span class="hljs-keyword">return</span> widget.errorWidget ?? 
          Center(child: Text(<span class="hljs-string">&#x27;Error: <span class="hljs-subst">$_errorMessage</span>&#x27;</span>));
    }

    <span class="hljs-keyword">if</span> (_items.isEmpty) {
      <span class="hljs-keyword">return</span> widget.emptyWidget ?? 
          <span class="hljs-keyword">const</span> Center(child: Text(<span class="hljs-string">&#x27;No data&#x27;</span>));
    }

    <span class="hljs-keyword">return</span> EasyRefresh(
      onRefresh: _refresh,
      onLoad: widget.onLoadMore != <span class="hljs-keyword">null</span> ? _loadMore : <span class="hljs-keyword">null</span>,
      child: ListView.builder(
        itemCount: _items.length,
        itemBuilder: (context, index) {
          <span class="hljs-keyword">return</span> widget.itemBuilder(context, _items[index], index);
        },
      ),
    );
  }
}
</code></pre>
<h2 id="mvvm架构模式">MVVM架构模式</h2>
<h3 id="架构层次">架构层次</h3>
<pre><code>View Layer (视图层)
    ↓ (用户交互)
ViewModel Layer (视图模型层)
    ↓ (业务逻辑)
Model Layer (模型层)
    ↓ (数据操作)
Data Layer (数据层)
</code></pre>
<h3 id="数据流向">数据流向</h3>
<pre><code class="language-mermaid">graph TD
    A[View 视图] --&gt; B[ViewModel 视图模型]
    B --&gt; C[Model 模型]
    C --&gt; D[Data Source 数据源]
    
    D --&gt; C
    C --&gt; B
    B --&gt; A
    
    E[User Input 用户输入] --&gt; A
    F[Data Binding 数据绑定] --&gt; A
</code></pre>
<h3 id="职责分离">职责分离</h3>
<ol>
<li>
<p><strong>View（视图）</strong></p>
<ul>
<li>负责UI展示</li>
<li>处理用户交互</li>
<li>绑定ViewModel数据</li>
<li>不包含业务逻辑</li>
</ul>
</li>
<li>
<p><strong>ViewModel（视图模型）</strong></p>
<ul>
<li>处理业务逻辑</li>
<li>管理视图状态</li>
<li>调用Model方法</li>
<li>提供数据绑定</li>
</ul>
</li>
<li>
<p><strong>Model（模型）</strong></p>
<ul>
<li>定义数据结构</li>
<li>封装业务规则</li>
<li>提供数据操作接口</li>
<li>独立于视图层</li>
</ul>
</li>
</ol>
<h2 id="状态管理策略">状态管理策略</h2>
<h3 id="响应式状态">响应式状态</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponsiveState</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> BehaviorSubject&lt;T&gt; _subject;
  
  ResponsiveState(T initialValue) : _subject = BehaviorSubject&lt;T&gt;.seeded(initialValue);
  
  T <span class="hljs-keyword">get</span> value =&gt; _subject.value;
  Stream&lt;T&gt; <span class="hljs-keyword">get</span> stream =&gt; _subject.stream;
  
  <span class="hljs-keyword">void</span> update(T newValue) {
    _subject.add(newValue);
  }
  
  <span class="hljs-keyword">void</span> dispose() {
    _subject.close();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StateViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseViewModel</span> </span>{
  <span class="hljs-keyword">final</span> ResponsiveState&lt;<span class="hljs-built_in">String</span>&gt; _title = ResponsiveState&lt;<span class="hljs-built_in">String</span>&gt;(<span class="hljs-string">&#x27;&#x27;</span>);
  <span class="hljs-keyword">final</span> ResponsiveState&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt; _items = ResponsiveState&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt;([]);
  
  Stream&lt;<span class="hljs-built_in">String</span>&gt; <span class="hljs-keyword">get</span> titleStream =&gt; _title.stream;
  Stream&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt; <span class="hljs-keyword">get</span> itemsStream =&gt; _items.stream;
  
  <span class="hljs-keyword">void</span> updateTitle(<span class="hljs-built_in">String</span> title) {
    _title.update(title);
  }
  
  <span class="hljs-keyword">void</span> updateItems(<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items) {
    _items.update(items);
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _title.dispose();
    _items.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 id="状态持久化">状态持久化</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatePersistence</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> _keyPrefix = <span class="hljs-string">&#x27;mvvm_state_&#x27;</span>;
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; saveState&lt;T&gt;(<span class="hljs-built_in">String</span> key, T state) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> json = jsonEncode(state);
    <span class="hljs-keyword">await</span> prefs.setString(<span class="hljs-string">&#x27;<span class="hljs-subst">$_keyPrefix</span><span class="hljs-subst">$key</span>&#x27;</span>, json);
  }
  
  <span class="hljs-keyword">static</span> Future&lt;T?&gt; loadState&lt;T&gt;(<span class="hljs-built_in">String</span> key, T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;) fromJson) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> json = prefs.getString(<span class="hljs-string">&#x27;<span class="hljs-subst">$_keyPrefix</span><span class="hljs-subst">$key</span>&#x27;</span>);
    <span class="hljs-keyword">if</span> (json != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">final</span> map = jsonDecode(json) <span class="hljs-keyword">as</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;;
      <span class="hljs-keyword">return</span> fromJson(map);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; clearState(<span class="hljs-built_in">String</span> key) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> prefs = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> prefs.remove(<span class="hljs-string">&#x27;<span class="hljs-subst">$_keyPrefix</span><span class="hljs-subst">$key</span>&#x27;</span>);
  }
}
</code></pre>
<h2 id="数据绑定机制">数据绑定机制</h2>
<h3 id="双向数据绑定">双向数据绑定</h3>
<pre><code class="language-dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TwoWayBinding</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> ValueNotifier&lt;T&gt; _notifier;
  <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(T)? _onChanged;
  
  TwoWayBinding(T initialValue, [<span class="hljs-keyword">this</span>._onChanged]) 
      : _notifier = ValueNotifier&lt;T&gt;(initialValue);
  
  T <span class="hljs-keyword">get</span> value =&gt; _notifier.value;
  <span class="hljs-keyword">set</span> value(T newValue) {
    _notifier.value = newValue;
    _onChanged?.call(newValue);
  }
  
  ValueListenable&lt;T&gt; <span class="hljs-keyword">get</span> listenable =&gt; _notifier;
  
  <span class="hljs-keyword">void</span> dispose() {
    _notifier.dispose();
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BindableTextField</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> TwoWayBinding&lt;<span class="hljs-built_in">String</span>&gt; binding;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> hintText;
  <span class="hljs-keyword">final</span> TextInputType? keyboardType;
  
  <span class="hljs-keyword">const</span> BindableTextField({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.binding,
    <span class="hljs-keyword">this</span>.hintText,
    <span class="hljs-keyword">this</span>.keyboardType,
  }) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  State&lt;BindableTextField&gt; createState() =&gt; _BindableTextFieldState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_BindableTextFieldState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">BindableTextField</span>&gt; </span>{
  <span class="hljs-keyword">late</span> TextEditingController _controller;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _controller = TextEditingController(text: widget.binding.value);
    _controller.addListener(_onTextChanged);
    widget.binding.listenable.addListener(_onBindingChanged);
  }
  
  <span class="hljs-keyword">void</span> _onTextChanged() {
    widget.binding.value = _controller.text;
  }
  
  <span class="hljs-keyword">void</span> _onBindingChanged() {
    <span class="hljs-keyword">if</span> (_controller.text != widget.binding.value) {
      _controller.text = widget.binding.value;
    }
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> TextField(
      controller: _controller,
      decoration: InputDecoration(
        hintText: widget.hintText,
      ),
      keyboardType: widget.keyboardType,
    );
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h2 id="性能优化">性能优化</h2>
<h3 id="视图更新优化">视图更新优化</h3>
<ul>
<li><strong>局部更新</strong>: 使用Consumer精确控制更新范围</li>
<li><strong>状态分离</strong>: 分离不同类型的状态避免不必要更新</li>
<li><strong>延迟计算</strong>: 使用计算属性延迟复杂计算</li>
<li><strong>缓存机制</strong>: 缓存计算结果避免重复计算</li>
</ul>
<h3 id="内存管理">内存管理</h3>
<ul>
<li><strong>生命周期管理</strong>: 正确管理ViewModel生命周期</li>
<li><strong>资源释放</strong>: 及时释放Stream和订阅</li>
<li><strong>弱引用</strong>: 使用弱引用避免循环引用</li>
<li><strong>内存监控</strong>: 监控内存使用情况</li>
</ul>
<h2 id="测试策略">测试策略</h2>
<h3 id="单元测试">单元测试</h3>
<ul>
<li><strong>ViewModel测试</strong>: 业务逻辑单元测试</li>
<li><strong>Model测试</strong>: 数据模型测试</li>
<li><strong>Command测试</strong>: 命令执行测试</li>
<li><strong>状态管理测试</strong>: 状态变化测试</li>
</ul>
<h3 id="widget测试">Widget测试</h3>
<ul>
<li><strong>View测试</strong>: UI组件渲染测试</li>
<li><strong>交互测试</strong>: 用户交互响应测试</li>
<li><strong>数据绑定测试</strong>: 数据绑定正确性测试</li>
<li><strong>状态更新测试</strong>: 状态更新后UI变化测试</li>
</ul>
<h3 id="集成测试">集成测试</h3>
<ul>
<li><strong>端到端测试</strong>: 完整用户流程测试</li>
<li><strong>架构测试</strong>: MVVM架构正确性测试</li>
<li><strong>性能测试</strong>: 架构性能表现测试</li>
<li><strong>兼容性测试</strong>: 不同场景兼容性测试</li>
</ul>
<h2 id="最佳实践">最佳实践</h2>
<h3 id="架构设计">架构设计</h3>
<ol>
<li><strong>单一职责</strong>: 每个层次职责单一明确</li>
<li><strong>依赖倒置</strong>: 依赖抽象而非具体实现</li>
<li><strong>开闭原则</strong>: 对扩展开放对修改关闭</li>
<li><strong>接口隔离</strong>: 使用小而专的接口</li>
</ol>
<h3 id="开发建议">开发建议</h3>
<ol>
<li><strong>状态管理</strong>: 合理划分状态粒度</li>
<li><strong>数据绑定</strong>: 避免复杂的绑定表达式</li>
<li><strong>异步处理</strong>: 正确处理异步操作</li>
<li><strong>错误处理</strong>: 完善的错误处理机制</li>
</ol>
<h3 id="代码组织">代码组织</h3>
<ol>
<li><strong>文件结构</strong>: 按功能和层次组织文件</li>
<li><strong>命名规范</strong>: 统一的命名约定</li>
<li><strong>注释文档</strong>: 清晰的代码注释</li>
<li><strong>代码复用</strong>: 提取公共组件和逻辑</li>
</ol>
<h2 id="总结">总结</h2>
<p><code>base_mvvm</code> 模块作为 OneApp 的MVVM架构基础模块，提供了完整的架构模式实现和配套工具。通过清晰的层次分离、响应式状态管理和双向数据绑定，为Flutter应用开发提供了规范化的架构指导。模块具有良好的可测试性和可维护性，能够支撑大型应用的开发需求。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>