<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>OneApp Membership - &#x4f1a;&#x5458;&#x7cfb;&#x7edf;&#x6a21;&#x5757;&#x6587;&#x6863;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="oneapp-membership---会员系统模块文档">OneApp Membership - 会员系统模块文档</h1>
<h2 id="模块概述">模块概述</h2>
<p><code>oneapp_membership</code> 是 OneApp 的会员系统核心模块，提供会员等级管理、积分系统、权益管理、会员特权等功能。该模块与社区、账户、售后服务等模块深度集成，为用户提供完整的会员生态体验。</p>
<h3 id="基本信息">基本信息</h3>
<ul>
<li><strong>模块名称</strong>: oneapp_membership</li>
<li><strong>版本</strong>: 0.0.1</li>
<li><strong>类型</strong>: Flutter Package</li>
<li><strong>Dart 版本</strong>: &gt;=3.0.0 &lt;4.0.0</li>
<li><strong>Flutter 版本</strong>: &gt;=1.17.0</li>
</ul>
<h2 id="目录结构">目录结构</h2>
<pre><code>oneapp_membership/
├── lib/
│   ├── oneapp_membership.dart    # 主导出文件
│   └── src/                      # 源代码目录
│       ├── pages/                # 会员页面
│       ├── widgets/              # 会员组件
│       ├── models/               # 数据模型
│       ├── services/             # 服务层
│       ├── blocs/                # 状态管理
│       ├── utils/                # 工具类
│       └── constants/            # 常量定义
├── assets/                       # 静态资源
├── test/                         # 测试文件
├── pubspec.yaml                  # 依赖配置
└── README.md                     # 项目说明
</code></pre>
<h2 id="核心功能模块">核心功能模块</h2>
<h3 id="1-会员等级管理">1. 会员等级管理</h3>
<h4 id="会员等级系统">会员等级系统</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 会员等级枚举</span>
<span class="hljs-keyword">enum</span> MembershipTier {
  bronze,   <span class="hljs-comment">// 青铜会员</span>
  silver,   <span class="hljs-comment">// 白银会员</span>
  gold,     <span class="hljs-comment">// 黄金会员</span>
  platinum, <span class="hljs-comment">// 铂金会员</span>
  diamond,  <span class="hljs-comment">// 钻石会员</span>
  vip       <span class="hljs-comment">// VIP会员</span>
}

<span class="hljs-comment">// 会员等级模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipLevel</span> </span>{
  <span class="hljs-keyword">final</span> MembershipTier tier;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> iconUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> requiredPoints;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;MemberBenefit&gt; benefits;
  <span class="hljs-keyword">final</span> MembershipPrivileges privileges;
  
  <span class="hljs-keyword">const</span> MembershipLevel({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tier,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.iconUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.requiredPoints,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.benefits,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.privileges,
  });
  
  <span class="hljs-keyword">factory</span> MembershipLevel.bronze() {
    <span class="hljs-keyword">return</span> MembershipLevel(
      tier: MembershipTier.bronze,
      name: <span class="hljs-string">&#x27;青铜会员&#x27;</span>,
      description: <span class="hljs-string">&#x27;入门级会员，享受基础权益&#x27;</span>,
      color: Color(<span class="hljs-number">0xFFCD7F32</span>),
      iconUrl: <span class="hljs-string">&#x27;assets/membership/bronze_icon.png&#x27;</span>,
      requiredPoints: <span class="hljs-number">0</span>,
      benefits: [
        MemberBenefit.basicSupport(),
        MemberBenefit.monthlyReport(),
      ],
      privileges: MembershipPrivileges.bronze(),
    );
  }
  
  <span class="hljs-keyword">factory</span> MembershipLevel.gold() {
    <span class="hljs-keyword">return</span> MembershipLevel(
      tier: MembershipTier.gold,
      name: <span class="hljs-string">&#x27;黄金会员&#x27;</span>,
      description: <span class="hljs-string">&#x27;高级会员，享受优质服务&#x27;</span>,
      color: Color(<span class="hljs-number">0xFFFFD700</span>),
      iconUrl: <span class="hljs-string">&#x27;assets/membership/gold_icon.png&#x27;</span>,
      requiredPoints: <span class="hljs-number">10000</span>,
      benefits: [
        MemberBenefit.prioritySupport(),
        MemberBenefit.freeCharging(times: <span class="hljs-number">5</span>),
        MemberBenefit.exclusiveEvents(),
        MemberBenefit.discounts(percentage: <span class="hljs-number">15</span>),
      ],
      privileges: MembershipPrivileges.gold(),
    );
  }
}

<span class="hljs-comment">// 会员服务管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipService</span> </span>{
  <span class="hljs-keyword">final</span> MembershipRepository _repository;
  <span class="hljs-keyword">final</span> PointsService _pointsService;
  <span class="hljs-keyword">final</span> NotificationService _notificationService;
  
  MembershipService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._pointsService,
    <span class="hljs-keyword">this</span>._notificationService,
  );
  
  <span class="hljs-comment">// 获取用户会员信息</span>
  Future&lt;Result&lt;MembershipInfo&gt;&gt; getUserMembership(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> membershipInfo = <span class="hljs-keyword">await</span> _repository.getUserMembership(userId);
      <span class="hljs-keyword">return</span> Right(membershipInfo);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MembershipFailure.loadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 升级会员等级</span>
  Future&lt;Result&lt;<span class="hljs-keyword">void</span>&gt;&gt; upgradeMembership({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> MembershipTier targetTier,
    <span class="hljs-keyword">required</span> PaymentMethod paymentMethod,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> currentMembership = <span class="hljs-keyword">await</span> getUserMembership(userId);
      <span class="hljs-keyword">return</span> currentMembership.fold(
        (failure) =&gt; Left(failure),
        (membership) <span class="hljs-keyword">async</span> {
          <span class="hljs-comment">// 检查升级条件</span>
          <span class="hljs-keyword">if</span> (!_canUpgrade(membership.tier, targetTier)) {
            <span class="hljs-keyword">return</span> Left(MembershipFailure.upgradeNotAllowed());
          }
          
          <span class="hljs-comment">// 处理支付</span>
          <span class="hljs-keyword">final</span> upgradeResult = <span class="hljs-keyword">await</span> _processUpgradePayment(
            userId,
            targetTier,
            paymentMethod,
          );
          
          <span class="hljs-keyword">if</span> (upgradeResult.isLeft()) {
            <span class="hljs-keyword">return</span> Left(MembershipFailure.paymentFailed());
          }
          
          <span class="hljs-comment">// 更新会员等级</span>
          <span class="hljs-keyword">await</span> _repository.updateMembershipTier(userId, targetTier);
          
          <span class="hljs-comment">// 发送升级通知</span>
          <span class="hljs-keyword">await</span> _notificationService.sendMembershipUpgradeNotification(
            userId: userId,
            newTier: targetTier,
          );
          
          <span class="hljs-keyword">return</span> Right(unit);
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(MembershipFailure.upgradeFailed(e.toString()));
    }
  }
}
</code></pre>
<h3 id="2-积分系统">2. 积分系统</h3>
<h4 id="积分管理服务">积分管理服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 积分系统服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsService</span> </span>{
  <span class="hljs-keyword">final</span> PointsRepository _repository;
  <span class="hljs-keyword">final</span> MembershipService _membershipService;
  
  PointsService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._membershipService);
  
  <span class="hljs-comment">// 获取用户积分余额</span>
  Future&lt;Result&lt;PointsBalance&gt;&gt; getUserPoints(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> balance = <span class="hljs-keyword">await</span> _repository.getPointsBalance(userId);
      <span class="hljs-keyword">return</span> Right(balance);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PointsFailure.loadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 赚取积分</span>
  Future&lt;Result&lt;PointsTransaction&gt;&gt; earnPoints({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> points,
    <span class="hljs-keyword">required</span> PointsEarnReason reason,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> transaction = PointsTransaction(
        id: generateId(),
        userId: userId,
        type: PointsTransactionType.earn,
        points: points,
        reason: reason.toString(),
        metadata: metadata,
        createdAt: <span class="hljs-built_in">DateTime</span>.now(),
      );
      
      <span class="hljs-keyword">await</span> _repository.addPointsTransaction(transaction);
      <span class="hljs-keyword">await</span> _repository.updatePointsBalance(userId, points);
      
      <span class="hljs-comment">// 检查是否触发会员等级升级</span>
      <span class="hljs-keyword">await</span> _checkMembershipUpgrade(userId);
      
      <span class="hljs-keyword">return</span> Right(transaction);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PointsFailure.earnFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 消费积分</span>
  Future&lt;Result&lt;PointsTransaction&gt;&gt; spendPoints({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> points,
    <span class="hljs-keyword">required</span> PointsSpendReason reason,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查积分余额</span>
      <span class="hljs-keyword">final</span> balanceResult = <span class="hljs-keyword">await</span> getUserPoints(userId);
      <span class="hljs-keyword">return</span> balanceResult.fold(
        (failure) =&gt; Left(failure),
        (balance) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">if</span> (balance.availablePoints &lt; points) {
            <span class="hljs-keyword">return</span> Left(PointsFailure.insufficientPoints());
          }
          
          <span class="hljs-keyword">final</span> transaction = PointsTransaction(
            id: generateId(),
            userId: userId,
            type: PointsTransactionType.spend,
            points: -points,
            reason: reason.toString(),
            metadata: metadata,
            createdAt: <span class="hljs-built_in">DateTime</span>.now(),
          );
          
          <span class="hljs-keyword">await</span> _repository.addPointsTransaction(transaction);
          <span class="hljs-keyword">await</span> _repository.updatePointsBalance(userId, -points);
          
          <span class="hljs-keyword">return</span> Right(transaction);
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PointsFailure.spendFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取积分历史记录</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;PointsTransaction&gt;&gt;&gt; getPointsHistory({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
    PointsTransactionType? type,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> transactions = <span class="hljs-keyword">await</span> _repository.getPointsTransactions(
        userId: userId,
        page: page,
        pageSize: pageSize,
        type: type,
      );
      <span class="hljs-keyword">return</span> Right(transactions);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(PointsFailure.historyLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 积分数据模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsBalance</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> totalEarned;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> totalSpent;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> availablePoints;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> pendingPoints;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> lastUpdated;
  
  <span class="hljs-keyword">const</span> PointsBalance({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalEarned,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.totalSpent,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.availablePoints,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pendingPoints,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.lastUpdated,
  });
  
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> lifetimePoints =&gt; totalEarned;
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> spendingRate =&gt; totalEarned &gt; <span class="hljs-number">0</span> ? totalSpent / totalEarned : <span class="hljs-number">0.0</span>;
}

<span class="hljs-comment">// 积分交易记录</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsTransaction</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> userId;
  <span class="hljs-keyword">final</span> PointsTransactionType type;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> points;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> reason;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  <span class="hljs-keyword">final</span> PointsTransactionStatus status;
  
  <span class="hljs-keyword">const</span> PointsTransaction({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.points,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.reason,
    <span class="hljs-keyword">this</span>.metadata,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.createdAt,
    <span class="hljs-keyword">this</span>.status = PointsTransactionStatus.completed,
  });
}
</code></pre>
<h3 id="3-会员权益管理">3. 会员权益管理</h3>
<h4 id="权益服务系统">权益服务系统</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 会员权益服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MemberBenefitsService</span> </span>{
  <span class="hljs-keyword">final</span> BenefitsRepository _repository;
  <span class="hljs-keyword">final</span> MembershipService _membershipService;
  
  MemberBenefitsService(<span class="hljs-keyword">this</span>._repository, <span class="hljs-keyword">this</span>._membershipService);
  
  <span class="hljs-comment">// 获取用户可用权益</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;MemberBenefit&gt;&gt;&gt; getUserBenefits(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> membership = <span class="hljs-keyword">await</span> _membershipService.getUserMembership(userId);
      <span class="hljs-keyword">return</span> membership.fold(
        (failure) =&gt; Left(BenefitsFailure.membershipNotFound()),
        (membershipInfo) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">final</span> benefits = <span class="hljs-keyword">await</span> _repository.getBenefitsForTier(
            membershipInfo.tier,
          );
          <span class="hljs-keyword">return</span> Right(benefits);
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(BenefitsFailure.loadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 使用权益</span>
  Future&lt;Result&lt;BenefitUsage&gt;&gt; useBenefit({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> benefitId,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? context,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查权益可用性</span>
      <span class="hljs-keyword">final</span> benefit = <span class="hljs-keyword">await</span> _repository.getBenefitById(benefitId);
      <span class="hljs-keyword">if</span> (benefit == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(BenefitsFailure.benefitNotFound());
      }
      
      <span class="hljs-comment">// 检查使用条件</span>
      <span class="hljs-keyword">final</span> canUseResult = <span class="hljs-keyword">await</span> _canUseBenefit(userId, benefit);
      <span class="hljs-keyword">if</span> (canUseResult.isLeft()) {
        <span class="hljs-keyword">return</span> Left(canUseResult.fold((l) =&gt; l, (r) =&gt; <span class="hljs-keyword">throw</span> Exception()));
      }
      
      <span class="hljs-comment">// 记录使用</span>
      <span class="hljs-keyword">final</span> usage = BenefitUsage(
        id: generateId(),
        userId: userId,
        benefitId: benefitId,
        usedAt: <span class="hljs-built_in">DateTime</span>.now(),
        context: context,
      );
      
      <span class="hljs-keyword">await</span> _repository.recordBenefitUsage(usage);
      
      <span class="hljs-comment">// 执行权益逻辑</span>
      <span class="hljs-keyword">await</span> _executeBenefitLogic(benefit, usage);
      
      <span class="hljs-keyword">return</span> Right(usage);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(BenefitsFailure.usageFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取权益使用历史</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;BenefitUsage&gt;&gt;&gt; getBenefitUsageHistory({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-built_in">String?</span> benefitId,
    DateRange? dateRange,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> usageHistory = <span class="hljs-keyword">await</span> _repository.getBenefitUsageHistory(
        userId: userId,
        benefitId: benefitId,
        dateRange: dateRange,
        page: page,
        pageSize: pageSize,
      );
      <span class="hljs-keyword">return</span> Right(usageHistory);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(BenefitsFailure.historyLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 会员权益模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MemberBenefit</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> BenefitType type;
  <span class="hljs-keyword">final</span> BenefitCategory category;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; configuration;
  <span class="hljs-keyword">final</span> UsageLimit usageLimit;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;MembershipTier&gt; eligibleTiers;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> validFrom;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> validUntil;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isActive;
  
  <span class="hljs-keyword">const</span> MemberBenefit({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.category,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.configuration,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.usageLimit,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.eligibleTiers,
    <span class="hljs-keyword">this</span>.validFrom,
    <span class="hljs-keyword">this</span>.validUntil,
    <span class="hljs-keyword">this</span>.isActive = <span class="hljs-keyword">true</span>,
  });
  
  <span class="hljs-comment">// 免费充电权益</span>
  <span class="hljs-keyword">factory</span> MemberBenefit.freeCharging({<span class="hljs-built_in">int</span> times = <span class="hljs-number">1</span>}) {
    <span class="hljs-keyword">return</span> MemberBenefit(
      id: <span class="hljs-string">&#x27;free_charging&#x27;</span>,
      name: <span class="hljs-string">&#x27;免费充电&#x27;</span>,
      description: <span class="hljs-string">&#x27;每月享受 <span class="hljs-subst">$times</span> 次免费充电服务&#x27;</span>,
      type: BenefitType.service,
      category: BenefitCategory.charging,
      configuration: {<span class="hljs-string">&#x27;free_times&#x27;</span>: times},
      usageLimit: UsageLimit.monthly(times),
      eligibleTiers: [
        MembershipTier.gold,
        MembershipTier.platinum,
        MembershipTier.diamond,
        MembershipTier.vip,
      ],
    );
  }
  
  <span class="hljs-comment">// 优先客服权益</span>
  <span class="hljs-keyword">factory</span> MemberBenefit.prioritySupport() {
    <span class="hljs-keyword">return</span> MemberBenefit(
      id: <span class="hljs-string">&#x27;priority_support&#x27;</span>,
      name: <span class="hljs-string">&#x27;优先客服&#x27;</span>,
      description: <span class="hljs-string">&#x27;享受7x24小时优先客服支持&#x27;</span>,
      type: BenefitType.service,
      category: BenefitCategory.support,
      configuration: {<span class="hljs-string">&#x27;priority_level&#x27;</span>: <span class="hljs-string">&#x27;high&#x27;</span>},
      usageLimit: UsageLimit.unlimited(),
      eligibleTiers: [
        MembershipTier.gold,
        MembershipTier.platinum,
        MembershipTier.diamond,
        MembershipTier.vip,
      ],
    );
  }
}
</code></pre>
<h3 id="4-会员商城">4. 会员商城</h3>
<h4 id="积分商城服务">积分商城服务</h4>
<pre><code class="language-dart"><span class="hljs-comment">// 积分商城服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipStoreService</span> </span>{
  <span class="hljs-keyword">final</span> StoreRepository _repository;
  <span class="hljs-keyword">final</span> PointsService _pointsService;
  <span class="hljs-keyword">final</span> OrderService _orderService;
  
  MembershipStoreService(
    <span class="hljs-keyword">this</span>._repository,
    <span class="hljs-keyword">this</span>._pointsService,
    <span class="hljs-keyword">this</span>._orderService,
  );
  
  <span class="hljs-comment">// 获取商品列表</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;StoreItem&gt;&gt;&gt; getStoreItems({
    StoreCategory? category,
    MembershipTier? minTier,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> items = <span class="hljs-keyword">await</span> _repository.getStoreItems(
        category: category,
        minTier: minTier,
        page: page,
        pageSize: pageSize,
      );
      <span class="hljs-keyword">return</span> Right(items);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(StoreFailure.loadFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 兑换商品</span>
  Future&lt;Result&lt;StoreOrder&gt;&gt; redeemItem({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> itemId,
    <span class="hljs-built_in">int</span> quantity = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">String?</span> deliveryAddress,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取商品信息</span>
      <span class="hljs-keyword">final</span> item = <span class="hljs-keyword">await</span> _repository.getStoreItemById(itemId);
      <span class="hljs-keyword">if</span> (item == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span> Left(StoreFailure.itemNotFound());
      }
      
      <span class="hljs-comment">// 检查积分余额</span>
      <span class="hljs-keyword">final</span> totalCost = item.pointsPrice * quantity;
      <span class="hljs-keyword">final</span> pointsResult = <span class="hljs-keyword">await</span> _pointsService.getUserPoints(userId);
      
      <span class="hljs-keyword">return</span> pointsResult.fold(
        (failure) =&gt; Left(StoreFailure.pointsCheckFailed()),
        (balance) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">if</span> (balance.availablePoints &lt; totalCost) {
            <span class="hljs-keyword">return</span> Left(StoreFailure.insufficientPoints());
          }
          
          <span class="hljs-comment">// 检查库存</span>
          <span class="hljs-keyword">if</span> (item.stock != <span class="hljs-keyword">null</span> &amp;&amp; item.stock! &lt; quantity) {
            <span class="hljs-keyword">return</span> Left(StoreFailure.insufficientStock());
          }
          
          <span class="hljs-comment">// 创建订单</span>
          <span class="hljs-keyword">final</span> order = StoreOrder(
            id: generateId(),
            userId: userId,
            itemId: itemId,
            itemName: item.name,
            quantity: quantity,
            pointsPrice: item.pointsPrice,
            totalPoints: totalCost,
            deliveryAddress: deliveryAddress,
            status: StoreOrderStatus.pending,
            createdAt: <span class="hljs-built_in">DateTime</span>.now(),
          );
          
          <span class="hljs-comment">// 扣除积分</span>
          <span class="hljs-keyword">await</span> _pointsService.spendPoints(
            userId: userId,
            points: totalCost,
            reason: PointsSpendReason.storeRedemption,
            metadata: {<span class="hljs-string">&#x27;order_id&#x27;</span>: order.id, <span class="hljs-string">&#x27;item_id&#x27;</span>: itemId},
          );
          
          <span class="hljs-comment">// 保存订单</span>
          <span class="hljs-keyword">await</span> _repository.createStoreOrder(order);
          
          <span class="hljs-comment">// 更新库存</span>
          <span class="hljs-keyword">if</span> (item.stock != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">await</span> _repository.updateItemStock(itemId, -quantity);
          }
          
          <span class="hljs-keyword">return</span> Right(order);
        },
      );
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(StoreFailure.redeemFailed(e.toString()));
    }
  }
  
  <span class="hljs-comment">// 获取兑换记录</span>
  Future&lt;Result&lt;<span class="hljs-built_in">List</span>&lt;StoreOrder&gt;&gt;&gt; getRedemptionHistory({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> userId,
    StoreOrderStatus? status,
    <span class="hljs-built_in">int</span> page = <span class="hljs-number">1</span>,
    <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">20</span>,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> orders = <span class="hljs-keyword">await</span> _repository.getStoreOrders(
        userId: userId,
        status: status,
        page: page,
        pageSize: pageSize,
      );
      <span class="hljs-keyword">return</span> Right(orders);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> Left(StoreFailure.historyLoadFailed(e.toString()));
    }
  }
}

<span class="hljs-comment">// 商城商品模型</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StoreItem</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> description;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> imageUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> pointsPrice;
  <span class="hljs-keyword">final</span> StoreCategory category;
  <span class="hljs-keyword">final</span> MembershipTier? requiredTier;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> stock;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isVirtual;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? metadata;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime?</span> validUntil;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isActive;
  
  <span class="hljs-keyword">const</span> StoreItem({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.description,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.imageUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.pointsPrice,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.category,
    <span class="hljs-keyword">this</span>.requiredTier,
    <span class="hljs-keyword">this</span>.stock,
    <span class="hljs-keyword">this</span>.isVirtual = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">this</span>.metadata,
    <span class="hljs-keyword">this</span>.validUntil,
    <span class="hljs-keyword">this</span>.isActive = <span class="hljs-keyword">true</span>,
  });
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isInStock =&gt; stock == <span class="hljs-keyword">null</span> || stock! &gt; <span class="hljs-number">0</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isExpired =&gt; validUntil != <span class="hljs-keyword">null</span> &amp;&amp; validUntil!.isBefore(<span class="hljs-built_in">DateTime</span>.now());
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isAvailable =&gt; isActive &amp;&amp; isInStock &amp;&amp; !isExpired;
}
</code></pre>
<h2 id="页面组件设计">页面组件设计</h2>
<h3 id="会员主页">会员主页</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 会员主页</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MembershipHomePageState createState() =&gt; _MembershipHomePageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MembershipHomePageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MembershipHomePage</span>&gt; </span>{
  <span class="hljs-keyword">late</span> MembershipBloc _membershipBloc;
  <span class="hljs-keyword">late</span> PointsBloc _pointsBloc;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _membershipBloc = context.read&lt;MembershipBloc&gt;();
    _pointsBloc = context.read&lt;PointsBloc&gt;();
    
    _membershipBloc.add(LoadMembershipInfo());
    _pointsBloc.add(LoadPointsBalance());
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: CustomScrollView(
        slivers: [
          _buildAppBar(),
          SliverToBoxAdapter(child: _buildMembershipCard()),
          SliverToBoxAdapter(child: _buildPointsSection()),
          SliverToBoxAdapter(child: _buildBenefitsSection()),
          SliverToBoxAdapter(child: _buildQuickActions()),
          SliverToBoxAdapter(child: _buildPromotions()),
        ],
      ),
    );
  }
  
  Widget _buildMembershipCard() {
    <span class="hljs-keyword">return</span> BlocBuilder&lt;MembershipBloc, MembershipState&gt;(
      builder: (context, state) {
        <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> MembershipLoaded) {
          <span class="hljs-keyword">return</span> MembershipCard(
            membershipInfo: state.membershipInfo,
            onUpgrade: () =&gt; _navigateToUpgrade(),
          );
        }
        <span class="hljs-keyword">return</span> MembershipCardSkeleton();
      },
    );
  }
  
  Widget _buildPointsSection() {
    <span class="hljs-keyword">return</span> BlocBuilder&lt;PointsBloc, PointsState&gt;(
      builder: (context, state) {
        <span class="hljs-keyword">if</span> (state <span class="hljs-keyword">is</span> PointsLoaded) {
          <span class="hljs-keyword">return</span> PointsOverviewCard(
            balance: state.balance,
            onViewHistory: () =&gt; _navigateToPointsHistory(),
            onEarnMore: () =&gt; _navigateToEarnPoints(),
          );
        }
        <span class="hljs-keyword">return</span> PointsCardSkeleton();
      },
    );
  }
}
</code></pre>
<h3 id="会员卡片组件">会员卡片组件</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 会员卡片组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> MembershipInfo membershipInfo;
  <span class="hljs-keyword">final</span> VoidCallback? onUpgrade;
  
  <span class="hljs-keyword">const</span> MembershipCard({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.membershipInfo,
    <span class="hljs-keyword">this</span>.onUpgrade,
  }) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      margin: EdgeInsets.all(<span class="hljs-number">16</span>),
      padding: EdgeInsets.all(<span class="hljs-number">20</span>),
      decoration: BoxDecoration(
        gradient: _getGradientForTier(membershipInfo.tier),
        borderRadius: BorderRadius.circular(<span class="hljs-number">16</span>),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(<span class="hljs-number">0.1</span>),
            blurRadius: <span class="hljs-number">10</span>,
            offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildHeader(),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildProgress(),
          SizedBox(height: <span class="hljs-number">16</span>),
          _buildActions(),
        ],
      ),
    );
  }
  
  Widget _buildHeader() {
    <span class="hljs-keyword">return</span> Row(
      children: [
        CircleAvatar(
          radius: <span class="hljs-number">24</span>,
          backgroundColor: Colors.white.withOpacity(<span class="hljs-number">0.2</span>),
          child: Icon(
            _getIconForTier(membershipInfo.tier),
            color: Colors.white,
            size: <span class="hljs-number">28</span>,
          ),
        ),
        SizedBox(width: <span class="hljs-number">12</span>),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                membershipInfo.tierName,
                style: TextStyle(
                  fontSize: <span class="hljs-number">20</span>,
                  fontWeight: FontWeight.bold,
                  color: Colors.white,
                ),
              ),
              Text(
                <span class="hljs-string">&#x27;会员编号: <span class="hljs-subst">${membershipInfo.memberNumber}</span>&#x27;</span>,
                style: TextStyle(
                  fontSize: <span class="hljs-number">14</span>,
                  color: Colors.white.withOpacity(<span class="hljs-number">0.8</span>),
                ),
              ),
            ],
          ),
        ),
        <span class="hljs-keyword">if</span> (membershipInfo.tier != MembershipTier.vip)
          TextButton(
            onPressed: onUpgrade,
            child: Text(
              <span class="hljs-string">&#x27;升级&#x27;</span>,
              style: TextStyle(color: Colors.white),
            ),
            style: TextButton.styleFrom(
              backgroundColor: Colors.white.withOpacity(<span class="hljs-number">0.2</span>),
            ),
          ),
      ],
    );
  }
  
  Widget _buildProgress() {
    <span class="hljs-keyword">if</span> (membershipInfo.tier == MembershipTier.vip) {
      <span class="hljs-keyword">return</span> Container(); <span class="hljs-comment">// VIP 不显示进度</span>
    }
    
    <span class="hljs-keyword">final</span> nextTier = _getNextTier(membershipInfo.tier);
    <span class="hljs-keyword">final</span> currentPoints = membershipInfo.totalPoints;
    <span class="hljs-keyword">final</span> requiredPoints = _getRequiredPointsForTier(nextTier);
    <span class="hljs-keyword">final</span> progress = currentPoints / requiredPoints;
    
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">&#x27;距离<span class="hljs-subst">${_getTierName(nextTier)}</span>还需 <span class="hljs-subst">${requiredPoints - currentPoints}</span> 积分&#x27;</span>,
          style: TextStyle(
            color: Colors.white.withOpacity(<span class="hljs-number">0.9</span>),
            fontSize: <span class="hljs-number">14</span>,
          ),
        ),
        SizedBox(height: <span class="hljs-number">8</span>),
        LinearProgressIndicator(
          value: progress.clamp(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>),
          backgroundColor: Colors.white.withOpacity(<span class="hljs-number">0.3</span>),
          valueColor: AlwaysStoppedAnimation&lt;Color&gt;(Colors.white),
        ),
      ],
    );
  }
}
</code></pre>
<h2 id="状态管理">状态管理</h2>
<h3 id="会员状态管理">会员状态管理</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 会员状态 BLoC</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipBloc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bloc</span>&lt;<span class="hljs-title">MembershipEvent</span>, <span class="hljs-title">MembershipState</span>&gt; </span>{
  <span class="hljs-keyword">final</span> MembershipService _membershipService;
  <span class="hljs-keyword">final</span> PointsService _pointsService;
  
  MembershipBloc(<span class="hljs-keyword">this</span>._membershipService, <span class="hljs-keyword">this</span>._pointsService) 
      : <span class="hljs-keyword">super</span>(MembershipInitial()) {
    <span class="hljs-keyword">on</span>&lt;LoadMembershipInfo&gt;(_onLoadMembershipInfo);
    <span class="hljs-keyword">on</span>&lt;UpgradeMembership&gt;(_onUpgradeMembership);
    <span class="hljs-keyword">on</span>&lt;RefreshMembershipInfo&gt;(_onRefreshMembershipInfo);
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onLoadMembershipInfo(
    LoadMembershipInfo event,
    Emitter&lt;MembershipState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(MembershipLoading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _membershipService.getUserMembership(event.userId);
    result.fold(
      (failure) =&gt; emit(MembershipError(failure.message)),
      (membershipInfo) =&gt; emit(MembershipLoaded(membershipInfo)),
    );
  }
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _onUpgradeMembership(
    UpgradeMembership event,
    Emitter&lt;MembershipState&gt; emit,
  ) <span class="hljs-keyword">async</span> {
    emit(MembershipUpgrading());
    
    <span class="hljs-keyword">final</span> result = <span class="hljs-keyword">await</span> _membershipService.upgradeMembership(
      userId: event.userId,
      targetTier: event.targetTier,
      paymentMethod: event.paymentMethod,
    );
    
    result.fold(
      (failure) =&gt; emit(MembershipError(failure.message)),
      (_) {
        add(LoadMembershipInfo(event.userId));
        emit(MembershipUpgradeSuccess());
      },
    );
  }
}
</code></pre>
<h2 id="与其他模块集成">与其他模块集成</h2>
<h3 id="社区集成">社区集成</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 会员社区权益服务</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipCommunityIntegration</span> </span>{
  <span class="hljs-keyword">final</span> MembershipService _membershipService;
  <span class="hljs-keyword">final</span> CommunityService _communityService;
  
  MembershipCommunityIntegration(
    <span class="hljs-keyword">this</span>._membershipService,
    <span class="hljs-keyword">this</span>._communityService,
  );
  
  <span class="hljs-comment">// 检查发布权限</span>
  Future&lt;<span class="hljs-built_in">bool</span>&gt; canPublishPremiumContent(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> membership = <span class="hljs-keyword">await</span> _membershipService.getUserMembership(userId);
    <span class="hljs-keyword">return</span> membership.fold(
      (_) =&gt; <span class="hljs-keyword">false</span>,
      (info) =&gt; info.tier.index &gt;= MembershipTier.gold.index,
    );
  }
  
  <span class="hljs-comment">// 获取会员专属话题</span>
  Future&lt;<span class="hljs-built_in">List</span>&lt;Topic&gt;&gt; getMemberExclusiveTopics(<span class="hljs-built_in">String</span> userId) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> membership = <span class="hljs-keyword">await</span> _membershipService.getUserMembership(userId);
    <span class="hljs-keyword">return</span> membership.fold(
      (_) =&gt; [],
      (info) =&gt; _communityService.getTopicsForMemberTier(info.tier),
    );
  }
}
</code></pre>
<h2 id="依赖管理">依赖管理</h2>
<h3 id="集成模块依赖">集成模块依赖</h3>
<ul>
<li><strong>basic_utils</strong>: 基础工具类</li>
<li><strong>basic_uis</strong>: 基础 UI 组件</li>
<li><strong>oneapp_community</strong>: 社区功能集成</li>
<li><strong>oneapp_after_sales</strong>: 售后服务集成</li>
<li><strong>app_account</strong>: 账户系统集成</li>
</ul>
<h3 id="第三方依赖">第三方依赖</h3>
<ul>
<li><strong>fluwx</strong>: 微信支付集成（会员升级付费）</li>
</ul>
<h2 id="错误处理">错误处理</h2>
<h3 id="会员系统异常">会员系统异常</h3>
<pre><code class="language-dart"><span class="hljs-comment">// 会员系统异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MembershipFailure</span> </span>{
  <span class="hljs-keyword">const</span> MembershipFailure();
  
  <span class="hljs-keyword">factory</span> MembershipFailure.loadFailed(<span class="hljs-built_in">String</span> message) = LoadFailure;
  <span class="hljs-keyword">factory</span> MembershipFailure.upgradeFailed(<span class="hljs-built_in">String</span> message) = UpgradeFailure;
  <span class="hljs-keyword">factory</span> MembershipFailure.paymentFailed() = PaymentFailure;
  <span class="hljs-keyword">factory</span> MembershipFailure.upgradeNotAllowed() = UpgradeNotAllowedFailure;
  <span class="hljs-keyword">factory</span> MembershipFailure.insufficientPoints() = InsufficientPointsFailure;
}

<span class="hljs-comment">// 积分系统异常</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointsFailure</span> </span>{
  <span class="hljs-keyword">const</span> PointsFailure();
  
  <span class="hljs-keyword">factory</span> PointsFailure.insufficientPoints() = InsufficientPointsFailure;
  <span class="hljs-keyword">factory</span> PointsFailure.earnFailed(<span class="hljs-built_in">String</span> message) = EarnFailure;
  <span class="hljs-keyword">factory</span> PointsFailure.spendFailed(<span class="hljs-built_in">String</span> message) = SpendFailure;
}
</code></pre>
<h2 id="总结">总结</h2>
<p><code>oneapp_membership</code> 模块为 OneApp 构建了完整的会员生态体系，通过等级管理、积分系统、权益服务和商城功能，提升了用户粘性和付费转化。模块与社区、账户、售后服务等模块深度集成，为用户提供了全方位的会员体验和价值认知。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>